<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroLegend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root {
      --light-bg: #f6f6fa;
      --light-card: #fff;
      --light-text: #1a1a1a;
      --light-accent: #2b78e4;
      --gold: #fbe62c;
      --silver: #d9d9d9;
      --ring-bg: #241f14;
      --ring-txt: #d9d9d9;
      --ring-gold: #fbe62c;
      --ring-silver: #d9d9d9;
      --ring-shadow: 0 0 18px 6px #edb94144;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--light-bg);
      color: var(--light-text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      background: var(--light-card);
      box-shadow: 0 4px 32px #0002;
      border-radius: 22px;
      max-width: 500px;
      width: 96vw;
      margin: 3vw auto 9vw auto;
      padding: 2.2em 2em 2.5em 2em;
      position: relative;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 1.2em;
    }

    .theme-toggle {
      position: absolute;
      right: 32px; top: 25px;
      z-index: 2;
      display: flex;
      gap: 10px;
    }
    .theme-btn {
      background: var(--light-bg);
      border: none;
      border-radius: 15px;
      padding: 5px 18px;
      font-size: 1.13rem;
      color: var(--light-accent);
      font-weight: 700;
      cursor: pointer;
      margin-left: 0;
      box-shadow: 0 2px 7px #0001;
      transition: background 0.2s, color 0.2s;
    }
    .theme-btn.active, .theme-btn:focus {
      background: var(--gold);
      color: #3b2e08;
      outline: none;
    }

    h1 {
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 2.3rem;
      letter-spacing: 2px;
      margin-bottom: 0.8em;
      text-align: center;
      color: var(--light-accent);
      margin-top: 0.3em;
      transition: color 0.3s, text-shadow 0.3s;
      z-index: 1;
      position: relative;
    }
    .ringmode h1 {
      color: var(--ring-gold);
      text-shadow: 0 2px 16px #edb941bb;
    }

    .tab-row {
      display: flex;
      justify-content: center;
      gap: 1.2em;
      margin: 0 0 1.2em 0;
    }
    .tab-btn {
      font-weight: 700;
      padding: 0.68em 2em;
      border-radius: 12px 12px 0 0;
      border: none;
      background: #eceefe;
      color: #3a74c4;
      font-size: 1.18em;
      cursor: pointer;
      box-shadow: 0 1px 7px #0001;
      transition: background 0.2s, color 0.2s;
    }
    .tab-btn.active {
      background: var(--light-accent);
      color: #fff;
    }
    .ringmode .tab-btn {
      background: #2e2208;
      color: var(--ring-gold);
    }
    .ringmode .tab-btn.active { background: var(--ring-gold); color: #382a00; }

    .macro-input-row, .add-meal-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.1em;
      justify-content: center;
      margin-bottom: 1.5em;
      margin-top: 0.2em;
    }
    .macro-input, .meal-name-input, .meal-amt-input {
      flex: 1 1 40%;
      min-width: 120px;
      max-width: 175px;
      font-size: 1.16em;
      padding: 13px 15px;
      margin: 0.13em 0 0.13em 0;
      border-radius: 12px;
      border: 1.5px solid #b6c6e1;
      background: #f6faff;
      color: #262626;
      box-shadow: 0 2px 5px #b6d4fa11;
      outline: none;
      transition: border 0.15s;
    }
    .macro-input:focus, .meal-name-input:focus, .meal-amt-input:focus {
      border: 1.5px solid #2b78e4;
    }

    .add-meal-btn, .scan-btn {
      background: #2b78e4;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      padding: 13px 28px;
      font-size: 1em;
      cursor: pointer;
      margin-left: 4px;
      margin-bottom: 3px;
      box-shadow: 0 2px 6px #0002;
      transition: background 0.16s, color 0.16s;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .add-meal-btn:hover, .add-meal-btn:focus,
    .scan-btn:hover, .scan-btn:focus { background: #49a858; color: #fff;}
    .scan-btn { background: #fbe62c; color: #382a00; font-weight: 800; padding: 13px 13px;}
    .scan-btn svg {width:1.4em;height:1.4em;vertical-align:middle;}

    /* Streak ring area */
    .streak-ring-wrap {
      margin: 2.3em auto 0 auto;
      width: 160px; height: 160px;
      display: flex; align-items: center; justify-content: center;
      position: relative; transition: filter 0.3s;
    }
    .streak-ring-svg {
      width: 100%; height: 100%; display: block;
      filter: drop-shadow(var(--ring-shadow));
    }
    .streak-center-label {
      position: absolute; left: 50%; top: 52%;
      transform: translate(-50%,-50%);
      width: 106px; text-align: center;
      color: var(--ring-gold);
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 1.3em; line-height: 1.16;
      font-weight: 700;
      text-shadow: 0 0 13px #edb941b9, 0 1px 3px #000a;
      pointer-events: none;
      letter-spacing: 0.5px;
    }
    .streak-week-phrase {
      position: absolute; left: 50%; top: 91%;
      transform: translate(-50%,0);
      font-family: 'Ringbearer','Inter',serif;
      color: var(--gold);
      font-size: 1.04em; text-align: center;
      width: 150px;
      text-shadow: 0 0 10px #edb94199, 0 2px 8px #000a;
      pointer-events: none;
      letter-spacing: 0.2px;
      filter: brightness(1.05) blur(0.1px);
    }

    .goal-line {
      font-size: 1.13em;
      color: #494949;
      background: #f6f6fa;
      border-radius: 10px;
      margin: 0 auto 1.4em auto;
      text-align: center;
      padding: 0.38em 1.1em;
      font-weight: 500;
      letter-spacing: 0.7px;
      display: flex;
      justify-content: center;
      gap: 2em;
      flex-wrap: wrap;
      max-width: 99vw;
      white-space: nowrap;
    }
    .goal-line span { font-weight: 700; letter-spacing: 0.3px; padding: 0 4px; }
    .goal-macro-p { color: #49a858; }
    .goal-macro-c { color: #3677c6; }
    .goal-macro-f { color: #e8a200; }
    .goal-macro-cal { color: #d4b117; }

    /* Meal log table - Ring Mode Colors! */
    .meal-log-table {
      width: 100%;
      margin-bottom: 1.2em;
      border-collapse: collapse;
      font-size: 1.11em;
      background: transparent;
      border-radius: 12px;
      overflow-x: auto;
      box-shadow: none;
    }
    .meal-log-table th, .meal-log-table td {
      padding: 12px 10px;
      border: none;
      text-align: center;
      white-space: nowrap;
      font-size: 1em;
      font-family: 'Inter', serif;
    }
    .meal-log-table th {
      background: #554014;
      color: var(--gold);
      font-family: 'Ringbearer', 'Inter', serif;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .meal-log-table td {
      background: rgba(60,54,25,0.83);
      color: var(--silver);
      border-bottom: 1px solid #32280c;
    }
    .meal-log-table tbody tr:nth-child(even) td {
      background: rgba(110,90,45,0.52);
    }
    .remove-btn {
      background: transparent;
      border: none;
      color: #f95c45;
      font-size: 1.23em;
      cursor: pointer;
      font-weight: bold;
      transition: color 0.2s;
    }
    .remove-btn:hover { color: #e31818; }

    .export-row {
      display: flex;
      gap: 1em;
      justify-content: flex-end;
      margin-bottom: 1.1em;
      margin-top: 0.4em;
    }
    .export-btn {
      background: #342b13;
      color: var(--gold);
      font-size: 1.08em;
      padding: 10px 28px;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      margin: 0;
      box-shadow: 0 1px 5px #0003;
      transition: background 0.18s, color 0.18s;
      font-family: 'Ringbearer', 'Inter', serif;
    }
    .export-btn:hover, .export-btn:focus { background: #51410e; color: #fff;}

    /* Quotes in Light Mode */
    #quoteRow {
      margin: 2.2em auto 0.5em auto;
      text-align: center;
      font-family: 'Inter', serif;
      font-size: 1.1em;
      color: #3a74c4;
      font-weight: 600;
      letter-spacing: 0.2px;
      max-width: 99vw;
    }
    .ringmode #quoteRow { display: none; }
    /* Texture Background for Ring Mode */
    body.ringmode {
      background: #241f14 !important;
      background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'),
                        url('https://cdn.pixabay.com/photo/2018/01/15/07/51/middle-earth-3081751_1280.jpg');
      background-size: auto, cover;
      background-repeat: repeat, no-repeat;
      background-position: top left, center top;
      color: var(--ring-txt) !important;
    }
    .ringmode .container {
      background: rgba(44, 37, 18, 0.88) !important;
      color: var(--ring-txt) !important;
      box-shadow: 0 4px 44px #463300b0;
    }
    .ringmode .goal-line, .ringmode .macro-bar-label, .ringmode .meal-log-table th {
      background: #2e2208 !important;
      color: var(--gold) !important;
    }
    .ringmode .macro-bar-label { color: #fffbe6 !important;}
    .ringmode .export-btn { background: #322708; color: var(--gold);}
    .ringmode .export-btn:hover { background: #453b15; color: #fff;}
    .ringmode .add-meal-btn, .ringmode .scan-btn { background: var(--ring-gold); color: #382a00;}
    .ringmode .add-meal-btn:hover, .ringmode .scan-btn:hover { background: #fff; color: #a28907;}
    .ringmode .macro-input, .ringmode .meal-name-input, .ringmode .meal-amt-input {
      background: #342b13;
      color: var(--ring-gold);
      border: 1.5px solid #b49c24;
    }
    .ringmode .macro-input:focus, .ringmode .meal-name-input:focus, .ringmode .meal-amt-input:focus {
      border: 1.5px solid var(--gold);
    }
    /* Scrollable Table on Small Devices */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      margin: 0 auto 1.3em auto;
      border-radius: 10px;
    }

    /* MOBILE / SMALL SCREEN LAYOUT */
    @media (max-width: 600px) {
      .container {
        padding: 1.6em 3vw 2.5em 3vw;
        max-width: 99vw;
        border-radius: 15px;
      }
      .theme-toggle {
        position: static;
        justify-content: center;
        margin-bottom: 0.7em;
        margin-top: 0.2em;
        gap: 15px;
      }
      h1 {
        font-size: 1.3rem;
        margin-top: 0.1em;
        margin-bottom: 1.2em;
      }
      .streak-ring-wrap {
        width: 95vw;
        max-width: 170px;
        height: 95vw;
        margin-top: 2.3em;
      }
      .macro-input-row, .add-meal-row {
        gap: 0.5em;
        margin-bottom: 1.1em;
      }
      .macro-input, .meal-name-input, .meal-amt-input {
        min-width: 90px;
        max-width: 99vw;
        font-size: 1em;
        padding: 11px 7px;
      }
      .table-responsive { max-width: 99vw; }
      .meal-log-table th, .meal-log-table td { padding: 10px 6px; font-size: 0.97em;}
      .export-row { gap: 0.4em;}
    }
  </style>
</head>
<body>
  <div class="container" id="macroLegendContainer">
    <div class="theme-toggle">
      <button class="theme-btn active" id="appleLightBtn" onclick="setTheme('light')">Apple Light</button>
      <button class="theme-btn" id="ringModeBtn" onclick="setTheme('ring')">Ring Mode</button>
    </div>
    <h1>MacroLegend</h1>
    <div class="tab-row">
      <button class="tab-btn active" id="tabCalc" onclick="showTab('calc')">Macro Calculator</button>
      <button class="tab-btn" id="tabProg" onclick="showTab('prog')">Progression</button>
    </div>
    <div id="tabArea"></div>
    <audio id="streakSound" preload="auto">
      <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
    </audio>
    <video id="barcodeVideo" autoplay playsinline style="display:none"></video>
    <div id="barcodeOverlay" style="display:none"></div>
    <button id="barcodeCancelBtn" onclick="stopBarcodeScan()" style="display:none">Cancel Scan</button>
    <div id="quoteRow"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script>
    // ========== QUOTES ==========
    const lotrQuotes = [
      "Even the smallest person can change the course of the future.",
      "Not all those who wander are lost.",
      "The road goes ever on and on.",
      "Deeds will not be less valiant because they are unpraised.",
      "Faithless is he that says farewell when the road darkens.",
      "All we have to decide is what to do with the time that is given us.",
      "There’s some good in this world, and it’s worth fighting for.",
      "I am glad you are here with me. Here at the end of all things.",
      "The world is indeed full of peril, and in it there are many dark places.",
      "A wizard is never late, nor is he early, he arrives precisely when he means to.",
      "You shall not pass!",
      "Courage is found in unlikely places.",
      "The shadow is only a passing thing.",
      "Hope remains while the Company is true.",
      "The board is set, the pieces are moving.",
      "One does not simply walk into Mordor.",
      "I would rather share one lifetime with you than face all the ages of this world alone.",
      "May it be a light to you in dark places, when all other lights go out.",
      "It's a dangerous business, going out your door.",
      "The wise speak only of what they know.",
      "Many that live deserve death. And some that die deserve life.",
      "Even darkness must pass. A new day will come.",
      "The strength of the ring-bearer is in his heart.",
      "There’s always hope.",
      "For Frodo.",
      "The journey doesn’t end here.",
      "I am no man!",
      "The Ring has awoken.",
      "Speak, friend, and enter.",
      "There and back again.",
      "Let him not vow to walk in the dark, who has not seen the nightfall.",
      "Renewed shall be blade that was broken.",
      "I will take the Ring, though I do not know the way.",
      "A day may come when the courage of men fails… but it is not this day.",
      "My friends, you bow to no one.",
      "White shores, and beyond, a far green country under a swift sunrise.",
      "You have my sword.",
      "The Shire must truly be a great place.",
      "If by my life or death I can protect you, I will.",
      "End? No, the journey doesn't end here.",
      "Where there's life, there's hope.",
      "It’s the job that’s never started as takes longest to finish.",
      "But in the end, it’s only a passing thing, this shadow.",
      "I can't carry it for you, but I can carry you!",
      "The hands of a king are the hands of a healer.",
      "Shadowfax, show us the meaning of haste.",
      "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
      "Mithrandir, why did you leave us?",
      "You shall be the Fellowship of the Ring.",
      "I will not say: do not weep; for not all tears are an evil.",
      "The fire of your heart outshines the darkness.",
      "May your path be green and the breeze on your back.",
      "Streaks are for heroes. Today you are legend.",
      "Let the courage of the Eldar guide you.",
    ];
    const genericQuotes = [
      "Success is the sum of small efforts, repeated day in and day out.",
      "You don’t have to be extreme, just consistent.",
      "Discipline is choosing between what you want now and what you want most.",
      "Don’t limit your challenges. Challenge your limits.",
      "Progress, not perfection.",
      "A little progress each day adds up to big results.",
      "Push yourself, because no one else is going to do it for you.",
      "Doubt kills more dreams than failure ever will.",
      "Perseverance is not a long race; it’s many short races one after another.",
      "What you do today can improve all your tomorrows.",
      "Don’t watch the clock; do what it does. Keep going.",
      "Believe in yourself and all that you are.",
      "You don’t have to go fast. You just have to go.",
      "It always seems impossible until it’s done.",
      "Strength grows in the moments when you think you can’t go on but you keep going anyway.",
      "Dream big. Start small. Act now.",
      "Fall seven times, stand up eight.",
      "You are stronger than you think.",
      "Keep going. Everything you need will come to you.",
      "Stay patient and trust your journey.",
      "Small deeds done are better than great deeds planned.",
      "The only bad workout is the one you didn’t do.",
      "Progress is progress, no matter how small.",
      "If you’re tired, do it tired.",
      "Consistency is what transforms average into excellence.",
      "Your only limit is your mind.",
      "Little by little, a little becomes a lot.",
      "Great things never came from comfort zones.",
      "Winners are not people who never fail, but people who never quit.",
      "It’s going to be hard, but hard does not mean impossible.",
      "Make yourself proud.",
      "Every accomplishment starts with the decision to try.",
      "You are your only competition.",
      "Stop wishing. Start doing.",
      "Don’t stop when you’re tired. Stop when you’re done.",
      "The pain you feel today will be the strength you feel tomorrow.",
      "One day or day one. You decide.",
      "If it doesn’t challenge you, it won’t change you.",
      "If not now, when?",
      "Don’t wait for opportunity. Create it.",
      "The journey of a thousand miles begins with one step.",
      "Sore today, strong tomorrow.",
      "Difficult roads often lead to beautiful destinations.",
      "Motivation is what gets you started. Habit is what keeps you going.",
      "Be stronger than your excuses.",
      "Success doesn’t come from what you do occasionally. It comes from what you do consistently.",
      "It’s not about having time. It’s about making time.",
      "Never give up on a dream just because of the time it will take to accomplish it.",
      "The future depends on what you do today."
    ];
    // ========== STATE ==========
    let macroGoals = {calories: 2000, protein: 150, carbs: 200, fat: 70};
    let macroTotals = {calories: 0, protein: 0, carbs: 0, fat: 0};
    let mealLog = [];
    let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
    try {
      if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
      if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
      if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
    } catch (e) {}
    let currentTheme = 'light';
    // ========== THEME ==========
    function setTheme(theme) {
      const body = document.body;
      const cont = document.getElementById('macroLegendContainer');
      currentTheme = theme;
      if (theme === 'ring') {
        body.classList.add('ringmode');
        cont.classList.add('ringmode');
        document.getElementById('appleLightBtn').classList.remove('active');
        document.getElementById('ringModeBtn').classList.add('active');
        renderStreak();
        renderQuote();
      } else {
        body.classList.remove('ringmode');
        cont.classList.remove('ringmode');
        document.getElementById('appleLightBtn').classList.add('active');
        document.getElementById('ringModeBtn').classList.remove('active');
        renderStreak();
        renderQuote();
      }
    }
    setTheme(currentTheme);
    // ========== TAB SYSTEM ==========
    function showTab(tab) {
      document.getElementById('tabCalc').classList.remove('active');
      document.getElementById('tabProg').classList.remove('active');
      if (tab === 'calc') document.getElementById('tabCalc').classList.add('active');
      else document.getElementById('tabProg').classList.add('active');
      renderTab(tab);
    }
    function renderTab(tab) {
      if (tab === 'calc') renderCalculatorTab();
      else renderProgressionTab();
    }
    // ========== MACRO CALCULATOR TAB ==========
    function renderCalculatorTab() {
      document.getElementById('tabArea').innerHTML = `
      <form onsubmit="setGoalsFromInputs(event)" class="macro-input-row">
        <input class="macro-input" id="inputWeight" type="number" min="70" placeholder="Weight (lbs)">
        <input class="macro-input" id="inputHeight" type="number" min="48" placeholder="Height (in)">
        <input class="macro-input" id="inputAge" type="number" min="8" max="99" placeholder="Age">
        <select class="macro-input" id="inputGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <select class="macro-input" id="inputActivity">
          <option value="1.2">Sedentary</option>
          <option value="1.375">Light (1-3 days/wk)</option>
          <option value="1.55">Moderate (3-5 days/wk)</option>
          <option value="1.725">Active (6-7 days/wk)</option>
          <option value="1.9">Very Active</option>
        </select>
        <select class="macro-input" id="inputGoal">
          <option value="maintain">Maintain</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
        <button class="add-meal-btn" style="min-width:120px" type="submit">Set Macros</button>
      </form>
      <div style="color:#687; font-size:1.08em;text-align:center; margin-bottom:1.2em">
        Use the calculator to estimate daily calorie/macros.  
        <br><span style="color:#4275ba;font-weight:600;">Your settings transfer to Progression tab instantly.</span>
      </div>
      <div class="macro-input-row">
        <input class="macro-input" id="goalCalories" type="number" min="0" placeholder="Goal Calories">
        <input class="macro-input" id="goalProtein" type="number" min="0" placeholder="Goal Protein (g)">
        <input class="macro-input" id="goalCarbs" type="number" min="0" placeholder="Goal Carbs (g)">
        <input class="macro-input" id="goalFat" type="number" min="0" placeholder="Goal Fat (g)">
        <button class="add-meal-btn" style="min-width:110px" onclick="saveGoalInputs()" type="button">Update Goal</button>
      </div>
      `;
      document.getElementById('goalCalories').value = macroGoals.calories;
      document.getElementById('goalProtein').value = macroGoals.protein;
      document.getElementById('goalCarbs').value = macroGoals.carbs;
      document.getElementById('goalFat').value = macroGoals.fat;
    }
    function setGoalsFromInputs(e) {
      e.preventDefault();
      let w = Number(document.getElementById('inputWeight').value);
      let h = Number(document.getElementById('inputHeight').value);
      let a = Number(document.getElementById('inputAge').value);
      let g = document.getElementById('inputGender').value;
      let act = Number(document.getElementById('inputActivity').value);
      let goal = document.getElementById('inputGoal').value;
      if (!w || !h || !a) return showToast("Fill in all fields!");
      let bmr = (g==="male")
        ? 66 + (6.23 * w) + (12.7 * h) - (6.8 * a)
        : 655 + (4.35 * w) + (4.7 * h) - (4.7 * a);
      let tdee = bmr * act;
      let cal = tdee;
      if (goal === "lose") cal -= 500;
      if (goal === "gain") cal += 300;
      macroGoals.calories = Math.round(cal);
      macroGoals.protein = Math.round(w*0.8);
      macroGoals.carbs = Math.round((cal*0.45)/4);
      macroGoals.fat = Math.round((cal*0.25)/9);
      saveData(); renderAll();
      showToast("Goals updated!");
    }
    function saveGoalInputs() {
      macroGoals.calories = Number(document.getElementById('goalCalories').value)||0;
      macroGoals.protein = Number(document.getElementById('goalProtein').value)||0;
      macroGoals.carbs = Number(document.getElementById('goalCarbs').value)||0;
      macroGoals.fat = Number(document.getElementById('goalFat').value)||0;
      saveData(); renderAll();
      showToast("Macros saved!");
    }
    // ========== PROGRESSION TAB ==========
    function renderProgressionTab() {
      document.getElementById('tabArea').innerHTML = `
      <div class="goal-line" id="goalLine"></div>
      <form onsubmit="addMeal(event)" class="add-meal-row">
        <input class="meal-name-input" id="mealName" placeholder="Meal name/food" autocomplete="off" required>
        <input class="meal-amt-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
        <input class="meal-amt-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
        <input class="meal-amt-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
        <input class="meal-amt-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
        <button class="add-meal-btn" type="submit">+ Add</button>
        <button type="button" class="scan-btn" onclick="scanBarcode()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><rect x="16" y="16" width="5" height="5"/><path d="M9 5h6M19 9v6M5 9v6M9 19h6"/></svg>
        </button>
      </form>
      <div class="table-responsive"><table class="meal-log-table" id="mealLogTable"></table></div>
      <div class="export-row">
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="exportTXT()">Export TXT</button>
        <button class="export-btn" onclick="window.print()">Print / PDF</button>
      </div>
      <div id="streakArea"></div>
      `;
      renderGoalLine();
      renderMealLog();
      renderStreak();
    }
    // ========== MACRO PROGRESS ========== 
    function renderGoalLine() {
      const {calories, protein, carbs, fat} = macroGoals;
      document.getElementById('goalLine').innerHTML =
        `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
         <span class="goal-macro-p">P: <b>${protein}g</b></span>
         <span class="goal-macro-c">C: <b>${carbs}g</b></span>
         <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
    }
    // ========== MEAL LOG ========== 
    function addMeal(e) {
      e.preventDefault();
      const name = document.getElementById('mealName').value.trim();
      const calories = Number(document.getElementById('mealCalories').value);
      const protein = Number(document.getElementById('mealProtein').value) || 0;
      const carbs = Number(document.getElementById('mealCarbs').value) || 0;
      const fat = Number(document.getElementById('mealFat').value) || 0;
      if (!name || !calories) return showToast("Enter meal name and calories!");
      mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
      saveData();
      document.getElementById('mealName').value = '';
      document.getElementById('mealCalories').value = '';
      document.getElementById('mealProtein').value = '';
      document.getElementById('mealCarbs').value = '';
      document.getElementById('mealFat').value = '';
      renderAll();
      checkStreak();
      showToast("Meal added!");
    }
    function renderMealLog() {
      let rows = mealLog.map((m,i) =>
        `<tr>
          <td>${m.name}</td>
          <td>${m.calories}</td>
          <td>${m.protein}</td>
          <td>${m.carbs}</td>
          <td>${m.fat}</td>
          <td><button class="remove-btn" onclick="removeMeal(${i})" title="Remove">&times;</button></td>
        </tr>`
      ).join('');
      document.getElementById('mealLogTable').innerHTML = `
        <thead>
          <tr>
            <th>Meal</th>
            <th>Cal</th>
            <th>P</th>
            <th>C</th>
            <th>F</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }
    function removeMeal(idx) {
      mealLog.splice(idx,1);
      saveData();
      renderAll();
      showToast("Meal removed.");
    }
    // ========== MACRO TOTALS ==========
    function updateTotals() {
      macroTotals = {calories:0,protein:0,carbs:0,fat:0};
      mealLog.forEach(m=>{
        macroTotals.calories += Number(m.calories)||0;
        macroTotals.protein += Number(m.protein)||0;
        macroTotals.carbs += Number(m.carbs)||0;
        macroTotals.fat += Number(m.fat)||0;
      });
    }
    // ========== STREAK ==========
    function checkStreak() {
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10);
      if (streak.lastDate !== todayStr) {
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate()-1);
        const ystr = yesterday.toISOString().slice(0,10);
        if (streak.lastDate === ystr) {
          streak.days += 1;
          if (streak.days > streak.best) {
            streak.best = streak.days;
            playStreakSound();
          }
        } else {
          streak.days = 1;
        }
        streak.lastDate = todayStr;
        streak.weekPhrase = ((streak.days-1) % lotrQuotes.length);
        saveData();
        renderStreak();
      }
    }
    function renderStreak() {
      const streakArea = document.getElementById('streakArea');
      const isRing = document.body.classList.contains('ringmode');
      const phrase = lotrQuotes[streak.weekPhrase % lotrQuotes.length];
      if (isRing) {
        streakArea.innerHTML = `
        <div class="streak-ring-wrap">
          <svg class="streak-ring-svg" width="160" height="160" viewBox="0 0 140 140">
            <defs>
              <radialGradient id="gold" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#fff9c9"/>
                <stop offset="65%" stop-color="#edb941"/>
                <stop offset="100%" stop-color="#a28209"/>
              </radialGradient>
            </defs>
            <circle cx="70" cy="70" r="58" fill="url(#gold)" stroke="#d4b117" stroke-width="7"/>
            <text x="70" y="70" text-anchor="middle" fill="#bd8c19" font-family="Ringbearer, serif"
              font-size="13" font-weight="bold" dy="10" letter-spacing="2">
              ${toElvishInscription(streak.days)}
            </text>
          </svg>
          <div class="streak-center-label">
            Streak<br>
            <span style="font-size:1.65em;letter-spacing:2px;">${streak.days}</span>
            <br>Best: <b>${streak.best}</b>
          </div>
          <div class="streak-week-phrase">${phrase}</div>
        </div>
        `;
      } else {
        streakArea.innerHTML = `
          <div class="streak-ring-wrap" style="box-shadow:none;">
            <div style="margin:0 auto;text-align:center;">
              <span style="font-size:2em;font-weight:700;color:#3a74c4;">Streak: ${streak.days}</span>
              <br>
              <span style="font-size:1.12em;font-weight:600;color:#727272;">Best: ${streak.best}</span>
            </div>
          </div>
        `;
      }
    }
    function toElvishInscription(num) {
      const roman = ["","I","II","III","IV","V","VI","VII","VIII","IX","X",
        "XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX",
        "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX",
        "XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL",
        "XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L"];
      let romanNum = num < roman.length ? roman[num] : num;
      return "Ash nazg " + romanNum + " burzum-ishi";
    }
    function playStreakSound() {
      if (document.body.classList.contains('ringmode')) {
        try {
          document.getElementById('streakSound').currentTime = 0;
          document.getElementById('streakSound').play();
        } catch (e) {}
      }
    }
    // ========== DATA STORAGE ==========
    function saveData() {
      localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
      localStorage.setItem('mealLog', JSON.stringify(mealLog));
      localStorage.setItem('streak', JSON.stringify(streak));
    }
    // ========== EXPORT ==========
    function exportCSV() {
      let csv = "Meal,Calories,Protein,Carbs,Fat\n";
      mealLog.forEach(m=>{
        csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
      });
      download(csv, "macrolegend.csv");
    }
    function exportTXT() {
      let txt = "MacroLegend Log\n==================\n";
      mealLog.forEach(m=>{
        txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
      });
      download(txt, "macrolegend.txt");
    }
    function download(content, filename) {
      const a = document.createElement('a');
      const file = new Blob([content], {type: 'text/plain'});
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }
    // ========== TOAST POPUP ==========
    function showToast(msg) {
      const el = document.createElement('div');
      el.className = 'toast'; el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2100);
    }
    // ========== BARCODE SCANNER ==========
    let scanning = false;
    function scanBarcode() {
      if (scanning) return;
      scanning = true;
      document.getElementById('barcodeVideo').style.display = 'block';
      document.getElementById('barcodeOverlay').style.display = 'block';
      document.getElementById('barcodeCancelBtn').style.display = 'block';
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcodeVideo'),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader", "ean_13_reader","upc_reader","upc_e_reader"] }
      }, function (err) {
        if (err) { showToast('Camera error'); stopBarcodeScan(); return; }
        Quagga.start();
      });
      Quagga.onDetected(barcodeDetected);
    }
    function barcodeDetected(data) {
      stopBarcodeScan();
      let code = data.codeResult.code;
      showToast("Scanned: "+code);
      // Fetch from OpenFoodFacts
      fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`).then(r=>r.json()).then(info=>{
        if (info.status === 1 && info.product && info.product.nutriments) {
          let n = info.product.nutriments;
          let name = info.product.product_name || info.product.brands || "Barcode Food";
          let cals = Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0);
          let p = Math.round(n['proteins_serving']||n['proteins_100g']||0);
          let car = Math.round(n['carbohydrates_serving']||n['carbohydrates_100g']||0);
          let fat = Math.round(n['fat_serving']||n['fat_100g']||0);
          if (!cals) cals = Math.round((n['energy_100g']||0)/4.184);
          mealLog.push({name,calories:cals,protein:p,carbs:car,fat:fat,date:Date.now()});
          saveData(); renderAll();
          showToast("Added "+name);
        } else {
          showToast("No food info found");
        }
      }).catch(()=>showToast("Scan failed!"));
    }
    function stopBarcodeScan() {
      Quagga.stop();
      document.getElementById('barcodeVideo').style.display = 'none';
      document.getElementById('barcodeOverlay').style.display = 'none';
      document.getElementById('barcodeCancelBtn').style.display = 'none';
      scanning = false;
      Quagga.offDetected(barcodeDetected);
    }
    // ========== ALL RENDERS ==========
    function renderAll() {
      updateTotals();
      if (document.getElementById('tabCalc').classList.contains('active')) renderCalculatorTab();
      else renderProgressionTab();
      renderQuote();
    }
    // ========== QUOTE RENDER ==========
    function renderQuote() {
      let quoteEl = document.getElementById('quoteRow');
      if (!quoteEl) return;
      if (currentTheme === 'ring') {
        quoteEl.style.display = 'none';
      } else {
        quoteEl.style.display = 'block';
        const idx = streak.days % genericQuotes.length;
        quoteEl.innerHTML = `"${genericQuotes[idx]}"`
      }
    }
    // ========== INIT ==========
    renderTab('calc');
    // Handle tab click logic
    document.getElementById('tabCalc').onclick = ()=>showTab('calc');
    document.getElementById('tabProg').onclick = ()=>showTab('prog');
    document.getElementById('appleLightBtn').onclick = ()=>setTheme('light');
    document.getElementById('ringModeBtn').onclick = ()=>setTheme('ring');
    setTimeout(()=>{ renderStreak(); renderQuote(); }, 100);
  </script>
</body>
</html>
