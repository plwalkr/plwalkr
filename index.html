<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MacroLegend LOTR Edition</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  @import url('https://fonts.cdnfonts.com/css/ringbearer');

  /* Root colors and vars */
  :root {
    --light-bg: #f6f6fa;
    --light-card: #fff;
    --light-text: #3b3b3b;
    --light-accent: #2b78e4;
    --light-bar: #d6eaff;
    --light-shadow: 0 4px 16px #00000022;
    --deep-silver: #4a4a4a;
    --gold: #fbe62c;
    --progress-radius: 14px;
  }

  /* Parchment texture (embedded small seamless pattern) */
  body.ringmode {
    background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAI0lEQVQYV2NkwA7+8OwEaLJoMwMkWkMkAa2MAqDcZjUeBfkhCABfLBRbnf90GgAAAABJRU5ErkJggg==') repeat;
    color: var(--gold);
    font-family: 'Ringbearer', 'Inter', serif;
    transition: background 0.5s ease, color 0.5s ease;
  }
  /* Light mode body */
  body {
    background: var(--light-bg);
    color: var(--deep-silver);
    font-family: 'Inter', sans-serif;
    margin: 0; padding: 0;
    min-height: 100vh;
    display: flex; justify-content: center; align-items: flex-start;
    padding-top: 3rem;
    transition: background 0.5s ease, color 0.5s ease;
  }
  /* Container */
  #macroLegendContainer {
    background: var(--light-card);
    box-shadow: var(--light-shadow);
    border-radius: 22px;
    width: 95vw;
    max-width: 480px;
    padding: 2rem 2rem 3rem 2rem;
    position: relative;
  }
  body.ringmode #macroLegendContainer {
    background: rgba(42, 32, 9, 0.9);
    box-shadow: 0 0 16px 5px rgba(251, 230, 44, 0.7);
  }

  /* Header */
  h1 {
    font-family: 'Ringbearer', 'Inter', serif;
    font-size: 2.4rem;
    text-align: center;
    margin-bottom: 1.3rem;
    user-select: none;
  }
  body:not(.ringmode) h1 {
    color: var(--light-accent);
  }
  body.ringmode h1 {
    color: var(--gold);
    text-shadow: 0 0 8px #edb941cc;
  }

  /* Theme toggle buttons container - moved top left */
  .theme-toggle {
    position: fixed;
    top: 1.3rem;
    left: 1.3rem;
    display: flex;
    gap: 0.7rem;
    z-index: 9999;
  }
  .theme-btn {
    background: var(--light-bar);
    border: none;
    border-radius: 14px;
    padding: 0.6rem 1.3rem;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    color: var(--light-accent);
    box-shadow: 0 2px 6px #00000022;
    transition: all 0.3s ease;
  }
  .theme-btn.active {
    background: var(--gold);
    color: #3b2e08;
    box-shadow: 0 0 12px 2px #fbe62ccc;
  }
  body.ringmode .theme-btn {
    background: #3a2e06;
    color: var(--gold);
    box-shadow: none;
  }
  body.ringmode .theme-btn.active {
    background: var(--light-card);
    color: #a28c07;
    box-shadow: 0 0 10px 3px #fbe62cbb;
  }

  /* Tabs */
  .tab-row {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .tab-btn {
    background: #eceefe;
    border: none;
    border-radius: 14px 14px 0 0;
    padding: 0.8rem 2.4rem;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 3px 10px #00000015;
    transition: background 0.25s ease, color 0.25s ease;
  }
  .tab-btn.active {
    background: var(--light-accent);
    color: white;
    box-shadow: 0 5px 12px #2b78e477;
  }
  body.ringmode .tab-btn {
    background: #3b2e06;
    color: var(--gold);
    box-shadow: none;
  }
  body.ringmode .tab-btn.active {
    background: var(--gold);
    color: #382a00;
    box-shadow: 0 0 14px 2px #fbe62cbb;
  }

  /* Input rows */
  .macro-input-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  input.macro-input, select.macro-input {
    flex: 1 1 110px;
    max-width: 130px;
    min-width: 110px;
    padding: 0.7rem 0.7rem;
    font-size: 1rem;
    border-radius: 12px;
    border: 1.4px solid #b6c6e1;
    box-shadow: 0 3px 8px #b6d4fa22;
    outline: none;
    transition: border-color 0.3s ease;
  }
  input.macro-input:focus, select.macro-input:focus {
    border-color: var(--light-accent);
  }
  body.ringmode input.macro-input, body.ringmode select.macro-input {
    background: #4a4113;
    border-color: #b99e1b;
    color: var(--gold);
    box-shadow: 0 2px 6px #b99e1b66;
  }
  body.ringmode input.macro-input:focus, body.ringmode select.macro-input:focus {
    border-color: #fbe62c;
    box-shadow: 0 0 12px 3px #fbe62caa;
  }

  /* Progress bars */
  .macro-bars {
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .macro-bar-outer {
    background: var(--light-bar);
    border-radius: var(--progress-radius);
    overflow: hidden;
    position: relative;
    height: 30px;
  }
  .macro-bar-inner {
    height: 100%;
    padding-left: 14px;
    font-weight: 700;
    font-size: 1rem;
    color: white;
    border-radius: var(--progress-radius);
    display: flex;
    align-items: center;
    text-shadow: 0 0 7px #0009;
    transition: width 0.7s cubic-bezier(.42,.64,.51,1.14);
    white-space: nowrap;
    position: relative;
  }
  .bar-cal {
    background: linear-gradient(90deg,#fbe62c,#f5c80f);
    color: #735900;
  }
  .bar-p {
    background: linear-gradient(90deg,#51c16e,#379956);
  }
  .bar-c {
    background: linear-gradient(90deg,#61aaff,#396ebb);
  }
  .bar-f {
    background: linear-gradient(90deg,#f5a94d,#d1850b);
  }

  /* Meal log table */
  table.meal-log-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1rem;
    box-shadow: 0 2px 8px #00000012;
    border-radius: 10px;
    overflow-x: auto;
  }
  table.meal-log-table th, table.meal-log-table td {
    padding: 8px 9px;
    text-align: center;
    border-bottom: 1px solid #ccc;
    white-space: nowrap;
  }
  table.meal-log-table th {
    background: #f2f6fc;
    font-weight: 700;
    color: var(--light-accent);
  }
  body.ringmode table.meal-log-table th {
    background: #382a00;
    color: var(--gold);
  }
  body.ringmode table.meal-log-table td {
    color: var(--gold);
  }
  table.meal-log-table tbody tr:nth-child(even) {
    background: #f9fbff;
  }
  body.ringmode table.meal-log-table tbody tr:nth-child(even) {
    background: #4a4013;
  }
  table.meal-log-table button {
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 700;
    color: #e34747;
    font-size: 1.1rem;
    padding: 0 6px;
  }

  /* Buttons */
  button.add-meal-btn, button.export-btn, button.scan-btn {
    cursor: pointer;
    border-radius: 12px;
    font-weight: 700;
    border: none;
    padding: 0.65rem 1.6rem;
    font-size: 1rem;
    box-shadow: 0 2px 8px #00000022;
    transition: background 0.3s ease;
  }
  button.add-meal-btn {
    background-color: var(--light-accent);
    color: white;
  }
  button.add-meal-btn:hover, button.add-meal-btn:focus {
    background-color: #205b9c;
  }
  button.export-btn {
    background-color: #e9eef6;
    color: var(--light-accent);
    margin-right: 0.5rem;
  }
  button.export-btn:hover, button.export-btn:focus {
    background-color: #bcd9ff;
  }
  button.scan-btn {
    background-color: #fbe62c;
    color: #382a00;
  }
  button.scan-btn:hover, button.scan-btn:focus {
    background-color: #d9c218;
  }

  /* Streak */
  .streak-ring-wrap {
    position: relative;
    width: 140px;
    height: 140px;
    margin: 3rem auto 1rem auto;
    filter: drop-shadow(0 0 8px #edb94188);
    border-radius: 50%;
  }
  .streak-ring-svg {
    width: 100%;
    height: 100%;
    display: block;
  }
  .streak-center-label {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Ringbearer', serif;
    font-weight: 700;
    font-size: 1.7rem;
    color: var(--gold);
    text-shadow: 0 0 12px #fbe62cdd;
    user-select: none;
    text-align: center;
    line-height: 1.1;
  }
  .streak-week-phrase {
    margin-top: 0.6rem;
    font-family: 'Ringbearer', serif;
    font-size: 1rem;
    color: var(--gold);
    text-align: center;
    user-select: none;
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Export button container */
  .export-row {
    display: flex;
    justify-content: flex-end;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  /* Responsive tweaks */
  @media (max-width: 520px) {
    #macroLegendContainer {
      padding: 1.5rem 1rem 2.5rem 1rem;
    }
    .macro-input-row {
      gap: 0.7rem;
    }
    button.add-meal-btn, button.export-btn, button.scan-btn {
      padding: 0.55rem 1rem;
      font-size: 0.95rem;
    }
    .streak-ring-wrap {
      width: 120px;
      height: 120px;
      margin: 2rem auto 1rem auto;
    }
    .streak-center-label {
      font-size: 1.4rem;
    }
    .streak-week-phrase {
      font-size: 0.9rem;
      max-width: 300px;
    }
  }

  /* Barcode video overlay */
  #barcodeVideo {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    background: #000c;
    z-index: 9999;
    display: none;
  }
  #barcodeOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    pointer-events: none;
    background: radial-gradient(ellipse at center, transparent 60%, #000a 100%);
    z-index: 9998;
    display: none;
  }
  #barcodeCancelBtn {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 10000;
    background: var(--gold);
    color: #382a00;
    border: none;
    border-radius: 12px;
    padding: 0.6rem 1.3rem;
    font-weight: 800;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 0 14px 3px var(--gold);
    display: none;
  }
</style>
</head>
<body>

  <div class="theme-toggle">
    <button class="theme-btn active" id="lightBtn">Light</button>
    <button class="theme-btn" id="ringBtn">Ring Mode</button>
  </div>

  <div id="macroLegendContainer">
    <h1>MacroLegend</h1>
    <div class="tab-row">
      <button class="tab-btn active" id="tabCalcBtn">Calculator</button>
      <button class="tab-btn" id="tabProgBtn">Progression</button>
    </div>
    <div id="tabContent"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

  <script>
  // ====== Data & State ======
  const streakPhrases = [
    "Even the smallest person can change the course of the future.",
    "Not all those who wander are lost.",
    "The road goes ever on and on.",
    "Deeds will not be less valiant because they are unpraised.",
    "Faithless is he that says farewell when the road darkens.",
    "All we have to decide is what to do with the time that is given us.",
    "There’s some good in this world, and it’s worth fighting for.",
    "I am glad you are here with me. Here at the end of all things.",
    "The world is indeed full of peril, and in it there are many dark places.",
    "A wizard is never late, nor is he early, he arrives precisely when he means to.",
    "You shall not pass!",
    "Courage is found in unlikely places.",
    "The shadow is only a passing thing.",
    "Hope remains while the Company is true.",
    "The board is set, the pieces are moving.",
    "One does not simply walk into Mordor.",
    "I would rather share one lifetime with you than face all the ages of this world alone.",
    "May it be a light to you in dark places, when all other lights go out.",
    "It's a dangerous business, going out your door.",
    "The wise speak only of what they know.",
    "Many that live deserve death. And some that die deserve life.",
    "Even darkness must pass. A new day will come.",
    "The strength of the ring-bearer is in his heart.",
    "There’s always hope.",
    "For Frodo.",
    "The journey doesn’t end here.",
    "I am no man!",
    "The Ring has awoken.",
    "Speak, friend, and enter.",
    "There and back again.",
    "Let him not vow to walk in the dark, who has not seen the nightfall.",
    "Renewed shall be blade that was broken.",
    "I will take the Ring, though I do not know the way.",
    "A day may come when the courage of men fails… but it is not this day.",
    "My friends, you bow to no one.",
    "White shores, and beyond, a far green country under a swift sunrise.",
    "You have my sword.",
    "The Shire must truly be a great place.",
    "If by my life or death I can protect you, I will.",
    "End? No, the journey doesn't end here.",
    "Where there's life, there's hope.",
    "It’s the job that’s never started as takes longest to finish.",
    "But in the end, it’s only a passing thing, this shadow.",
    "I can't carry it for you, but I can carry you!",
    "The hands of a king are the hands of a healer.",
    "Shadowfax, show us the meaning of haste.",
    "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
    "Mithrandir, why did you leave us?",
    "You shall be the Fellowship of the Ring.",
    "I will not say: do not weep; for not all tears are an evil.",
    "The fire of your heart outshines the darkness.",
    "May your path be green and the breeze on your back.",
    "Streaks are for heroes. Today you are legend.",
    "Let the courage of the Eldar guide you.",
  ];

  let macroGoals = { calories: 2000, protein: 150, carbs: 200, fat: 70 };
  let macroTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
  let mealLog = [];
  let streak = { days: 1, best: 1, lastDate: null, phraseIndex: 0 };

  // Load saved data if exists
  try {
    const savedGoals = localStorage.getItem('macroGoals');
    if (savedGoals) macroGoals = JSON.parse(savedGoals);
    const savedMeals = localStorage.getItem('mealLog');
    if (savedMeals) mealLog = JSON.parse(savedMeals);
    const savedStreak = localStorage.getItem('streak');
    if (savedStreak) streak = JSON.parse(savedStreak);
  } catch {}

  // ====== DOM Elements ======
  const tabContent = document.getElementById('tabContent');
  const tabCalcBtn = document.getElementById('tabCalcBtn');
  const tabProgBtn = document.getElementById('tabProgBtn');
  const lightBtn = document.getElementById('lightBtn');
  const ringBtn = document.getElementById('ringBtn');

  // ====== Theme ======
  function setTheme(theme) {
    if (theme === 'ring') {
      document.body.classList.add('ringmode');
      ringBtn.classList.add('active');
      lightBtn.classList.remove('active');
    } else {
      document.body.classList.remove('ringmode');
      lightBtn.classList.add('active');
      ringBtn.classList.remove('active');
    }
    renderStreak(); // redraw streak colors
  }
  lightBtn.onclick = () => setTheme('light');
  ringBtn.onclick = () => setTheme('ring');

  // ====== Tabs ======
  function showTab(tab) {
    if (tab === 'calc') {
      tabCalcBtn.classList.add('active');
      tabProgBtn.classList.remove('active');
      renderCalculatorTab();
    } else {
      tabProgBtn.classList.add('active');
      tabCalcBtn.classList.remove('active');
      renderProgressionTab();
    }
  }
  tabCalcBtn.onclick = () => showTab('calc');
  tabProgBtn.onclick = () => showTab('prog');

  // ====== Render Calculator Tab ======
  function renderCalculatorTab() {
    tabContent.innerHTML = `
      <form id="calcForm" class="macro-input-row">
        <input id="weightInput" class="macro-input" type="number" min="70" max="700" placeholder="Weight (lbs)" required />
        <input id="heightInput" class="macro-input" type="number" min="48" max="96" placeholder="Height (in)" required />
        <input id="ageInput" class="macro-input" type="number" min="8" max="99" placeholder="Age" required />
        <select id="genderInput" class="macro-input" required>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <select id="activityInput" class="macro-input" required>
          <option value="1.2">Sedentary</option>
          <option value="1.375">Light (1-3 days/wk)</option>
          <option value="1.55">Moderate (3-5 days/wk)</option>
          <option value="1.725">Active (6-7 days/wk)</option>
          <option value="1.9">Very Active</option>
        </select>
        <select id="goalInput" class="macro-input" required>
          <option value="maintain">Maintain</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
        <button type="submit" class="add-meal-btn">Set Macros</button>
      </form>
      <div class="macro-input-row" style="justify-content:center;">
        <input id="goalCalories" class="macro-input" type="number" min="0" placeholder="Goal Calories" />
        <input id="goalProtein" class="macro-input" type="number" min="0" placeholder="Goal Protein (g)" />
        <input id="goalCarbs" class="macro-input" type="number" min="0" placeholder="Goal Carbs (g)" />
        <input id="goalFat" class="macro-input" type="number" min="0" placeholder="Goal Fat (g)" />
        <button id="saveGoalsBtn" class="add-meal-btn">Save Goals</button>
      </div>
      <p style="text-align:center; color:#687; font-size:0.9rem; margin-top: 0.4rem;">
        Use the calculator to estimate daily calories & macros. Your settings update the Progression tab instantly.
      </p>
    `;

    // Fill current goals in inputs
    document.getElementById('goalCalories').value = macroGoals.calories;
    document.getElementById('goalProtein').value = macroGoals.protein;
    document.getElementById('goalCarbs').value = macroGoals.carbs;
    document.getElementById('goalFat').value = macroGoals.fat;

    document.getElementById('calcForm').onsubmit = (e) => {
      e.preventDefault();
      const w = Number(document.getElementById('weightInput').value);
      const h = Number(document.getElementById('heightInput').value);
      const a = Number(document.getElementById('ageInput').value);
      const g = document.getElementById('genderInput').value;
      const act = Number(document.getElementById('activityInput').value);
      const goal = document.getElementById('goalInput').value;

      if (!w || !h || !a) {
        showToast('Please fill all required fields!');
        return;
      }

      // BMR formula
      let bmr = (g === 'male')
        ? 66 + (6.23 * w) + (12.7 * h) - (6.8 * a)
        : 655 + (4.35 * w) + (4.7 * h) - (4.7 * a);
      let tdee = bmr * act;
      let cal = tdee;

      if (goal === 'lose') cal -= 500;
      else if (goal === 'gain') cal += 300;

      macroGoals.calories = Math.round(cal);
      macroGoals.protein = Math.round(w * 0.8);
      macroGoals.carbs = Math.round((cal * 0.45) / 4);
      macroGoals.fat = Math.round((cal * 0.25) / 9);

      saveData();
      renderProgressionTab();
      showToast('Goals updated!');
    };

    document.getElementById('saveGoalsBtn').onclick = (e) => {
      e.preventDefault();
      macroGoals.calories = Number(document.getElementById('goalCalories').value) || 0;
      macroGoals.protein = Number(document.getElementById('goalProtein').value) || 0;
      macroGoals.carbs = Number(document.getElementById('goalCarbs').value) || 0;
      macroGoals.fat = Number(document.getElementById('goalFat').value) || 0;
      saveData();
      renderProgressionTab();
      showToast('Goals saved!');
    };
  }

  // ====== Render Progression Tab ======
  function renderProgressionTab() {
    tabContent.innerHTML = `
      <div class="macro-bars" id="macroBars"></div>
      <form id="mealForm" class="macro-input-row" autocomplete="off" style="flex-wrap: nowrap; gap: 0.4rem;">
        <input id="mealNameInput" type="text" placeholder="Meal name or scan barcode" style="flex-grow: 1; padding:0.6rem 0.8rem; font-size:1rem; border-radius: 12px; border: 1.4px solid #b6c6e1;" autocomplete="off" />
        <input id="mealCaloriesInput" type="number" min="0" placeholder="Cal" style="width:80px; padding:0.6rem; font-size:1rem; border-radius: 12px; border: 1.4px solid #b6c6e1;" />
        <input id="mealProteinInput" type="number" min="0" placeholder="P (g)" style="width:80px; padding:0.6rem; font-size:1rem; border-radius: 12px; border: 1.4px solid #b6c6e1;" />
        <input id="mealCarbsInput" type="number" min="0" placeholder="C (g)" style="width:80px; padding:0.6rem; font-size:1rem; border-radius: 12px; border: 1.4px solid #b6c6e1;" />
        <input id="mealFatInput" type="number" min="0" placeholder="F (g)" style="width:80px; padding:0.6rem; font-size:1rem; border-radius: 12px; border: 1.4px solid #b6c6e1;" />
        <button type="submit" class="add-meal-btn" style="min-width: 70px;">+ Add</button>
        <button type="button" id="scanBarcodeBtn" class="scan-btn" title="Scan Barcode">&#128247;</button>
      </form>
      <table class="meal-log-table" id="mealLogTable"></table>
      <div class="export-row">
        <button id="exportCSVBtn" class="export-btn">Export CSV</button>
        <button id="exportTXTBtn" class="export-btn">Export TXT</button>
      </div>
      <div class="streak-ring-wrap" id="streakArea"></div>

      <!-- Barcode video overlay -->
      <video id="barcodeVideo" autoplay playsinline></video>
      <div id="barcodeOverlay"></div>
      <button id="barcodeCancelBtn">Cancel Scan</button>
    `;

    // Attach event listeners
    document.getElementById('mealForm').onsubmit = (e) => {
      e.preventDefault();
      addMeal();
    };

    document.getElementById('exportCSVBtn').onclick = exportCSV;
    document.getElementById('exportTXTBtn').onclick = exportTXT;

    document.getElementById('scanBarcodeBtn').onclick = () => {
      startBarcodeScan();
    };

    document.getElementById('barcodeCancelBtn').onclick = () => {
      stopBarcodeScan();
    };

    setupAutocomplete();

    updateTotals();
    renderProgressBars();
    renderMealLog();
    renderStreak();
  }

  // ====== Meal functions ======
  function addMeal() {
    const name = document.getElementById('mealNameInput').value.trim();
    const calories = Number(document.getElementById('mealCaloriesInput').value) || 0;
    const protein = Number(document.getElementById('mealProteinInput').value) || 0;
    const carbs = Number(document.getElementById('mealCarbsInput').value) || 0;
    const fat = Number(document.getElementById('mealFatInput').value) || 0;

    if (!name || calories <= 0) {
      showToast('Please enter meal name and calories!');
      return;
    }
    mealLog.push({ name, calories, protein, carbs, fat, date: Date.now() });
    saveData();
    clearMealInputs();
    updateTotals();
    renderProgressBars();
    renderMealLog();
    checkStreak();
    showToast('Meal added!');
  }
  function clearMealInputs() {
    ['mealNameInput', 'mealCaloriesInput', 'mealProteinInput', 'mealCarbsInput', 'mealFatInput'].forEach(id => {
      document.getElementById(id).value = '';
    });
  }
  function renderProgressBars() {
    const container = document.getElementById('macroBars');
    const t = macroTotals;
    const g = macroGoals;

    function pct(val, goal) {
      if (goal === 0) return 0;
      return Math.min(100, Math.round((val / goal) * 100));
    }

    container.innerHTML = `
      <div class="macro-bar-outer">
        <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories, g.calories)}%">
          ${t.calories} / ${g.calories} kcal
        </div>
      </div>
      <div class="macro-bar-outer">
        <div class="macro-bar-inner bar-p" style="width:${pct(t.protein, g.protein)}%">
          ${t.protein} / ${g.protein} g Protein
        </div>
      </div>
      <div class="macro-bar-outer">
        <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs, g.carbs)}%">
          ${t.carbs} / ${g.carbs} g Carbs
        </div>
      </div>
      <div class="macro-bar-outer">
        <div class="macro-bar-inner bar-f" style="width:${pct(t.fat, g.fat)}%">
          ${t.fat} / ${g.fat} g Fat
        </div>
      </div>
    `;
  }
  function renderMealLog() {
    const table = document.getElementById('mealLogTable');
    if (!mealLog.length) {
      table.innerHTML = '<tbody><tr><td colspan="6" style="padding:1rem; color:#888;">No meals logged yet.</td></tr></tbody>';
      return;
    }
    const rows = mealLog.map((m, i) => `
      <tr>
        <td>${m.name}</td>
        <td>${m.calories}</td>
        <td>${m.protein}</td>
        <td>${m.carbs}</td>
        <td>${m.fat}</td>
        <td><button onclick="removeMeal(${i})" title="Remove Meal">×</button></td>
      </tr>
    `).join('');
    table.innerHTML = `
      <thead>
        <tr>
          <th>Meal</th>
          <th>Cal</th>
          <th>P</th>
          <th>C</th>
          <th>F</th>
          <th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    `;
  }
  function removeMeal(idx) {
    mealLog.splice(idx, 1);
    saveData();
    updateTotals();
    renderProgressBars();
    renderMealLog();
    showToast('Meal removed.');
  }
  function updateTotals() {
    macroTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
    mealLog.forEach(m => {
      macroTotals.calories += m.calories || 0;
      macroTotals.protein += m.protein || 0;
      macroTotals.carbs += m.carbs || 0;
      macroTotals.fat += m.fat || 0;
    });
  }

  // ====== Streak functions ======
  function checkStreak() {
    const todayISO = new Date().toISOString().slice(0, 10);
    if (streak.lastDate === todayISO) return;
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yestISO = yesterday.toISOString().slice(0, 10);

    if (streak.lastDate === yestISO) {
      streak.days++;
      if (streak.days > streak.best) {
        streak.best = streak.days;
        playStreakSound();
      }
    } else {
      streak.days = 1;
    }
    streak.lastDate = todayISO;
    streak.phraseIndex = (streak.days - 1) % streakPhrases.length;
    saveData();
    renderStreak();
  }
  function renderStreak() {
    const streakArea = document.getElementById('streakArea');
    const phrase = streakPhrases[streak.phraseIndex];

    streakArea.innerHTML = `
      <div class="streak-ring-wrap">
        <svg class="streak-ring-svg" width="140" height="140" viewBox="0 0 140 140">
          <defs>
            <radialGradient id="goldGradient" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#fff9c9" />
              <stop offset="65%" stop-color="#edb941" />
              <stop offset="100%" stop-color="#a28209" />
            </radialGradient>
          </defs>
          <circle cx="70" cy="70" r="58" fill="url(#goldGradient)" stroke="#d4b117" stroke-width="7" />
        </svg>
        <div class="streak-center-label">
          ${streak.days}<br><small>days</small><br>Best: ${streak.best}
        </div>
      </div>
      <div class="streak-week-phrase">"${phrase}"</div>
    `;
  }
  function playStreakSound() {
    try {
      const audio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3');
      audio.volume = 0.15;
      audio.play();
    } catch {}
  }

  // ====== Storage ======
  function saveData() {
    localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
    localStorage.setItem('mealLog', JSON.stringify(mealLog));
    localStorage.setItem('streak', JSON.stringify(streak));
  }

  // ====== Export ======
  function exportCSV() {
    let csv = 'Meal,Calories,Protein,Carbs,Fat\n';
    mealLog.forEach(m => {
      csv += `${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
    });
    downloadFile(csv, 'macrolegend.csv');
  }
  function exportTXT() {
    let txt = 'MacroLegend Log\n===================\n';
    mealLog.forEach(m => {
      txt += `${m.name.padEnd(20)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
    });
    downloadFile(txt, 'macrolegend.txt');
  }
  function downloadFile(content, filename) {
    const a = document.createElement('a');
    const file = new Blob([content], { type: 'text/plain' });
    a.href = URL.createObjectURL(file);
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  // ====== Toast ======
  function showToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.left = '50%';
    toast.style.bottom = '2rem';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#fffbe0';
    toast.style.color = '#2b78e4';
    toast.style.padding = '12px 28px';
    toast.style.borderRadius = '20px';
    toast.style.boxShadow = '0 5px 22px #0006';
    toast.style.fontWeight = '700';
    toast.style.fontSize = '1rem';
    toast.style.zIndex = '100000';
    toast.style.opacity = '0.95';
    toast.style.pointerEvents = 'none';
    toast.style.userSelect = 'none';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2200);
  }

  // ====== Barcode Scanner ======
  let scanning = false;
  function startBarcodeScan() {
    if (scanning) return;
    scanning = true;

    const videoEl = document.getElementById('barcodeVideo');
    const overlayEl = document.getElementById('barcodeOverlay');
    const cancelBtn = document.getElementById('barcodeCancelBtn');

    videoEl.style.display = 'block';
    overlayEl.style.display = 'block';
    cancelBtn.style.display = 'block';

    Quagga.init({
      inputStream: {
        name: 'Live',
        type: 'LiveStream',
        target: videoEl,
        constraints: { facingMode: 'environment' },
      },
      decoder: {
        readers: ['ean_reader', 'ean_13_reader', 'upc_reader', 'upc_e_reader'],
      },
    }, err => {
      if (err) {
        showToast('Camera initialization failed.');
        stopBarcodeScan();
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(onBarcodeDetected);
  }
  function onBarcodeDetected(result) {
    if (!result || !result.codeResult) return;
    const code = result.codeResult.code;
    stopBarcodeScan();
    showToast(`Scanned: ${code}`);
    fetchFoodByBarcode(code);
  }
  function stopBarcodeScan() {
    Quagga.stop();
    document.getElementById('barcodeVideo').style.display = 'none';
    document.getElementById('barcodeOverlay').style.display = 'none';
    document.getElementById('barcodeCancelBtn').style.display = 'none';
    scanning = false;
    Quagga.offDetected(onBarcodeDetected);
  }
  // ====== Fetch food info by barcode from OpenFoodFacts ======
  async function fetchFoodByBarcode(barcode) {
    try {
      const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
      const data = await res.json();
      if (data.status === 1 && data.product && data.product.nutriments) {
        const p = data.product;
        const n = p.nutriments;
        const name = p.product_name || p.brands || 'Unknown Food';
        const calories = Math.round(n['energy-kcal_serving'] || n['energy-kcal_100g'] || 0);
        const protein = Math.round(n['proteins_serving'] || n['proteins_100g'] || 0);
        const carbs = Math.round(n['carbohydrates_serving'] || n['carbohydrates_100g'] || 0);
        const fat = Math.round(n['fat_serving'] || n['fat_100g'] || 0);
        if (!calories) calories = Math.round((n['energy_100g'] || 0) / 4.184);
        mealLog.push({ name, calories, protein, carbs, fat, date: Date.now() });
        saveData();
        updateTotals();
        renderProgressBars();
        renderMealLog();
        checkStreak();
        showToast(`Added: ${name}`);
      } else {
        showToast('Food info not found.');
      }
    } catch {
      showToast('Failed to fetch food info.');
    }
  }

  // ====== Autocomplete Setup ======
  function setupAutocomplete() {
    const input = document.getElementById('mealNameInput');
    let timeoutId;
    let dropdown;

    input.setAttribute('autocomplete', 'off');
    input.style.position = 'relative';

    input.addEventListener('input', () => {
      clearTimeout(timeoutId);
      if (input.value.trim().length < 2) {
        closeDropdown();
        return;
      }
      timeoutId = setTimeout(() => {
        fetchFoodAutocomplete(input.value.trim());
      }, 400);
    });

    // Create dropdown container
    dropdown = document.createElement('div');
    dropdown.style.position = 'absolute';
    dropdown.style.background = '#fff';
    dropdown.style.border = '1px solid #ccc';
    dropdown.style.borderRadius = '8px';
    dropdown.style.maxHeight = '180px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.width = input.offsetWidth + 'px';
    dropdown.style.zIndex = '100000';
    dropdown.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)';
    dropdown.style.cursor = 'pointer';
    dropdown.style.display = 'none';

    input.parentNode.style.position = 'relative';
    input.parentNode.appendChild(dropdown);

    dropdown.addEventListener('click', (e) => {
      if (e.target && e.target.matches('.autocomplete-item')) {
        const idx = Number(e.target.getAttribute('data-index'));
        const item = autocompleteResults[idx];
        if (item) {
          fillMealInputsFromFood(item);
          closeDropdown();
        }
      }
    });

    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !dropdown.contains(e.target)) {
        closeDropdown();
      }
    });
  }

  let autocompleteResults = [];
  async function fetchFoodAutocomplete(query) {
    const input = document.getElementById('mealNameInput');
    const dropdown = input.parentNode.querySelector('div');
    dropdown.style.width = input.offsetWidth + 'px';

    try {
      const res = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=8`);
      const data = await res.json();
      if (data.products && data.products.length) {
        autocompleteResults = data.products;
        dropdown.innerHTML = data.products.map((p, i) => `
          <div class="autocomplete-item" data-index="${i}" style="padding: 8px 10px; border-bottom: 1px solid #eee;">
            ${p.product_name || p.brands || 'Unknown'}
          </div>
        `).join('');
        dropdown.style.display = 'block';
      } else {
        autocompleteResults = [];
        dropdown.style.display = 'none';
      }
    } catch {
      autocompleteResults = [];
      dropdown.style.display = 'none';
    }
  }
  function fillMealInputsFromFood(food) {
    document.getElementById('mealNameInput').value = food.product_name || food.brands || '';
    const n = food.nutriments || {};
    document.getElementById('mealCaloriesInput').value = Math.round(n['energy-kcal_serving'] || n['energy-kcal_100g'] || 0);
    document.getElementById('mealProteinInput').value = Math.round(n['proteins_serving'] || n['proteins_100g'] || 0);
    document.getElementById('mealCarbsInput').value = Math.round(n['carbohydrates_serving'] || n['carbohydrates_100g'] || 0);
    document.getElementById('mealFatInput').value = Math.round(n['fat_serving'] || n['fat_100g'] || 0);
  }
  function closeDropdown() {
    const input = document.getElementById('mealNameInput');
    const dropdown = input.parentNode.querySelector('div');
    dropdown.style.display = 'none';
  }

  // ====== Init ======
  setTheme('light');
  showTab('calc');
  updateTotals();

  </script>

</body>
</html>
