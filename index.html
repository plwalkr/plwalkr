<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroLegend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #121212;
      --container-bg: #1e1e2f;
      --text-color: #e0e0e0;
      --accent-color: #82aaff;
      --button-bg: #3a3f58;
      --button-hover: #5c63bc;
      --result-color: #d1e231;
      --input-bg: #232438;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #151616 0%, #234b28 100%);
      color: var(--text-color);
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      background-color: var(--container-bg);
      box-shadow: 0 6px 40px #000b;
      padding: 2.1rem 1.4rem 1.6rem 1.4rem;
      border-radius: 20px;
      max-width: 400px;
      width: 100%;
      min-width: 0;
      margin: 1rem;
      animation: popin 0.7s cubic-bezier(.4,2.7,.7,0.7);
    }
    @keyframes popin {
      from {transform: scale(0.85) translateY(30px);}
      to {transform: scale(1) translateY(0);}
    }
    h1 {
      text-align: center;
      color: var(--result-color);
      font-weight: 700;
      letter-spacing: 2px;
      font-size: 2rem;
      margin-bottom: 0.8rem;
      user-select: none;
      text-shadow: 0 4px 16px #000a;
    }
    .tab-bar {
      display: flex;
      border-radius: 9px;
      background: #181e1c;
      box-shadow: 0 2px 8px #0003;
      margin-bottom: 1.1rem;
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 0.7em 0.2em;
      background: none;
      color: #ccc;
      border: none;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .14s, color .14s;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active {
      color: var(--result-color);
      background: #242b2a;
      border-bottom: 3px solid var(--accent-color);
      z-index: 2;
    }
    .tab-content {
      display: none;
      min-height: 150px;
      margin-bottom: 1.2rem;
    }
    .tab-content.active { display: block; }
    label, .macro-label {
      font-size: 1rem;
      color: var(--accent-color);
      font-weight: 500;
      display: block;
      margin-bottom: 0.2em;
      margin-top: 0.7em;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.3rem;
      border-radius: 8px;
      border: 1.5px solid #44475a;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 1.05rem;
      box-sizing: border-box;
      outline: none;
      transition: border 0.15s;
    }
    input:focus, select:focus {
      border: 1.5px solid var(--accent-color);
    }
    button {
      cursor: pointer;
      background-color: var(--button-bg);
      color: var(--text-color);
      font-weight: 700;
      border: none;
      border-radius: 9px;
      padding: 0.8em 0.3em;
      font-size: 1.08rem;
      letter-spacing: 1px;
      transition: background 0.14s, transform 0.09s;
      box-shadow: 0 1px 6px #0004;
      margin-top: 0.5em;
      margin-bottom: 0.6em;
      width: 100%;
      display: block;
    }
    button:hover, button:focus {
      background-color: var(--button-hover);
      transform: scale(1.04);
    }
    .macro-slider-container {
      margin-bottom: 1.0rem;
    }
    .macro-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.1rem;
      color: var(--accent-color);
      font-size: 0.97rem;
      margin-top: 0.2em;
    }
    .macro-slider-container input[type="range"] {
      width: 100%;
      accent-color: var(--result-color);
      margin-bottom: 0.1rem;
    }
    .copy-toast {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: #212c2f;
      color: #fff;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 1.06rem;
      box-shadow: 0 3px 12px #000b;
      opacity: 0.94;
      z-index: 99;
      pointer-events: none;
      animation: fadeToast 2s linear;
    }
    @keyframes fadeToast {
      0%{opacity:0;}
      10%{opacity:1;}
      90%{opacity:0.95;}
      100%{opacity:0;}
    }
    .graph-card {
      background: #242b2a;
      border-radius: 12px;
      box-shadow: 0 2px 9px #0007;
      margin: 1.1rem 0 0.8rem 0;
      padding: 1.1rem 0.5rem 0.4rem 0.5rem;
      text-align: center;
    }
    .macro-summary {
      margin: 0.6em 0 1.0em 0;
      font-size: 1.08em;
      color: #ccc;
      line-height: 1.55;
      background: #1e1e2f;
      border-radius: 9px;
      padding: 0.7em 0.7em 0.7em 0.9em;
    }
    @media (max-width:800px) {
      .container { max-width:99vw; padding:1.1rem 0.2rem; border-radius: 0;}
      h1 { font-size: 1.25rem; }
      .tab-bar { font-size: 0.99em;}
      .graph-card {padding: 0.8em 0.1em;}
    }
    @media (max-width:480px) {
      .container { min-width: 0; border-radius: 0; }
      h1 {font-size: 1.08rem;}
      .tab-bar {font-size: 0.91em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MacroLegend</h1>
    <div class="tab-bar">
      <button class="tab-btn active" onclick="showTab('log')">Meal Log</button>
      <button class="tab-btn" onclick="showTab('estimator')">Macro Estimator</button>
    </div>

    <div id="tab-log" class="tab-content active">
      <div class="macro-summary" id="goalSummary"></div>
      <form id="logForm" autocomplete="off">
        <label>Food Name</label>
        <input id="food" placeholder="e.g. Chicken breast" />
        <label>Calories</label>
        <input id="calories" type="number" min="0" />
        <label>Protein (g)</label>
        <input id="protein" type="number" min="0" />
        <label>Carbs (g)</label>
        <input id="carbs" type="number" min="0" />
        <label>Fat (g)</label>
        <input id="fat" type="number" min="0" />
        <button type="submit">Log Meal</button>
        <button type="button" onclick="clearLog()">Clear Meals</button>
      </form>
      <div class="graph-card">
        <canvas id="macroChart" style="width:100%;height:170px;max-height:220px;"></canvas>
      </div>
      <div style="font-size:0.96em;margin:0.7em 0 0.2em 0;">
        <strong>Todayâ€™s Meals:</strong>
        <ul id="mealList" style="padding-left:1em;margin:0.5em 0 0.7em 0;font-size:0.97em;color:#ffe;">
        </ul>
      </div>
    </div>

    <div id="tab-estimator" class="tab-content">
      <form id="estimatorForm" autocomplete="off" oninput="updateEstimator()">
        <label>Weight (lbs)</label>
        <input id="estWeight" type="number" min="0" value="170"/>
        <label>Height (inches)</label>
        <input id="estHeight" type="number" min="0" value="70"/>
        <label>Age</label>
        <input id="estAge" type="number" min="0" value="30"/>
        <label>Gender</label>
        <select id="estGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <label>Activity Level</label>
        <select id="estActivity">
          <option value="1.2">Sedentary (little/no exercise)</option>
          <option value="1.375">Light (1-3 days/wk)</option>
          <option value="1.55">Moderate (3-5 days/wk)</option>
          <option value="1.725">Active (6-7 days/wk)</option>
          <option value="1.9">Very Active (physical job)</option>
        </select>
        <label>Goal</label>
        <select id="estGoal">
          <option value="maintain">Maintain</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
        <label>Calories</label>
        <input id="estCalories" readonly />
        <div class="macro-slider-container">
          <div class="macro-label"><label for="estProtein">Protein %</label><span id="estProteinVal">30%</span></div>
          <input type="range" id="estProtein" min="0" max="100" value="30" oninput="sliderSum('estProtein')">
        </div>
        <div class="macro-slider-container">
          <div class="macro-label"><label for="estFat">Fat %</label><span id="estFatVal">30%</span></div>
          <input type="range" id="estFat" min="0" max="100" value="30" oninput="sliderSum('estFat')">
        </div>
        <div class="macro-slider-container">
          <div class="macro-label"><label for="estCarbs">Carbs %</label><span id="estCarbsVal">40%</span></div>
          <input type="range" id="estCarbs" min="0" max="100" value="40" oninput="sliderSum('estCarbs')">
        </div>
        <div style="font-size:0.95em;margin:0.7em 0 1em 0;color:#b4b4b4;">
          <span id="estMacroRec"></span>
        </div>
        <button type="button" onclick="setAsGoal()">Set as My Goal</button>
      </form>
      <div class="macro-summary" id="estResult"></div>
    </div>
  </div>
  <script>
    // -- TAB FUNCTIONALITY --
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
      if(tab==='log') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('tab-log').classList.add('active');
      } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('tab-estimator').classList.add('active');
      }
    }

    // ---- SLIDER AUTO-SUM FOR MACROS (ALWAYS 100%) ----
    function sliderSum(changed) {
      const p = document.getElementById('estProtein');
      const f = document.getElementById('estFat');
      const c = document.getElementById('estCarbs');
      let vals = {
        estProtein: +p.value,
        estFat: +f.value,
        estCarbs: +c.value
      };
      let sum = vals.estProtein + vals.estFat + vals.estCarbs;
      if (sum > 100) {
        let others = ['estProtein', 'estFat', 'estCarbs'].filter(k => k !== changed);
        let over = sum - 100;
        for(let k of others) {
          if(vals[k]>0 && over>0) {
            let diff = Math.min(vals[k], over);
            vals[k]-=diff; over-=diff;
          }
        }
        p.value = vals.estProtein;
        f.value = vals.estFat;
        c.value = vals.estCarbs;
      }
      document.getElementById('estProteinVal').textContent = p.value + '%';
      document.getElementById('estFatVal').textContent = f.value + '%';
      document.getElementById('estCarbsVal').textContent = c.value + '%';
      updateEstimator();
    }

    // -- ESTIMATOR CALCULATIONS --
    function updateEstimator() {
      // Get inputs
      const weight = parseFloat(document.getElementById('estWeight').value) || 0;
      const height = parseFloat(document.getElementById('estHeight').value) || 0;
      const age = parseFloat(document.getElementById('estAge').value) || 0;
      const gender = document.getElementById('estGender').value;
      const activity = parseFloat(document.getElementById('estActivity').value) || 1.2;
      const goal = document.getElementById('estGoal').value;
      const p = parseFloat(document.getElementById('estProtein').value);
      const f = parseFloat(document.getElementById('estFat').value);
      const c = parseFloat(document.getElementById('estCarbs').value);

      let bmr=0, tdee=0, adjusted=0;
      if(weight&&height&&age) {
        bmr = gender==='male'
          ? 66 + (6.23 * weight) + (12.7 * height) - (6.8 * age)
          : 655 + (4.35 * weight) + (4.7 * height) - (4.7 * age);
        tdee = bmr * activity;
        adjusted = tdee;
        if(goal==='lose') adjusted-=500;
        else if(goal==='gain') adjusted+=300;
      }

      document.getElementById('estCalories').value = adjusted>0 ? Math.round(adjusted) : '';

      // Macro recommendations
      let macroRec = '';
      if(goal==='gain') macroRec="Muscle gain: Protein 30-35%, Carbs 40-55%, Fat 20-25%";
      else if(goal==='lose') macroRec="Fat loss: Protein 30-40%, Carbs 20-30%, Fat 30-35%";
      else macroRec="Maintain: Protein 25-30%, Carbs 40-50%, Fat 20-30%";
      document.getElementById('estMacroRec').textContent = macroRec;

      // Macro outputs
      let cal = adjusted>0 ? Math.round(adjusted) : 0;
      let result = '';
      if(cal && (p+f+c===100)) {
        const gramsProtein = (cal*p/100/4).toFixed(1);
        const gramsFat = (cal*f/100/9).toFixed(1);
        const gramsCarbs = (cal*c/100/4).toFixed(1);
        result =
          `<b>Recommended per day:</b><br>
          Calories: <b>${cal}</b> kcal<br>
          Protein: <b>${gramsProtein}</b> g<br>
          Fat: <b>${gramsFat}</b> g<br>
          Carbs: <b>${gramsCarbs}</b> g`;
      } else {
        result = 'Set all fields and ensure macros add up to 100%';
      }
      document.getElementById('estResult').innerHTML = result;
    }

    // -- "SET AS GOAL" --
    function setAsGoal() {
      const cal = parseInt(document.getElementById('estCalories').value) || '';
      const p = Math.round((cal * parseFloat(document.getElementById('estProtein').value || 0) / 100) / 4);
      const f = Math.round((cal * parseFloat(document.getElementById('estFat').value || 0) / 100) / 9);
      const c = Math.round((cal * parseFloat(document.getElementById('estCarbs').value || 0) / 100) / 4);

      const newGoal = {
        calories: cal,
        protein: p,
        fat: f,
        carbs: c
      };
      localStorage.setItem('macroGoal', JSON.stringify(newGoal));
      showCopyToast('Goal set!');
      renderGoalSummary();
      renderChart();
    }

    // -- MEAL LOG LOGIC --
    let mealLog = JSON.parse(localStorage.getItem('mealLog')||'[]');
    function clearLog() {
      if(confirm('Clear all meals for today?')) {
        mealLog = [];
        localStorage.setItem('mealLog','[]');
        renderLog();
        renderChart();
      }
    }
    document.getElementById('logForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('food').value.trim();
      const cal = parseInt(document.getElementById('calories').value)||0;
      const p = parseFloat(document.getElementById('protein').value)||0;
      const c = parseFloat(document.getElementById('carbs').value)||0;
      const f = parseFloat(document.getElementById('fat').value)||0;
      if(!name || !cal) { showCopyToast('Enter food & calories'); return;}
      mealLog.push({name,calories:cal,protein:p,carbs:c,fat:f});
      localStorage.setItem('mealLog',JSON.stringify(mealLog));
      renderLog();
      renderChart();
      e.target.reset();
    };

    function renderLog() {
      const list = document.getElementById('mealList');
      if(!mealLog.length) { list.innerHTML = '<li style="color:#aaa;">No meals yet!</li>'; return; }
      list.innerHTML = mealLog.map(m=>
        `<li><b>${m.name}</b>: ${m.calories} cal, ${m.protein}g P, ${m.carbs}g C, ${m.fat}g F</li>`
      ).join('');
    }

    function sumMacros() {
      let tcal=0,tp=0,tf=0,tc=0;
      mealLog.forEach(m=>{
        tcal+=m.calories;
        tp+=m.protein;
        tf+=m.fat;
        tc+=m.carbs;
      });
      return {calories:tcal,protein:tp,fat:tf,carbs:tc};
    }

    // --- GOAL SUMMARY ---
    function renderGoalSummary() {
      let goal = JSON.parse(localStorage.getItem('macroGoal')||'null');
      if(!goal) {
        document.getElementById('goalSummary').innerHTML =
          `<b>No macro goal set.</b>  
          <br>Go to <b>Macro Estimator</b> tab, calculate, and set as goal!`;
      } else {
        document.getElementById('goalSummary').innerHTML =
          `<b>Today's Goal:</b> ${goal.calories} cal, ${goal.protein}g P, ${goal.carbs}g C, ${goal.fat}g F`;
      }
    }

    // --- CHART RENDERING (DUAL Y AXES) ---
    let macroChart;
    function renderChart() {
      let ctx = document.getElementById('macroChart').getContext('2d');
      let d = sumMacros();
      let g = JSON.parse(localStorage.getItem('macroGoal')||'null');
      let data = {
        labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
        datasets: [
          {
            label: 'Logged',
            data: [d.calories, d.protein, d.carbs, d.fat],
            backgroundColor: ['#d1e231','#5cc1b3','#89baff','#ffb868'],
            yAxisID: 'y'
          },
          {
            label: 'Goal',
            data: g ? [g.calories, g.protein, g.carbs, g.fat] : [0,0,0,0],
            backgroundColor: ['#8d9500','#158e76','#3564b0','#b46606'],
            borderWidth: 1,
            yAxisID: 'y'
          }
        ]
      };
      let options = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            beginAtZero: true,
            min: 0,
            max: Math.max((g?.calories||0)*1.25, d.calories*1.1, 1000),
            ticks: { color: '#e3e3e3', callback: v=>Math.round(v)},
            title: {display:true,text:'Calories / g',color:'#aaa'}
          }
        },
        plugins: {
          legend: {display:true,labels:{color:'#d1e231',font:{weight:600}}},
          tooltip: {enabled:true}
        }
      };
      if(macroChart) macroChart.destroy();
      macroChart = new Chart(ctx, {type:'bar', data, options});
    }

    // -- TOAST
    function showCopyToast(msg) {
      let toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 1750);
    }

    // --- INIT ---
    window.onload = function() {
      renderGoalSummary();
      renderLog();
      renderChart();
      updateEstimator();
    }
  </script>
</body>
</html>
