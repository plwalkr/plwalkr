<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MacroLegend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --main-bg: #f5f5fa;
      --container-bg: #fff;
      --text-color: #1a1a1a;
      --accent: #3d7d37;
      --bar-bg: #f0f2f4;
      --bar-protein: #a7ce7a;
      --bar-fat: #ffe699;
      --bar-carbs: #7db1ff;
      --bar-shadow: 0 2px 12px #d8e3db88;
      --ring-gold: #edb941;
      --ring-map: url('data:image/svg+xml;utf8,<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg"><rect fill=\'none\'/><text x=\'30\' y=\'60\' font-size=\'54\' fill=\'%23edb941\' fill-opacity=\'.13\' font-family=\'serif\'>Middle-earth</text><path d=\'M65 300 Q200 50 400 200 T550 100\' fill=\'none\' stroke=\'%23b59b21\' stroke-width=\'7\' stroke-opacity=\'.1\'/><text x=\'300\' y=\'390\' font-size=\'36\' fill=\'%23edb941\' fill-opacity=\'.09\'>Mordor</text></svg>');
    }

    body {
      background: var(--main-bg);
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.5s;
    }

    .container {
      margin: 2vw auto 6vw auto;
      background: var(--container-bg);
      border-radius: 20px;
      box-shadow: var(--bar-shadow);
      max-width: 400px;
      width: 96vw;
      padding: 2rem 1.4rem 2.6rem 1.4rem;
      position: relative;
    }
    h1 {
      text-align: center;
      font-family: 'Ringbearer','Inter',sans-serif;
      color: var(--accent);
      margin: 0 0 1rem 0;
      font-size: 2.1rem;
      letter-spacing: 1.5px;
      text-shadow: 0 3px 20px #0001;
      user-select: none;
    }

    .ring-btn {
      position: absolute;
      top: 16px; right: 16px;
      z-index: 3;
      background: var(--ring-gold);
      color: #2c2104;
      border: none;
      font-family: 'Ringbearer','Inter',sans-serif;
      font-size: 1.02em;
      border-radius: 11px;
      padding: 6px 20px;
      cursor: pointer;
      box-shadow: 0 2px 12px #ccb2435c;
      transition: filter 0.18s;
    }
    .ring-btn.active {
      outline: 2px solid var(--ring-gold);
      filter: drop-shadow(0 0 12px #fbe62c88);
      background: linear-gradient(90deg,#fbe62c 60%,#c39c25 100%);
    }

    label {font-weight: 600; margin: 0.5rem 0 0.2rem 0; display:block;}
    input[type="number"] {
      width: 100%; padding: 0.7em; margin-bottom: 0.4rem;
      border: 1.5px solid #cfd9de; border-radius: 8px; font-size: 1.07em;
      background: #f9f9fc; color: var(--text-color);
      box-sizing: border-box;
      transition: border 0.13s;
    }
    input[type="number"]:focus {border: 1.5px solid var(--accent);}
    select {
      width: 100%; padding: 0.7em; margin-bottom: 0.7rem;
      border-radius: 8px; font-size: 1.08rem;
      border: 1.5px solid #cfd9de; background: #f9f9fc;
      color: var(--text-color);
    }

    .macro-bars {
      margin: 1.6rem 0 0.9rem 0;
    }
    .macro-bar {
      background: var(--bar-bg);
      border-radius: 18px;
      box-shadow: 0 1.5px 7px #0001;
      margin-bottom: 14px;
      height: 42px;
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
      font-weight: 700;
    }
    .bar-fill {
      height: 100%;
      border-radius: 18px;
      display: flex;
      align-items: center;
      font-size: 1.09em;
      padding-left: 1em;
      color: #fff;
      box-sizing: border-box;
      position: relative;
      white-space: nowrap;
      transition: width 0.4s cubic-bezier(.53,1.3,.55,1.0);
      z-index: 2;
    }
    .bar-protein   { background: linear-gradient(90deg, var(--bar-protein) 90%, #96a97a 100%);}
    .bar-fat       { background: linear-gradient(90deg, var(--bar-fat) 85%, #ffe69955 100%);}
    .bar-carbs     { background: linear-gradient(90deg, var(--bar-carbs) 90%, #4067a5 100%);}
    .bar-label {
      position: absolute;
      left: 15px;
      top: 50%; transform: translateY(-50%);
      z-index: 3;
      color: #333;
      font-size: 1.04em;
      text-shadow: 0 1px 6px #fff8;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .bar-value {
      position: absolute;
      right: 16px; top: 50%; transform: translateY(-50%);
      font-size: 1.07em;
      color: #222;
      background: #fff6;
      padding: 2px 11px 2px 10px;
      border-radius: 10px;
      z-index: 4;
      font-weight: 700;
    }
    .bar-goal {
      position: absolute;
      right: 16px; top: 65%;
      font-size: 0.97em;
      color: #444; opacity: .79;
      z-index: 3;
    }
    .entry-list {
      margin: 0 0 1.3rem 0;
      max-height: 185px; overflow-y: auto;
      border-radius: 10px;
      background: #f4f6fa;
      font-size: 1.03em;
      box-shadow: 0 1px 5px #0002;
      padding: 8px 12px;
    }
    .entry-list-item {
      border-bottom: 1px dashed #d0d0e9;
      padding: 5px 0 5px 4px;
      font-size: 0.98em;
    }
    .entry-list-item:last-child {border-bottom: none;}
    .button-row {
      margin: 1.4rem 0 0.3rem 0;
      display: flex; gap: 0.7rem; flex-wrap: wrap;
      justify-content: space-between;
    }
    .mini-btn {
      padding: 0.6em 1.8em;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.04em;
      box-shadow: 0 1px 7px #8bc58a44;
      cursor: pointer;
      transition: background 0.15s;
    }
    .mini-btn:hover, .mini-btn:focus {
      background: #27531f;
    }

    /* Streak Ring */
    .streak-section {
      margin: 1.8rem 0 0 0;
      display: flex; flex-direction: column; align-items: center;
      width: 100%;
      min-height: 90px;
    }
    .ring-svg {
      width: 100px; height: 100px;
      display: block; margin: 0 auto;
    }
    .ring-label {
      font-family: 'Ringbearer','Inter',sans-serif;
      text-align: center;
      font-size: 1.04rem;
      color: var(--accent);
      letter-spacing: 0.5px;
      margin-top: 0.2em;
    }

    .csv-toast {
      position: fixed;
      bottom: 40px;
      left: 50%; transform: translateX(-50%);
      background: #22370f;
      color: #fff;
      padding: 10px 23px;
      border-radius: 20px;
      font-size: 1.09rem;
      box-shadow: 0 2px 10px #000b;
      opacity: 0.95;
      z-index: 99;
      pointer-events: none;
      animation: fadeToast 1.9s linear;
    }
    @keyframes fadeToast {
      0%{opacity:0;} 10%{opacity:1;} 90%{opacity:0.98;} 100%{opacity:0;}
    }

    /* RING MODE OVERRIDES */
    body.ringmode {
      background:
        var(--ring-map) repeat,
        radial-gradient(ellipse at 60% 55%, #fbe62c18 0%, #fbe62c10 20%, #271e05 100%);
      color: #382800;
      --container-bg: #fdfae3;
      --text-color: #473200;
      --accent: #b99d25;
      --bar-protein: #ecd778;
      --bar-fat: #eed49a;
      --bar-carbs: #d3c86d;
      --bar-bg: #faf4d0;
    }
    body.ringmode .container { box-shadow: 0 4px 28px #b2a26744; }
    body.ringmode h1 { color: #b99d25; text-shadow: 0 0 13px #fff7, 0 1px 12px #b99d25cc; }
    body.ringmode .ring-btn { background: #e5c445; color: #322702; }
    body.ringmode .ring-btn.active { background: #fffba8; color: #b99d25; }

    /* Responsive */
    @media (max-width:600px) {
      .container { max-width:100vw; padding:0.8rem 2vw 2.6rem 2vw;}
      h1 { font-size: 1.3rem; }
      .bar-label, .bar-value { font-size: 1em; }
      .bar-goal { font-size: 0.87em;}
      .ring-svg { width: 75px; height: 75px;}
      .streak-section { min-height: 75px;}
    }
  </style>
  <!-- Ringbearer font -->
  <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/ringbearer" />
</head>
<body>
  <div class="container">
    <button class="ring-btn" id="ringBtn" onclick="toggleRingMode()">Ring Mode</button>
    <h1>MacroLegend</h1>
    <form id="macroForm" onsubmit="addMacroEntry(event)">
      <label>Calories</label>
      <input type="number" id="calories" min="0" step="1" required placeholder="e.g. 2200" />
      <label>Protein (g)</label>
      <input type="number" id="protein" min="0" step="1" required placeholder="e.g. 160" />
      <label>Fat (g)</label>
      <input type="number" id="fat" min="0" step="1" required placeholder="e.g. 65" />
      <label>Carbs (g)</label>
      <input type="number" id="carbs" min="0" step="1" required placeholder="e.g. 275" />
      <label>Goal Name</label>
      <input type="text" id="goalName" maxlength="32" placeholder="(optional, e.g. Cut, Bulk)" />
      <button type="submit" class="mini-btn" style="margin-top: 1.2em; width:100%;">Add Entry</button>
    </form>
    <div class="macro-bars" id="macroBars">
      <!-- Progress bars inserted here -->
    </div>
    <div class="button-row">
      <button class="mini-btn" onclick="exportCSV()">Export as CSV</button>
      <button class="mini-btn" onclick="exportTXT()">Export as TXT</button>
      <button class="mini-btn" onclick="clearAll()">Clear All</button>
    </div>
    <div class="entry-list" id="entryList"></div>
    <div class="streak-section">
      <svg class="ring-svg" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="none" stroke="#e1cb7a" stroke-width="8" opacity="0.33"/>
        <circle id="streakRing" cx="50" cy="50" r="45" fill="none" stroke="#b99d25" stroke-width="8" stroke-linecap="round"
          stroke-dasharray="282.74" stroke-dashoffset="0"/>
        <text x="50" y="56" text-anchor="middle" font-size="1.95em" fill="#b99d25" font-family="Ringbearer,Inter,sans-serif" font-weight="700" id="streakNum">0</text>
      </svg>
      <div class="ring-label" id="streakPhrase">"A wizard is never late, nor is he early..."</div>
    </div>
  </div>
  <script>
    // ========== LOTR STREAK PHRASES ==========
    const phrases = [
      "A wizard is never late, nor is he early.",
      "There is some good in this world, and it’s worth fighting for.",
      "Not all those who wander are lost.",
      "Even the smallest person can change the course of the future.",
      "The road goes ever on and on.",
      "Courage is found in unlikely places.",
      "You shall not pass!",
      "One ring to rule them all.",
      "There’s only one Lord of the Ring.",
      "Deeds will not be less valiant because they are unpraised.",
      "The world is indeed full of peril.",
      "All we have to decide is what to do with the time given to us.",
      "I am with you, Samwise Gamgee.",
      "Speak, friend, and enter.",
      "Faithless is he that says farewell when the road darkens.",
      "There’s some good in this world, Mr. Frodo.",
      "A day may come when the courage of men fails.",
      "The hands of a king are the hands of a healer.",
      "Oft hope is born when all is forlorn.",
      "May it be a light for you in dark places.",
      "Go where you must go, and hope!",
      "There is always hope.",
      "The wide world is all about you.",
      "It’s the job that’s never started as takes longest to finish.",
      "Sam will go with you.",
      "The ring has awoken.",
      "Even darkness must pass.",
      "What about second breakfast?",
      "The beacons are lit!",
      "Forth Eorlingas!",
      "Let him be spared. Do not kill him.",
      "Shadowfax! Show us the meaning of haste.",
      "But in the end it’s only a passing thing, this shadow.",
      "The horn of Gondor has not sounded in vain.",
      "You have my sword.",
      "And my bow.",
      "And my axe.",
      "Mithrandir, why the halfling?",
      "I will take the Ring to Mordor.",
      "There’s still time to change the course.",
      "All that is gold does not glitter.",
      "I would rather share one lifetime with you.",
      "For Frodo.",
      "Fly, you fools!",
      "The grey rain-curtain of this world rolls back.",
      "Gollum! Gollum!",
      "You are the luckiest, the canniest, and the most reckless man I ever knew.",
      "The world is changed.",
      "The age of Men is over.",
      "The time of the Orc has come."
    ];

    // ========== APP STATE ==========
    let macroData = [];
    let streakCount = 0;
    let streakLastDate = '';
    let streak = 0;

    // ========== RING MODE ==========
    function toggleRingMode() {
      document.body.classList.toggle('ringmode');
      document.getElementById('ringBtn').classList.toggle('active');
      if (document.body.classList.contains('ringmode')) playRingSound();
    }

    function playRingSound() {
      let audio = document.getElementById('ring-audio');
      if (!audio) {
        audio = document.createElement('audio');
        audio.id = 'ring-audio';
        audio.src = 'https://cdn.pixabay.com/audio/2022/10/16/audio_125b1c4ab8.mp3'; // Epic choir
        audio.volume = 0.25;
        document.body.appendChild(audio);
      }
      audio.currentTime = 0;
      audio.play();
    }

    // ========== MACRO INPUT ==========
    function addMacroEntry(e) {
      e.preventDefault();
      const cal = parseInt(document.getElementById('calories').value) || 0;
      const p = parseInt(document.getElementById('protein').value) || 0;
      const f = parseInt(document.getElementById('fat').value) || 0;
      const c = parseInt(document.getElementById('carbs').value) || 0;
      const goal = (document.getElementById('goalName').value || '').trim();
      const date = new Date().toISOString().split('T')[0];

      if (cal <= 0 || p < 0 || f < 0 || c < 0) return;
      macroData.push({date,cal,p,f,c,goal});
      if (macroData.length > 50) macroData = macroData.slice(-50); // Limit entries
      localStorage.setItem('macroData',JSON.stringify(macroData));
      updateMacros();

      // Streak logic: if last entry was yesterday, continue; if today, keep streak; else reset
      let lastDate = streakLastDate || localStorage.getItem('streakLastDate') || '';
      if (lastDate && lastDate !== date) {
        let last = new Date(lastDate);
        let today = new Date(date);
        let diff = Math.round((today - last)/(1000*60*60*24));
        if (diff === 1) streak++;
        else if (diff === 0) {/* same day, keep streak */}
        else streak = 1;
      } else if (!lastDate) {
        streak = 1;
      }
      streakLastDate = date;
      localStorage.setItem('streak', streak);
      localStorage.setItem('streakLastDate', date);
      updateStreak();
      document.getElementById('macroForm').reset();
    }

    function updateMacros() {
      // Show the last entry as current target
      let last = macroData.length ? macroData[macroData.length-1] : {cal:0,p:0,f:0,c:0,goal:""};
      let sumCal = 0, sumP=0, sumF=0, sumC=0;
      macroData.forEach(e => {sumCal+=e.cal; sumP+=e.p; sumF+=e.f; sumC+=e.c;});

      // Bars
      let bars = [
        {label:"Protein", val: last.p, goal: last.cal ? Math.round(last.cal*0.3/4) : 0, color:"bar-protein"},
        {label:"Fat",    val: last.f, goal: last.cal ? Math.round(last.cal*0.25/9) : 0, color:"bar-fat"},
        {label:"Carbs",  val: last.c, goal: last.cal ? Math.round(last.cal*0.45/4) : 0, color:"bar-carbs"},
      ];
      let html = bars.map(b=>`
        <div class="macro-bar">
          <span class="bar-label">${b.label}</span>
          <div class="bar-fill ${b.color}" style="width:${Math.min(100,b.goal?b.val/b.goal*100:0)}%">
            ${b.val}g
          </div>
          <span class="bar-value">${b.val}/${b.goal}g</span>
        </div>
      `).join('');
      document.getElementById('macroBars').innerHTML = html;

      // History
      let entries = macroData.slice(-10).map(e=>
        `<div class="entry-list-item">
          <b>${e.date}</b> — Cal: ${e.cal}, P: ${e.p}, F: ${e.f}, C: ${e.c}
          ${e.goal?`<span style="color:#777;font-size:0.98em">(${e.goal})</span>`:""}
        </div>`
      ).reverse().join('');
      document.getElementById('entryList').innerHTML = entries;
    }

    // ========== EXPORT ==========
    function exportCSV() {
      if (!macroData.length) return showToast("No data to export");
      let csv = "Date,Calories,Protein,Fat,Carbs,Goal\n" + macroData.map(
        e => [e.date,e.cal,e.p,e.f,e.c,e.goal].join(",")
      ).join("\n");
      let blob = new Blob([csv],{type:'text/csv'});
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url; a.download = "macrolegend.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      showToast('Exported CSV!');
    }
    function exportTXT() {
      if (!macroData.length) return showToast("No data to export");
      let txt = macroData.map(e=>
        `${e.date}: Cal ${e.cal}, Protein ${e.p}g, Fat ${e.f}g, Carbs ${e.c}g${e.goal?` (${e.goal})`:""}`
      ).join("\n");
      let blob = new Blob([txt],{type:'text/plain'});
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url; a.download = "macrolegend.txt";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      showToast('Exported TXT!');
    }

    // ========== CLEAR ==========
    function clearAll() {
      if (!confirm('Clear all macro data and streak?')) return;
      macroData = [];
      streak = 0;
      streakLastDate = '';
      localStorage.removeItem('macroData');
      localStorage.removeItem('streak');
      localStorage.removeItem('streakLastDate');
      updateMacros();
      updateStreak();
    }

    // ========== STREAK DISPLAY ==========
    function updateStreak() {
      let streakNum = streak || parseInt(localStorage.getItem('streak')||"0");
      let phraseIdx = (streakNum-1) % phrases.length;
      document.getElementById('streakNum').textContent = streakNum||"0";
      document.getElementById('streakPhrase').textContent = phrases[phraseIdx] || "";
      // Animate ring
      let ring = document.getElementById('streakRing');
      let max = 52; // "weeks in a year" scale
      let frac = Math.min(1,streakNum/max);
      ring.setAttribute('stroke-dashoffset', 282.74 * (1-frac));
    }

    // ========== TOAST ==========
    function showToast(msg) {
      let toast = document.createElement('div');
      toast.className = 'csv-toast';
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 1800);
    }

    // ========== INIT ==========
    window.onload = function() {
      macroData = JSON.parse(localStorage.getItem('macroData')||"[]");
      streak = parseInt(localStorage.getItem('streak')||"0");
      streakLastDate = localStorage.getItem('streakLastDate')||"";
      updateMacros();
      updateStreak();
    }
  </script>
</body>
</html>
