<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroLegend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root {
      --light-bg: #f6f6fa;
      --light-card: #fff;
      --light-text: #1a1a1a;
      --light-accent: #2b78e4;
      --light-bar: #d6eaff;
      --light-shadow: 0 4px 32px #0002;
      --gold: #fbe62c;
      --ring-shadow: 0 0 18px 6px #edb94144;
      --ring-bar: #f8c944;
      --ring-green: #7dc271;
      --ring-blue: #5ba4fa;
      --ring-orange: #f5a94d;
      --ring-bg: #e9d8b2;
      --ring-card: #f8f0da;
      --ring-txt: #62513a;
      --ring-inscription: #bd8c19;
      --progress-radius: 13px;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0; min-height: 100vh;
      background: var(--light-bg);
      color: var(--light-text);
      display: flex; flex-direction: column; align-items: center;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      background: var(--light-card);
      box-shadow: var(--light-shadow);
      border-radius: 22px;
      max-width: 480px; width: 100vw;
      margin: 2vw 0 10vw 0;
      padding: 2.5em 1.6em 2.8em 1.6em;
      transition: background 0.3s;
      position: relative; min-width: 0;
    }
    h1 {
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 2.05rem;
      letter-spacing: 2px;
      margin-bottom: 1em;
      margin-top: 0.7em;
      text-align: center;
      color: var(--light-accent);
      transition: color 0.3s, text-shadow 0.3s;
      user-select: none;
      z-index: 2;
    }
    .theme-toggle {
      position: absolute;
      left: 28px; top: 32px;
      display: flex; gap: 9px;
      z-index: 10;
    }
    .theme-btn {
      background: var(--light-bar);
      border: none;
      border-radius: 18px;
      padding: 7px 22px;
      font-size: 1.07rem;
      color: var(--light-accent);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 7px #0001;
      margin-left: 0px;
      transition: background 0.2s, color 0.2s;
    }
    .theme-btn.active, .theme-btn:focus {
      background: var(--gold);
      color: #3b2e08;
      outline: none;
    }
    /* Tab row */
    .tab-row {
      display: flex; justify-content: center;
      gap: 11px; margin: 0 0 1.7em 0;
    }
    .tab-btn {
      background: #eceefe; color: #4275ba;
      border: none; border-radius: 12px 12px 0 0;
      padding: 10px 33px; font-weight: 700; font-size: 1.13em;
      cursor: pointer; box-shadow: 0 2px 7px #0001;
      transition: background 0.17s, color 0.17s;
    }
    .tab-btn.active, .tab-btn:focus {
      background: var(--light-accent);
      color: #fff;
    }
    .ringmode .tab-btn {
      background: #f5e8c6;
      color: #a18436;
    }
    .ringmode .tab-btn.active { background: #fbe62c; color: #382a00; }
    /* Macro goal line */
    .goal-line {
      font-size: 1.15em; color: #4c4c4c; background: #f6f6fa;
      border-radius: 13px; margin: 0 auto 1.3em auto; text-align: center;
      padding: 0.43em 1.1em; font-weight: 500; letter-spacing: 0.7px;
      display: flex; justify-content: center; gap: 2em; flex-wrap: wrap;
      max-width: 99vw; white-space: nowrap;
    }
    .goal-line span { font-weight: 700; letter-spacing: 0.2px; padding: 0 2px; }
    .goal-macro-p { color: #49a858; }
    .goal-macro-c { color: #3677c6; }
    .goal-macro-f { color: #e8a200; }
    .goal-macro-cal { color: #d4b117; }
    /* Progress bars */
    .macro-bars { margin-bottom: 1.2em; margin-top: 1em; display: flex; flex-direction: column; gap: 1.1em;}
    .macro-bar-outer { background: var(--light-bar); border-radius: var(--progress-radius); overflow: hidden; position: relative; height: 38px; margin: 0 0.1em;}
    .macro-bar-inner { height: 100%; display: flex; align-items: center; font-weight: 600; font-size: 1.17em; justify-content: flex-start; padding-left: 14px; border-radius: var(--progress-radius); transition: width 0.45s cubic-bezier(.35,1.65,.6,1.1); color: #fff; letter-spacing: 0.5px; text-shadow: 0 1px 8px #0004; white-space: nowrap; position: relative;}
    .bar-cal { background: linear-gradient(90deg,#fbe62c,#f5c80f); color: #735900; }
    .bar-p { background: linear-gradient(90deg,#51c16e,#379956); }
    .bar-c { background: linear-gradient(90deg,#61aaff,#396ebb); }
    .bar-f { background: linear-gradient(90deg,#f5a94d,#d1850b); }
    .macro-bar-label { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 1em; font-weight: 700; text-shadow: 0 1px 4px #0006; width: 100%; text-align: center; pointer-events: none; letter-spacing: 0.5px; z-index: 2;}
    /* Meal log table */
    .meal-log-table { width: 100%; margin-bottom: 0.6em; border-collapse: collapse; font-size: 1.08em; background: #fff; border-radius: 10px; box-shadow: 0 1px 8px #0001; overflow-x: auto;}
    .meal-log-table th, .meal-log-table td { padding: 10px 9px; border: none; text-align: center; white-space: nowrap; font-size: 1em;}
    .meal-log-table th { background: #f2f6fc; color: #5179c2; font-weight: 700;}
    .meal-log-table tbody tr:nth-child(even) { background: #f7faff;}
    /* Export buttons */
    .export-row { display: flex; gap: 0.8em; justify-content: flex-end; margin-bottom: 0.5em;}
    .export-btn { background: #e9eef6; color: #2b78e4; font-size: 0.99em; padding: 7px 23px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin: 0; box-shadow: 0 1px 3px #0001; transition: background 0.13s, color 0.13s;}
    .export-btn:hover, .export-btn:focus { background: #d6eaff; color: #0c51a4;}
    /* Streak ring area */
    .streak-ring-wrap { margin: 0 auto; margin-top: 2.2em; width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; position: relative; transition: filter 0.3s;}
    .streak-ring-svg { width: 100%; height: 100%; display: block; filter: drop-shadow(var(--ring-shadow)); }
    .streak-center-label { position: absolute; left: 50%; top: 53%; transform: translate(-50%,-50%); width: 110px; text-align: center; color: var(--ring-txt); font-family: 'Ringbearer', 'Inter', serif; font-size: 1.31em; line-height: 1.14; font-weight: 700; text-shadow: 0 0 11px #edb941c5, 0 1px 2px #000c; pointer-events: none;}
    .streak-bar-wrap { width: 100%; max-width: 390px; margin: 2em auto 1em auto; background: #d6eaff; border-radius: 16px; box-shadow: 0 1px 4px #0001; padding: 1em 1.3em; font-size: 1.21em; color: #2b78e4; font-weight: 700; letter-spacing: 1px; display: flex; align-items: center; gap: 23px; justify-content: center;}
    .streak-bar-value { background: #2b78e4; color: #fff; border-radius: 14px; padding: 4.5px 18px; margin: 0 13px; font-size: 1em; font-weight: 700; box-shadow: 0 2px 6px #2b78e411;}
    .quote-box {
      margin: 2.1em auto 0.9em auto;
      background: #f8f6e6;
      border-radius: 15px;
      box-shadow: 0 1px 10px #0001;
      color: #8a7421;
      font-family: 'Ringbearer','Inter',serif;
      font-size: 1.13em;
      text-align: center;
      padding: 1.05em 0.9em;
      letter-spacing: 0.5px;
      min-height: 35px;
      max-width: 380px;
      border: 1px solid #e9d8b2;
    }
    .ringmode .quote-box {
      background: #efe3c4;
      color: #a28209;
      border: 2.3px solid #d9c396;
    }
    /* Input areas */
    .macro-input-row { display: flex; gap: 1em; flex-wrap: wrap; justify-content: center; margin-bottom: 1.7em;}
    .macro-input { flex: 1 1 37%; min-width: 95px; max-width: 150px; font-size: 1.13em; padding: 14px 13px; margin: 0 0 9px 0; border-radius: 11px; border: 1.2px solid #b6c6e1; background: #f6faff; color: #1a2a2a; box-shadow: 0 2px 5px #b6d4fa11; outline: none; transition: border 0.15s;}
    .macro-input:focus { border: 1.2px solid #2b78e4; }
    /* Add meal row */
    .add-meal-row { display: flex; gap: 0.8em; flex-wrap: wrap; margin-bottom: 1.3em; justify-content: center; align-items: flex-end;}
    .meal-name-input, .meal-amt-input { font-size: 1.08em; border-radius: 9px; padding: 11px 13px; border: 1.2px solid #c0c9db; outline: none; background: #f7fafc; color: #252525; box-shadow: 0 1px 2px #c7e3fa11; transition: border 0.16s;}
    .meal-name-input:focus, .meal-amt-input:focus { border: 1.2px solid #49a858; }
    .add-meal-btn, .scan-btn {
      background: #2b78e4; color: #fff; border: none; border-radius: 10px; font-weight: 700;
      padding: 11px 20px; font-size: 1.05em; cursor: pointer; margin-left: 4px; box-shadow: 0 2px 6px #0002;
      transition: background 0.16s, color 0.16s;
      display: flex; align-items: center; gap: 0.5em;
    }
    .add-meal-btn:hover, .add-meal-btn:focus,
    .scan-btn:hover, .scan-btn:focus { background: #49a858; color: #fff;}
    .scan-btn { background: #fbe62c; color: #382a00; font-weight: 800; padding: 11px 12px;}
    .scan-btn svg {width:1.4em;height:1.4em;vertical-align:middle;}
    /* Toast popup */
    .toast {
      position: fixed; left: 50%; bottom: 36px; transform: translateX(-50%);
      background: #fffbe0; color: #2b78e4;
      padding: 13px 36px; border-radius: 22px;
      box-shadow: 0 5px 22px #0006; font-size: 1.15em; font-weight: 700;
      opacity: 0.97; z-index: 999; pointer-events: none; animation: fadeToast 2.2s linear;
    }
    @keyframes fadeToast {
      0%{opacity:0;}
      10%{opacity:1;}
      85%{opacity:0.98;}
      100%{opacity:0;}
    }
    /* Autocomplete dropdown */
    .autocomplete-list {
      position: absolute;
      background: #fff8e1;
      border: 1.5px solid #eed177;
      border-radius: 11px;
      z-index: 101;
      max-height: 250px;
      overflow-y: auto;
      width: 340px;
      left: 50%;
      transform: translateX(-50%);
      top: 110%;
      box-shadow: 0 6px 24px #0002;
      padding: 4px 0;
    }
    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      font-size: 1.08em;
      border-bottom: 1px solid #f7e8ad;
      color: #654312;
      transition: background 0.13s;
    }
    .autocomplete-item:last-child { border-bottom: none;}
    .autocomplete-item:hover, .autocomplete-item.active {
      background: #edb94144;
      color: #2e2208;
      font-weight: 700;
    }
    /* Ring Mode! */
    .ringmode body, .ringmode {
      background: var(--ring-bg) !important;
      color: var(--ring-txt) !important;
      transition: background 0.4s, color 0.3s;
    }
    .ringmode {
      /* Subtle crinkled parchment/map texture overlay: */
      background-image: url('https://www.transparenttextures.com/patterns/old-mathematics.png'), linear-gradient(120deg, #f5ecd2 0%, #e1d0a7 100%);
      background-blend-mode: multiply;
    }
    .ringmode .container {
      background: var(--ring-card) !important;
      color: var(--ring-txt) !important;
      box-shadow: 0 4px 32px #5c4b0a99;
      background-image: url('https://www.transparenttextures.com/patterns/old-mathematics.png'), linear-gradient(120deg, #f7e7c4 0%, #e9d8b2 100%);
      background-size: 450px, cover;
      background-repeat: repeat, no-repeat;
      background-position: left top, center top;
    }
    .ringmode .goal-line, .ringmode .meal-log-table th, .ringmode .macro-bar-label {
      background: #efe3c4 !important;
      color: #b68b13 !important;
    }
    .ringmode .macro-bar-outer { background: #d1b773 !important; }
    .ringmode .bar-cal { background: linear-gradient(90deg,#fbe62c,#cfa211) !important; color: #5d4b04;}
    .ringmode .bar-p { background: linear-gradient(90deg,#7dc271,#3b7f2d);}
    .ringmode .bar-c { background: linear-gradient(90deg,#5ba4fa,#30426e);}
    .ringmode .bar-f { background: linear-gradient(90deg,#f5a94d,#ad7a1d);}
    .ringmode .macro-bar-label { color: #fff9db !important;}
    .ringmode .streak-bar-wrap { background: #f2e7c2 !important; color: #b68b13 !important;}
    .ringmode .export-btn { background: #f5e8c6; color: #b68b13;}
    .ringmode .theme-btn { background: #fbe62c; color: #3b2e08;}
    .ringmode .theme-btn.active { background: #fff; color: #a28907;}
    .ringmode .meal-log-table th { color: #edb941;}
    .ringmode .meal-log-table { background: #f9f3e4; }
    .ringmode .meal-log-table td { color: #6c541c;}
    /* Responsive improvements */
    @media (max-width: 600px) {
      .container { padding: 0.8em 2vw 2em 2vw; border-radius: 0; }
      .macro-input-row, .add-meal-row { flex-direction: column; gap: 0.7em; }
      .tab-row { gap: 2vw; }
      .streak-ring-wrap { width: 61vw; height: 61vw; max-width: 175px; max-height: 175px;}
      .streak-center-label { width: 50vw; max-width: 112px; font-size: 1em;}
      .meal-log-table { font-size: 0.95em; }
      .autocomplete-list { width: 90vw; left: 50%; }
    }
  </style>
</head>
<body>
  <div class="container" id="macroLegendContainer">
    <div class="theme-toggle">
      <button class="theme-btn active" id="appleLightBtn" onclick="setTheme('light')">Apple Light</button>
      <button class="theme-btn" id="ringModeBtn" onclick="setTheme('ring')">Ring Mode</button>
    </div>
    <h1>MacroLegend</h1>
    <div class="tab-row">
      <button class="tab-btn active" id="tabCalc" onclick="showTab('calc')">Calculator</button>
      <button class="tab-btn" id="tabProg" onclick="showTab('prog')">Progression</button>
    </div>
    <div id="tabArea"></div>
    <audio id="streakSound" preload="auto">
      <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
    </audio>
    <video id="barcodeVideo" autoplay playsinline style="display:none;"></video>
    <div id="barcodeOverlay" style="display:none;"></div>
    <button id="barcodeCancelBtn" onclick="stopBarcodeScan()" style="display:none;">Cancel Scan</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script>
    // ========== PHRASES ========== //
    const lotrQuotes = [
      "Even the smallest person can change the course of the future.",
      "Not all those who wander are lost.",
      "The road goes ever on and on.",
      "Deeds will not be less valiant because they are unpraised.",
      "Faithless is he that says farewell when the road darkens.",
      "All we have to decide is what to do with the time that is given us.",
      "There’s some good in this world, and it’s worth fighting for.",
      "I am glad you are here with me. Here at the end of all things.",
      "The world is indeed full of peril, and in it there are many dark places.",
      "A wizard is never late, nor is he early, he arrives precisely when he means to.",
      "You shall not pass!",
      "Courage is found in unlikely places.",
      "The shadow is only a passing thing.",
      "Hope remains while the Company is true.",
      "The board is set, the pieces are moving.",
      "One does not simply walk into Mordor.",
      "I would rather share one lifetime with you than face all the ages of this world alone.",
      "May it be a light to you in dark places, when all other lights go out.",
      "It's a dangerous business, going out your door.",
      "The wise speak only of what they know.",
      "Many that live deserve death. And some that die deserve life.",
      "Even darkness must pass. A new day will come.",
      "The strength of the ring-bearer is in his heart.",
      "There’s always hope.",
      "For Frodo.",
      "The journey doesn’t end here.",
      "I am no man!",
      "The Ring has awoken.",
      "Speak, friend, and enter.",
      "There and back again.",
      "Let him not vow to walk in the dark, who has not seen the nightfall.",
      "Renewed shall be blade that was broken.",
      "I will take the Ring, though I do not know the way.",
      "A day may come when the courage of men fails… but it is not this day.",
      "My friends, you bow to no one.",
      "White shores, and beyond, a far green country under a swift sunrise.",
      "You have my sword.",
      "The Shire must truly be a great place.",
      "If by my life or death I can protect you, I will.",
      "End? No, the journey doesn't end here.",
      "Where there's life, there's hope.",
      "It’s the job that’s never started as takes longest to finish.",
      "But in the end, it’s only a passing thing, this shadow.",
      "I can't carry it for you, but I can carry you!",
      "The hands of a king are the hands of a healer.",
      "Shadowfax, show us the meaning of haste.",
      "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
      "Mithrandir, why did you leave us?",
      "You shall be the Fellowship of the Ring.",
      "I will not say: do not weep; for not all tears are an evil.",
      "The fire of your heart outshines the darkness.",
      "May your path be green and the breeze on your back.",
      "Streaks are for heroes. Today you are legend.",
      "Let the courage of the Eldar guide you.",
    ];
    const genericQuotes = [
      "Believe you can and you're halfway there.",
      "Success is not final; failure is not fatal.",
      "Little by little, a little becomes a lot.",
      "Stay hungry. Stay foolish.",
      "Every moment is a fresh beginning.",
      "Start where you are. Use what you have. Do what you can.",
      "Great things never came from comfort zones.",
      "If opportunity doesn't knock, build a door.",
      "Quality is not an act, it is a habit.",
      "The secret of getting ahead is getting started.",
      "Hustle in silence and let your success make the noise.",
      "Dream big and dare to fail.",
      "Progress, not perfection.",
      "You don’t have to be great to start, but you have to start to be great.",
      "Focus on the step in front of you, not the whole staircase.",
      "Don’t let yesterday take up too much of today.",
      "Small steps every day.",
      "The only limit to our realization of tomorrow is our doubts of today.",
      "Turn your wounds into wisdom.",
      "Don’t watch the clock; do what it does. Keep going.",
      "No pressure, no diamonds.",
      "Embrace the glorious mess that you are.",
      "Fall seven times, stand up eight.",
      "Wherever you go, go with all your heart.",
      "Start each day with a grateful heart.",
      "Big journeys begin with small steps.",
      "Never give up on something you really want.",
      "Let your dreams be bigger than your fears.",
      "Push yourself, because no one else is going to do it for you.",
      "Make today amazing.",
      "Nothing will work unless you do.",
      "If it matters to you, you’ll find a way.",
      "Stay patient and trust your journey.",
      "Progress is progress, no matter how small.",
      "You are your only limit.",
      "Create the life you can’t wait to wake up to.",
      "Do something today your future self will thank you for.",
      "No rain, no flowers.",
      "Take the risk or lose the chance.",
      "Just keep swimming.",
      "Make it happen.",
      "Doubt kills more dreams than failure ever will.",
      "Start now, not tomorrow.",
      "Somewhere, something incredible is waiting to be known.",
      "Be somebody nobody thought you could be.",
      "Grow through what you go through.",
      "If you get tired, learn to rest, not to quit.",
      "You got this.",
      "The best time for new beginnings is now.",
      "Life is tough, but so are you.",
    ];
    // ========== STATE ========== //
    let macroGoals = {calories: 2000, protein: 150, carbs: 200, fat: 70};
    let macroTotals = {calories: 0, protein: 0, carbs: 0, fat: 0};
    let mealLog = [];
    let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
    try {
      if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
      if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
      if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
    } catch (e) {}
    let autocompleteTimeout = null;
    let autocompleteResults = [];
    let chart;
    // ========== THEME ========== //
    function setTheme(theme) {
      const body = document.body;
      const cont = document.getElementById('macroLegendContainer');
      if (theme === 'ring') {
        body.classList.add('ringmode');
        cont.classList.add('ringmode');
        document.getElementById('appleLightBtn').classList.remove('active');
        document.getElementById('ringModeBtn').classList.add('active');
      } else {
        body.classList.remove('ringmode');
        cont.classList.remove('ringmode');
        document.getElementById('appleLightBtn').classList.add('active');
        document.getElementById('ringModeBtn').classList.remove('active');
      }
      renderAll();
    }
    setTheme('light');
    // ========== TAB SYSTEM ========== //
    function showTab(tab) {
      document.getElementById('tabCalc').classList.remove('active');
      document.getElementById('tabProg').classList.remove('active');
      if (tab === 'calc') document.getElementById('tabCalc').classList.add('active');
      else document.getElementById('tabProg').classList.add('active');
      renderTab(tab);
    }
    function renderTab(tab) {
      if (tab === 'calc') renderCalculatorTab();
      else renderProgressionTab();
    }
    // ========== MACRO CALCULATOR TAB ========== //
    function renderCalculatorTab() {
      document.getElementById('tabArea').innerHTML = `
      <form onsubmit="setGoalsFromInputs(event)" class="macro-input-row">
        <input class="macro-input" id="inputWeight" type="number" min="70" placeholder="Weight (lbs)">
        <input class="macro-input" id="inputHeight" type="number" min="48" placeholder="Height (in)">
        <input class="macro-input" id="inputAge" type="number" min="8" max="99" placeholder="Age">
        <select class="macro-input" id="inputGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <select class="macro-input" id="inputActivity">
          <option value="1.2">Sedentary</option>
          <option value="1.375">Light (1-3 days/wk)</option>
          <option value="1.55">Moderate (3-5 days/wk)</option>
          <option value="1.725">Active (6-7 days/wk)</option>
          <option value="1.9">Very Active</option>
        </select>
        <select class="macro-input" id="inputGoal">
          <option value="maintain">Maintain</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
        <button class="add-meal-btn" style="min-width:99px" type="submit">Set Macros</button>
      </form>
      <div style="color:#687; font-size:1em;text-align:center; margin-bottom:1.7em">
        Use the calculator to estimate daily calorie/macros.<br>
        <span style="color:#4275ba;font-weight:600;">Your settings transfer to Progression tab instantly.</span>
      </div>
      <div class="macro-input-row" style="gap:0.5em;">
        <input class="macro-input" id="goalCalories" type="number" min="0" placeholder="Goal Calories">
        <input class="macro-input" id="goalProtein" type="number" min="0" placeholder="Goal Protein (g)">
        <input class="macro-input" id="goalCarbs" type="number" min="0" placeholder="Goal Carbs (g)">
        <input class="macro-input" id="goalFat" type="number" min="0" placeholder="Goal Fat (g)">
        <button class="add-meal-btn" style="min-width:97px" onclick="saveGoalInputs()" type="button">Update Goal</button>
      </div>
      `;
      document.getElementById('goalCalories').value = macroGoals.calories;
      document.getElementById('goalProtein').value = macroGoals.protein;
      document.getElementById('goalCarbs').value = macroGoals.carbs;
      document.getElementById('goalFat').value = macroGoals.fat;
    }
    // CALCULATOR ACTIONS
    function setGoalsFromInputs(e) {
      e.preventDefault();
      let w = Number(document.getElementById('inputWeight').value);
      let h = Number(document.getElementById('inputHeight').value);
      let a = Number(document.getElementById('inputAge').value);
      let g = document.getElementById('inputGender').value;
      let act = Number(document.getElementById('inputActivity').value);
      let goal = document.getElementById('inputGoal').value;
      if (!w || !h || !a) return showToast("Fill in all fields!");
      let bmr = (g==="male")
        ? 66 + (6.23 * w) + (12.7 * h) - (6.8 * a)
        : 655 + (4.35 * w) + (4.7 * h) - (4.7 * a);
      let tdee = bmr * act;
      let cal = tdee;
      if (goal === "lose") cal -= 500;
      if (goal === "gain") cal += 300;
      macroGoals.calories = Math.round(cal);
      macroGoals.protein = Math.round(w*0.8);
      macroGoals.carbs = Math.round((cal*0.45)/4);
      macroGoals.fat = Math.round((cal*0.25)/9);
      saveData(); renderAll();
      showToast("Goals updated!");
    }
    function saveGoalInputs() {
      macroGoals.calories = Number(document.getElementById('goalCalories').value)||0;
      macroGoals.protein = Number(document.getElementById('goalProtein').value)||0;
      macroGoals.carbs = Number(document.getElementById('goalCarbs').value)||0;
      macroGoals.fat = Number(document.getElementById('goalFat').value)||0;
      saveData(); renderAll();
      showToast("Macros saved!");
    }
    // ========== PROGRESSION TAB ========== //
    function renderProgressionTab() {
      document.getElementById('tabArea').innerHTML = `
      <div class="goal-line" id="goalLine"></div>
      <div class="macro-bars" id="macroBars"></div>
      <form onsubmit="addMeal(event)" class="add-meal-row" id="addMealForm" autocomplete="off">
        <div style="position:relative;width:100%;">
          <input class="meal-name-input" id="mealName" placeholder="Meal name/food" autocomplete="off" required>
          <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
        </div>
        <input class="meal-amt-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
        <input class="meal-amt-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
        <input class="meal-amt-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
        <input class="meal-amt-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
        <button class="add-meal-btn" type="submit">+ Add</button>
        <button type="button" class="scan-btn" onclick="scanBarcode()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><rect x="16" y="16" width="5" height="5"/><path d="M9 5h6M19 9v6M5 9v6M9 19h6"/></svg>
        </button>
      </form>
      <table class="meal-log-table" id="mealLogTable"></table>
      <div class="export-row">
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="exportTXT()">Export TXT</button>
        <button class="export-btn" onclick="window.print()">Print / PDF</button>
      </div>
      <div id="streakArea"></div>
      <div class="quote-box" id="quoteBox"></div>
      `;
      renderGoalLine();
      renderMacroBars();
      renderMealLog();
      renderStreak();
      renderQuote();
      attachAutocompleteEvents();
    }
    // ========== MACRO PROGRESS ========== 
    function renderGoalLine() {
      const {calories, protein, carbs, fat} = macroGoals;
      document.getElementById('goalLine').innerHTML =
        `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
         <span class="goal-macro-p">P: <b>${protein}g</b></span>
         <span class="goal-macro-c">C: <b>${carbs}g</b></span>
         <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
    }
    function renderMacroBars() {
      const {calories, protein, carbs, fat} = macroGoals;
      const t = macroTotals;
      function pct(val, goal) { return Math.min(100, Math.round(100 * val/goal)); }
      document.getElementById('macroBars').innerHTML = `
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories,calories)}%">
            <span class="macro-bar-label">${t.calories}/${calories} kcal</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-p" style="width:${pct(t.protein,protein)}%">
            <span class="macro-bar-label">${t.protein}/${protein}g Protein</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs,carbs)}%">
            <span class="macro-bar-label">${t.carbs}/${carbs}g Carbs</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-f" style="width:${pct(t.fat,fat)}%">
            <span class="macro-bar-label">${t.fat}/${fat}g Fat</span>
          </div>
        </div>
      `;
    }
    // ========== MEAL LOG ========== 
    function addMeal(e) {
      e.preventDefault();
      const name = document.getElementById('mealName').value.trim();
      const calories = Number(document.getElementById('mealCalories').value);
      const protein = Number(document.getElementById('mealProtein').value) || 0;
      const carbs = Number(document.getElementById('mealCarbs').value) || 0;
      const fat = Number(document.getElementById('mealFat').value) || 0;
      if (!name || !calories) return showToast("Enter meal name and calories!");
      mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
      saveData();
      document.getElementById('mealName').value = '';
      document.getElementById('mealCalories').value = '';
      document.getElementById('mealProtein').value = '';
      document.getElementById('mealCarbs').value = '';
      document.getElementById('mealFat').value = '';
      document.getElementById('autocompleteList').style.display = 'none';
      renderAll();
      checkStreak();
      showToast("Meal added!");
    }
    function renderMealLog() {
      let rows = mealLog.map((m,i) =>
        `<tr>
          <td>${m.name}</td>
          <td>${m.calories}</td>
          <td>${m.protein}</td>
          <td>${m.carbs}</td>
          <td>${m.fat}</td>
          <td><button onclick="removeMeal(${i})" style="color:#e34747;font-weight:700;font-size:0.93em;border:none;background:none;cursor:pointer;">✕</button></td>
        </tr>`
      ).join('');
      document.getElementById('mealLogTable').innerHTML = `
        <thead>
          <tr>
            <th>Meal</th>
            <th>Cal</th>
            <th>P</th>
            <th>C</th>
            <th>F</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }
    function removeMeal(idx) {
      mealLog.splice(idx,1);
      saveData();
      renderAll();
      showToast("Meal removed.");
    }
    // ========== MACRO TOTALS ========== //
    function updateTotals() {
      macroTotals = {calories:0,protein:0,carbs:0,fat:0};
      mealLog.forEach(m=>{
        macroTotals.calories += Number(m.calories)||0;
        macroTotals.protein += Number(m.protein)||0;
        macroTotals.carbs += Number(m.carbs)||0;
        macroTotals.fat += Number(m.fat)||0;
      });
    }
    // ========== STREAK ========== //
    function checkStreak() {
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10);
      if (streak.lastDate !== todayStr) {
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate()-1);
        const ystr = yesterday.toISOString().slice(0,10);
        if (streak.lastDate === ystr) {
          streak.days += 1;
          if (streak.days > streak.best) {
            streak.best = streak.days;
            playStreakSound();
          }
        } else {
          streak.days = 1;
        }
        streak.lastDate = todayStr;
        streak.weekPhrase = ((streak.days-1) % 52);
        saveData();
        renderStreak();
        renderQuote();
      }
    }
    function renderStreak() {
      const streakArea = document.getElementById('streakArea');
      const isRing = document.body.classList.contains('ringmode');
      if (isRing) {
        streakArea.innerHTML = `
        <div class="streak-ring-wrap">
          <svg class="streak-ring-svg" width="140" height="140" viewBox="0 0 140 140">
            <defs>
              <radialGradient id="gold" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#fff9c9"/>
                <stop offset="65%" stop-color="#edb941"/>
                <stop offset="100%" stop-color="#a28209"/>
              </radialGradient>
            </defs>
            <circle cx="70" cy="70" r="58" fill="url(#gold)" stroke="#d4b117" stroke-width="7"/>
            <text x="70" y="70" text-anchor="middle" fill="#bd8c19" font-family="Ringbearer, serif"
              font-size="13" font-weight="bold" dy="10" letter-spacing="2">
              ${streak.days}
            </text>
          </svg>
          <div class="streak-center-label">
            Streak<br>
            <span style="font-size:1.65em;letter-spacing:2px;">${streak.days}</span>
            <br>Best: <b>${streak.best}</b>
          </div>
        </div>
        `;
      } else {
        streakArea.innerHTML = `
          <div class="streak-bar-wrap">
            Streak
            <span class="streak-bar-value">${streak.days}</span>
            | Best: <span class="streak-bar-value">${streak.best}</span>
          </div>
        `;
      }
    }
    function playStreakSound() {
      if (document.body.classList.contains('ringmode')) {
        try {
          document.getElementById('streakSound').currentTime = 0;
          document.getElementById('streakSound').play();
        } catch (e) {}
      }
    }
    // ========== MOTIVATION QUOTES ========== //
    function renderQuote() {
      const isRing = document.body.classList.contains('ringmode');
      const idx = streak.weekPhrase % 52;
      const quote = isRing ? lotrQuotes[idx] : genericQuotes[idx % genericQuotes.length];
      document.getElementById('quoteBox').innerText = `"${quote}"`;
    }
    // ========== DATA STORAGE ========== //
    function saveData() {
      localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
      localStorage.setItem('mealLog', JSON.stringify(mealLog));
      localStorage.setItem('streak', JSON.stringify(streak));
    }
    // ========== EXPORT ========== //
    function exportCSV() {
      let csv = "Meal,Calories,Protein,Carbs,Fat\n";
      mealLog.forEach(m=>{
        csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
      });
      download(csv, "macrolegend.csv");
    }
    function exportTXT() {
      let txt = "MacroLegend Log\n==================\n";
      mealLog.forEach(m=>{
        txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
      });
      download(txt, "macrolegend.txt");
    }
    function download(content, filename) {
      const a = document.createElement('a');
      const file = new Blob([content], {type: 'text/plain'});
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }
    // ========== TOAST POPUP ========== //
    function showToast(msg) {
      const el = document.createElement('div');
      el.className = 'toast'; el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2100);
    }
    // ========== BARCODE SCANNER ========== //
    let scanning = false;
    function scanBarcode() {
      if (scanning) return;
      scanning = true;
      document.getElementById('barcodeVideo').style.display = 'block';
      document.getElementById('barcodeOverlay').style.display = 'block';
      document.getElementById('barcodeCancelBtn').style.display = 'block';
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcodeVideo'),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader", "ean_13_reader","upc_reader","upc_e_reader"] }
      }, function (err) {
        if (err) { showToast('Camera error'); stopBarcodeScan(); return; }
        Quagga.start();
      });
      Quagga.onDetected(barcodeDetected);
    }
    function barcodeDetected(data) {
      stopBarcodeScan();
      let code = data.codeResult.code;
      showToast("Scanned: "+code);
      fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`).then(r=>r.json()).then(info=>{
        if (info.status === 1 && info.product && info.product.nutriments) {
          let n = info.product.nutriments;
          let name = info.product.product_name || info.product.brands || "Barcode Food";
          let cals = Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0);
          let p = Math.round(n['proteins_serving']||n['proteins_100g']||0);
          let car = Math.round(n['carbohydrates_serving']||n['carbohydrates_100g']||0);
          let fat = Math.round(n['fat_serving']||n['fat_100g']||0);
          if (!cals) cals = Math.round((n['energy_100g']||0)/4.184);
          mealLog.push({name,calories:cals,protein:p,carbs:car,fat:fat,date:Date.now()});
          saveData(); renderAll();
          showToast("Added "+name);
        } else {
          showToast("No food info found");
        }
      }).catch(()=>showToast("Scan failed!"));
    }
    function stopBarcodeScan() {
      Quagga.stop();
      document.getElementById('barcodeVideo').style.display = 'none';
      document.getElementById('barcodeOverlay').style.display = 'none';
      document.getElementById('barcodeCancelBtn').style.display = 'none';
      scanning = false;
      Quagga.offDetected(barcodeDetected);
    }
    // ========== AUTOCOMPLETE FOOD ========== //
    function attachAutocompleteEvents() {
      const input = document.getElementById('mealName');
      const autocompleteList = document.getElementById('autocompleteList');
      if (!input) return;
      let selectedIdx = -1;
      input.oninput = function() {
        const query = this.value.trim();
        if (!query) { autocompleteList.style.display = 'none'; return; }
        // Get food results from OpenFoodFacts (fast)
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(()=>{
          fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(query)+'&search_simple=1&action=process&json=1&page_size=10')
          .then(r=>r.json())
          .then(data=>{
            autocompleteResults = data.products||[];
            if (!autocompleteResults.length) { autocompleteList.style.display = 'none'; return; }
            autocompleteList.innerHTML = autocompleteResults.map((item,i)=>{
              let name = (item.product_name || item.brands || "Food");
              return `<div class="autocomplete-item" data-idx="${i}">${name}</div>`;
            }).join('');
            autocompleteList.style.display = 'block';
            selectedIdx = -1;
          });
        }, 170);
      };
      input.onkeydown = function(e) {
        if (!autocompleteResults.length) return;
        if (e.key==="ArrowDown") {
          selectedIdx = Math.min(selectedIdx+1, autocompleteResults.length-1);
          updateACSelection();
        }
        if (e.key==="ArrowUp") {
          selectedIdx = Math.max(selectedIdx-1, 0);
          updateACSelection();
        }
        if (e.key==="Enter" && selectedIdx >= 0) {
          pickAutocomplete(selectedIdx);
          e.preventDefault();
        }
      };
      autocompleteList.onclick = function(e) {
        const el = e.target.closest('.autocomplete-item');
        if (!el) return;
        pickAutocomplete(Number(el.dataset.idx));
      };
      function updateACSelection() {
        [...autocompleteList.children].forEach((el,i)=>{
          el.classList.toggle('active', i===selectedIdx);
        });
      }
      function pickAutocomplete(idx) {
        let item = autocompleteResults[idx];
        if (!item) return;
        input.value = item.product_name || item.brands || '';
        // Auto-fill macros
        let n = item.nutriments||{};
        document.getElementById('mealCalories').value = Math.round(n['energy-kcal_100g']||n['energy-kcal_serving']||0);
        document.getElementById('mealProtein').value = Math.round(n['proteins_100g']||n['proteins_serving']||0);
        document.getElementById('mealCarbs').value = Math.round(n['carbohydrates_100g']||n['carbohydrates_serving']||0);
        document.getElementById('mealFat').value = Math.round(n['fat_100g']||n['fat_serving']||0);
        autocompleteList.style.display = 'none';
      }
      document.body.addEventListener('click', e => {
        if (!autocompleteList.contains(e.target) && e.target !== input)
          autocompleteList.style.display = 'none';
      });
    }
    // ========== ALL RENDERS ========== //
    function renderAll() {
      updateTotals();
      if (document.getElementById('tabCalc').classList.contains('active')) renderCalculatorTab();
      else renderProgressionTab();
    }
    // ========== INIT ========== //
    renderTab('calc');
    document.getElementById('tabCalc').onclick = ()=>showTab('calc');
    document.getElementById('tabProg').onclick = ()=>showTab('prog');
    document.getElementById('appleLightBtn').onclick = ()=>setTheme('light');
    document.getElementById('ringModeBtn').onclick = ()=>setTheme('ring');
    setTimeout(()=>{ renderStreak(); renderQuote(); }, 80);
  </script>
</body>
</html>
