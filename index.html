<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MacroLegend</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
<style>
:root {
  --light-bg: #f6f6fa;
  --light-card: #fff;
  --light-text: #1a1a1a;
  --light-accent: #2b78e4;
  --light-bar: #d6eaff;
  --light-shadow: 0 4px 32px #0002;
  --gold: #fbe62c;
  --ring-shadow: 0 0 18px 6px #edb94144;
  --ring-bar: #f8c944;
  --ring-green: #7dc271;
  --ring-blue: #5ba4fa;
  --ring-orange: #f5a94d;
  --ring-bg: #2a2009;
  --ring-card: #382a00;
  --ring-txt: #fbe62c;
  --ring-inscription: #bd8c19;
  --chart-bar: #2b78e4;
  --chart-bg: #e5ecfa;
  --progress-radius: 13px;
  --shadow-color: rgba(0,0,0,0.13);
}
body {
  font-family: 'Inter', sans-serif;
  background: var(--light-bg);
  color: var(--light-text);
  min-height: 100vh;
  margin: 0;
  padding: 0;
  transition: background 0.4s, color 0.4s;
}
#macroLegendContainer {
  background: var(--light-card);
  box-shadow: var(--light-shadow);
  border-radius: 22px;
  max-width: 480px;
  margin: 3vw auto 12vw auto;
  padding: 2em 1em 2.5em 1em;
  position: relative;
  min-width: 0;
  width: 100vw;
}
.theme-toggle {
  position: absolute;
  right: 22px; top: 15px;
  z-index: 2;
  display: flex;
  gap: 8px;
}
.theme-btn {
  background: var(--light-bar);
  border: none;
  border-radius: 16px;
  padding: 4px 14px;
  font-size: 1.08rem;
  color: var(--light-accent);
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 7px #0001;
  margin-left: 4px;
  transition: background 0.2s, color 0.2s;
}
.theme-btn.active, .theme-btn:focus {
  background: var(--gold);
  color: #3b2e08;
  outline: none;
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 1em;
  margin-bottom: 1em;
  flex-wrap: wrap;
}
.tab-btn {
  font-weight: 700;
  padding: 0.48em 1.1em;
  border-radius: 12px 12px 0 0;
  border: none;
  background: #e5ecfa;
  color: #3666b5;
  font-size: 1.08em;
  cursor: pointer;
  margin-right: 0.13em;
  box-shadow: 0 1px 7px #0001;
  transition: background 0.2s, color 0.2s;
}
.tab-btn.active {
  background: var(--light-accent);
  color: #fff;
}
.tab-content {
  display: none;
  margin-bottom: 1.2em;
}
.tab-content.active {
  display: block;
  animation: fadein 0.37s;
}
@keyframes fadein {
  from {opacity: 0;}
  to {opacity: 1;}
}
h1 {
  font-family: 'Inter', 'Ringbearer', serif;
  font-size: 2.05rem;
  letter-spacing: 2px;
  margin-bottom: 0.7em;
  text-align: center;
  color: var(--light-accent);
  transition: color 0.3s, text-shadow 0.3s;
  margin-top: 0.85em;
}
.ringmode h1 {
  font-family: 'Ringbearer', 'Inter', serif;
  color: var(--gold);
  text-shadow: 0 2px 14px #edb94199;
}
.goal-line {
  font-size: 1.11em;
  color: #4c4c4c;
  background: #f6f6fa;
  border-radius: 9px;
  margin: 0 auto 1.15em auto;
  text-align: center;
  padding: 0.25em 0.9em;
  font-weight: 500;
  letter-spacing: 0.5px;
  display: flex;
  justify-content: center;
  gap: 1.5em;
  flex-wrap: wrap;
  max-width: 99vw;
  white-space: nowrap;
}
.goal-line span {
  font-weight: 700;
  letter-spacing: 0.2px;
  padding: 0 2px;
}
.goal-macro-p { color: #49a858; }
.goal-macro-c { color: #3677c6; }
.goal-macro-f { color: #e8a200; }
.goal-macro-cal { color: #d4b117; }
.macro-bars {
  margin-bottom: 1em;
  margin-top: 0.3em;
  display: flex;
  flex-direction: column;
  gap: 0.55em;
}
.macro-bar-outer {
  background: var(--light-bar);
  border-radius: var(--progress-radius);
  overflow: hidden;
  position: relative;
  height: 30px;
  margin: 0 0.1em;
}
.macro-bar-inner {
  height: 100%;
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 1.09em;
  justify-content: flex-start;
  padding-left: 14px;
  border-radius: var(--progress-radius);
  transition: width 0.5s cubic-bezier(.35,1.65,.6,1.1);
  color: #fff;
  letter-spacing: 0.5px;
  text-shadow: 0 1px 8px #0004;
  white-space: nowrap;
  position: relative;
}
.bar-cal { background: linear-gradient(90deg,#fbe62c,#f5c80f); color: #735900; }
.bar-p { background: linear-gradient(90deg,#51c16e,#379956); }
.bar-c { background: linear-gradient(90deg,#61aaff,#396ebb); }
.bar-f { background: linear-gradient(90deg,#f5a94d,#d1850b); }
.macro-bar-label {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  color: #fff;
  font-size: 1em;
  font-weight: 700;
  text-shadow: 0 1px 4px #0006;
  width: 100%;
  text-align: center;
  pointer-events: none;
  letter-spacing: 0.5px;
  z-index: 2;
}
/* Chart area */
#macroChart {
  width: 100% !important;
  max-width: 98vw;
  height: 170px;
  background: #e8f2ff;
  border-radius: 11px;
  margin: 0.8em 0 1.4em 0;
  box-shadow: 0 2px 8px #0002;
}
/* Meal log table */
.meal-log-table {
  width: 100%;
  margin-bottom: 0.6em;
  border-collapse: collapse;
  font-size: 1.05em;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 1px 8px #0001;
  overflow-x: auto;
}
.meal-log-table th, .meal-log-table td {
  padding: 9px 8px;
  border: none;
  text-align: center;
  white-space: nowrap;
  font-size: 1em;
}
.meal-log-table th {
  background: #f2f6fc;
  color: #5179c2;
  font-weight: 700;
}
.meal-log-table tbody tr:nth-child(even) {
  background: #f7faff;
}
/* Export buttons */
.export-row {
  display: flex;
  gap: 0.8em;
  justify-content: flex-end;
  margin-bottom: 0.5em;
}
.export-btn {
  background: #e9eef6;
  color: #2b78e4;
  font-size: 0.99em;
  padding: 4px 17px;
  border-radius: 7px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  margin: 0;
  box-shadow: 0 1px 3px #0001;
  transition: background 0.13s, color 0.13s;
}
.export-btn:hover, .export-btn:focus { background: #d6eaff; color: #0c51a4;}
/* Streak ring area */
.streak-ring-wrap {
  margin: 0 auto;
  margin-top: 1.5em;
  width: 140px;
  height: 140px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: filter 0.3s;
}
.streak-ring-svg {
  width: 100%;
  height: 100%;
  display: block;
  filter: drop-shadow(var(--ring-shadow));
}
.streak-center-label {
  position: absolute;
  left: 50%; top: 53%;
  transform: translate(-50%,-50%);
  width: 94px;
  text-align: center;
  color: var(--ring-txt);
  font-family: 'Ringbearer', 'Inter', serif;
  font-size: 1.28em;
  line-height: 1.16;
  font-weight: 700;
  text-shadow: 0 0 11px #edb941c5, 0 1px 2px #000c;
  pointer-events: none;
}
.quote-box {
  margin: 1.2em 0 0.2em 0;
  background: #f8f6e6;
  border-radius: 13px;
  box-shadow: 0 1px 10px #0001;
  color: #9a7b19;
  font-family: 'Ringbearer','Inter',serif;
  font-size: 1.1em;
  text-align: center;
  padding: 0.95em 0.8em;
  letter-spacing: 0.4px;
  min-height: 35px;
}
.ringmode .quote-box {
  background: #2e2208;
  color: #fbe62c;
  border: 1.5px solid #e1b830;
  font-size: 1.07em;
}
.streak-bar-wrap {
  width: 100%;
  max-width: 390px;
  margin: 1.8em auto 0.3em auto;
  background: #d6eaff;
  border-radius: 16px;
  box-shadow: 0 1px 4px #0001;
  padding: 0.5em 0.7em;
  font-size: 1.08em;
  color: #2b78e4;
  font-weight: 700;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 18px;
  justify-content: center;
  flex-wrap: wrap;
}
.streak-bar-value {
  background: #2b78e4;
  color: #fff;
  border-radius: 12px;
  padding: 2.5px 12px;
  margin: 0 8px;
  font-size: 1em;
  font-weight: 700;
  box-shadow: 0 2px 6px #2b78e411;
}
/* Macro input areas */
.macro-input-row, .macro-input-row-calc {
  display: flex;
  flex-wrap: wrap;
  gap: 1em;
  justify-content: center;
  margin-bottom: 1.2em;
}
.macro-input, .macro-input-calc {
  min-width: 124px;
  max-width: 170px;
  flex: 1 1 30%;
  font-size: 1.13em;
  padding: 12px 14px;
  margin: 0.15em 0 0.15em 0;
  border-radius: 12px;
  border: 1.4px solid #b6c6e1;
  background: #f6faff;
  color: #222;
  box-shadow: 0 2px 5px #b6d4fa11;
  outline: none;
  transition: border 0.15s;
}
.macro-input:focus, .macro-input-calc:focus { border: 1.2px solid #2b78e4; }
select, .macro-select {
  font-size: 1.09em;
  border-radius: 10px;
  padding: 12px 13px;
  background: #f6faff;
  color: #252525;
  border: 1.2px solid #c0c9db;
  outline: none;
  margin-bottom: 1em;
  width: 99%;
}
.activity-option {
  font-size: 0.99em;
}
@media (max-width: 700px) {
  #macroLegendContainer { max-width: 99vw; padding: 1em 1vw 2em 1vw;}
  .goal-line { font-size: 0.98em; gap: 0.7em;}
  .macro-bar-inner, .macro-bar-label { font-size: 0.98em;}
  #macroChart { height: 120px;}
  .streak-ring-wrap { width: 92vw; height: 92vw; max-width: 160px; max-height: 160px;}
  .streak-center-label { width: 61vw; max-width: 113px; font-size: 1em;}
  .quote-box { font-size: 1em; padding: 0.7em 0.6em;}
}
@media (max-width: 480px) {
  .container, #macroLegendContainer { padding: 0.5em 0.5vw 2em 0.5vw;}
  h1 { font-size: 1.18rem; }
  .goal-line { font-size: 0.93em; gap: 0.4em;}
  .macro-bar-inner, .macro-bar-label { font-size: 0.93em;}
  #macroChart { height: 93px;}
  .streak-ring-wrap { width: 91vw; height: 91vw; max-width: 130px; max-height: 130px;}
  .streak-center-label { width: 53vw; max-width: 90px; font-size: 0.91em;}
  .quote-box { font-size: 0.93em; padding: 0.48em 0.23em;}
}
body.ringmode, .ringmode body {
  background: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=800&q=80') center/cover #271e05;
  color: var(--ring-txt);
  transition: background 0.4s, color 0.3s;
}
.ringmode #macroLegendContainer {
  background: var(--ring-card) !important;
  color: var(--ring-txt) !important;
  box-shadow: 0 4px 32px #5c4b0a99;
}
.ringmode .goal-line, .ringmode .meal-log-table th, .ringmode .macro-bar-label {
  background: #2e2208 !important;
  color: var(--ring-txt) !important;
}
.ringmode .macro-bar-outer { background: #b49c24 !important; }
.ringmode .bar-cal { background: linear-gradient(90deg,#fbe62c,#cfa211) !important; color: #5d4b04;}
.ringmode .bar-p { background: linear-gradient(90deg,#7dc271,#3b7f2d);}
.ringmode .bar-c { background: linear-gradient(90deg,#5ba4fa,#30426e);}
.ringmode .bar-f { background: linear-gradient(90deg,#f5a94d,#ad7a1d);}
.ringmode .macro-bar-label { color: #fff9db !important;}
.ringmode .streak-bar-wrap {
  background: #3a3008 !important;
  color: #fbe62c !important;
}
.ringmode .export-btn { background: #3e3108; color: #fbe62c;}
.ringmode .theme-btn { background: #fbe62c; color: #3b2e08;}
.ringmode .theme-btn.active { background: #fff; color: #a28907;}
.ringmode .meal-log-table th { color: #edb941;}
.ringmode .meal-log-table { background: #382a00; }
.ringmode .meal-log-table td { color: #fbe62c;}
/* Barcode/camera modal */
#barcodeModal {
  position: fixed;
  z-index: 1001;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: #151513ee;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
#barcodeModal video {
  width: 90vw; max-width: 420px; border-radius: 18px;
  margin-bottom: 1.2em;
  box-shadow: 0 6px 32px #000a;
}
#barcodeModal .close-btn {
  margin-top: 0.3em;
  background: #edb941;
  color: #181208;
  padding: 0.55em 2.3em;
  font-size: 1.1em;
  font-weight: 800;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  box-shadow: 0 1px 4px #0006;
}
.toast {
  position: fixed;
  left: 50%; bottom: 3.4em;
  transform: translateX(-50%);
  background: #fbe62c;
  color: #181208;
  font-weight: 700;
  font-size: 1.13em;
  border-radius: 15px;
  padding: 1em 1.9em;
  z-index: 1022;
  box-shadow: 0 3px 16px #0005;
  animation: toastPop 0.7s;
}
@keyframes toastPop {
  0% { opacity: 0; transform: translateX(-50%) scale(0.89);}
  45% { opacity: 1; transform: translateX(-50%) scale(1.08);}
  100% { opacity: 1; transform: translateX(-50%) scale(1);}
}
</style>
</head>
<body>
<div id="macroLegendContainer">
  <div class="theme-toggle">
    <button class="theme-btn active" id="appleLightBtn" onclick="setTheme('light')">Apple Light</button>
    <button class="theme-btn" id="ringModeBtn" onclick="setTheme('ring')">Ring Mode</button>
  </div>
  <h1>MacroLegend</h1>
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('calculator')">Macro Calculator</button>
    <button class="tab-btn" onclick="showTab('progression')">Progression</button>
    <button class="tab-btn" onclick="showTab('foodlog')">Food Log</button>
  </div>
  <!-- Macro Calculator TAB -->
  <div class="tab-content active" id="calculatorTab">
    <div class="macro-input-row-calc">
      <input class="macro-input-calc" id="calcWeight" type="number" min="50" placeholder="Weight (lbs)">
      <select id="calcGender" class="macro-select">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
      <input class="macro-input-calc" id="calcHeight" type="number" min="48" placeholder="Height (in)">
      <select id="calcActivity" class="macro-select"></select>
      <select id="calcGoal" class="macro-select">
        <option value="maintain">Maintain</option>
        <option value="lose">Lose</option>
        <option value="gain">Gain</option>
      </select>
    </div>
    <div class="macro-input-row-calc">
      <input class="macro-input-calc" id="calcCalories" type="number" min="900" max="7000" placeholder="Goal Calories (auto)">
      <input class="macro-input-calc" id="calcProtein" type="number" min="0" placeholder="Protein (g)">
      <input class="macro-input-calc" id="calcCarbs" type="number" min="0" placeholder="Carbs (g)">
      <input class="macro-input-calc" id="calcFat" type="number" min="0" placeholder="Fat (g)">
    </div>
    <div style="text-align:center;margin:0.8em;">
      <label>Protein %: <input type="range" id="calcProteinPct" min="0" max="100" value="30" style="width:90px;"> <span id="calcProteinPctVal">30</span>%</label>
      <label style="margin-left:1.6em;">Fat %: <input type="range" id="calcFatPct" min="0" max="100" value="30" style="width:90px;"> <span id="calcFatPctVal">30</span>%</label>
      <label style="margin-left:1.6em;">Carb %: <input type="range" id="calcCarbPct" min="0" max="100" value="40" style="width:90px;"> <span id="calcCarbPctVal">40</span>%</label>
    </div>
    <div style="text-align:center;margin:1em;">
      <button class="export-btn" onclick="pushToProgression()">Push to Progression</button>
    </div>
  </div>
  <!-- Progression TAB -->
  <div class="tab-content" id="progressionTab">
    <div class="goal-line" id="goalLine"></div>
    <div class="macro-bars" id="macroBars"></div>
    <canvas id="macroChart"></canvas>
    <div class="export-row">
      <button class="export-btn" onclick="exportCSV()">Export CSV</button>
      <button class="export-btn" onclick="exportTXT()">Export TXT</button>
      <button class="export-btn" onclick="window.print()">Print / PDF</button>
    </div>
    <div id="streakArea"></div>
    <div class="quote-box" id="quoteBox"></div>
  </div>
  <!-- Food Log TAB -->
  <div class="tab-content" id="foodlogTab">
    <form onsubmit="addMeal(event)" class="add-meal-row" autocomplete="off">
      <input class="meal-name-input macro-input" id="mealName" placeholder="Meal name/food" list="foodList" required autocomplete="off">
      <button type="button" class="export-btn" onclick="openBarcodeScanner()">ðŸ“·</button>
      <datalist id="foodList"></datalist>
      <input class="meal-amt-input macro-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
      <input class="meal-amt-input macro-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
      <input class="meal-amt-input macro-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
      <input class="meal-amt-input macro-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
      <button class="add-meal-btn export-btn" type="submit" style="margin-left:7px;">+ Add</button>
    </form>
    <table class="meal-log-table" id="mealLogTable"></table>
  </div>
</div>
<!-- Barcode scanner modal -->
<div id="barcodeModal">
  <video id="barcodeVideo" autoplay playsinline></video>
  <button class="close-btn" onclick="closeBarcodeScanner()">Close</button>
</div>
<audio id="streakSound" preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
</audio>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@ericblade/quagga2@2.0.0-beta.2/dist/quagga.min.js"></script>
<script>
// ======= GLOBALS AND CONSTANTS =======
const lotrPhrases = [
  "Even the smallest person can change the course of the future.",
  "Not all those who wander are lost.",
  "The road goes ever on and on.",
  "Deeds will not be less valiant because they are unpraised.",
  "Faithless is he that says farewell when the road darkens.",
  "All we have to decide is what to do with the time that is given us.",
  "Thereâ€™s some good in this world, and itâ€™s worth fighting for.",
  "I am glad you are here with me. Here at the end of all things.",
  "The world is indeed full of peril, and in it there are many dark places.",
  "A wizard is never late, nor is he early, he arrives precisely when he means to.",
  "You shall not pass!",
  "Courage is found in unlikely places.",
  "The shadow is only a passing thing.",
  "Hope remains while the Company is true.",
  "The board is set, the pieces are moving.",
  "One does not simply walk into Mordor.",
  "I would rather share one lifetime with you than face all the ages of this world alone.",
  "May it be a light to you in dark places, when all other lights go out.",
  "It's a dangerous business, going out your door.",
  "The wise speak only of what they know.",
  "Many that live deserve death. And some that die deserve life.",
  "Even darkness must pass. A new day will come.",
  "The strength of the ring-bearer is in his heart.",
  "Thereâ€™s always hope.",
  "For Frodo.",
  "The journey doesnâ€™t end here.",
  "I am no man!",
  "The Ring has awoken.",
  "Speak, friend, and enter.",
  "There and back again.",
  "Let him not vow to walk in the dark, who has not seen the nightfall.",
  "Renewed shall be blade that was broken.",
  "I will take the Ring, though I do not know the way.",
  "A day may come when the courage of men failsâ€¦ but it is not this day.",
  "My friends, you bow to no one.",
  "White shores, and beyond, a far green country under a swift sunrise.",
  "You have my sword.",
  "The Shire must truly be a great place.",
  "If by my life or death I can protect you, I will.",
  "End? No, the journey doesn't end here.",
  "Where there's life, there's hope.",
  "Itâ€™s the job thatâ€™s never started as takes longest to finish.",
  "But in the end, itâ€™s only a passing thing, this shadow.",
  "I can't carry it for you, but I can carry you!",
  "The hands of a king are the hands of a healer.",
  "Shadowfax, show us the meaning of haste.",
  "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
  "Mithrandir, why did you leave us?",
  "You shall be the Fellowship of the Ring.",
  "I will not say: do not weep; for not all tears are an evil.",
  "The fire of your heart outshines the darkness.",
  "May your path be green and the breeze on your back.",
  "Streaks are for heroes. Today you are legend.",
  "Let the courage of the Eldar guide you.",
];
const genericPhrases = [
  "Great job staying consistent!",
  "Every day is a fresh start.",
  "Progress over perfection.",
  "Stay strong and keep going!",
  "Youâ€™re building habits that last.",
  "Keep moving forward.",
  "One step closer!",
  "Todayâ€™s effort is tomorrowâ€™s progress.",
  "Momentum is your friend.",
  "Persistence brings results.",
  "Youâ€™re crushing it!",
  "The only bad workout is the one you didnâ€™t do.",
  "Consistency = success.",
  "Make today count.",
  "Youâ€™ve got this!",
  "Legends are built, not born.",
  "Stay motivated!",
  "Keep up the hard work.",
  "Believe in yourself.",
  "Small steps, big changes.",
  "Victory loves preparation.",
  "Winners donâ€™t quit.",
  "Youâ€™re unstoppable.",
  "Success is earned daily.",
  "Discipline is your superpower.",
  "Every rep counts.",
  "Feed the fire.",
  "Brick by brick.",
  "Trust the process.",
  "Health is the first wealth.",
  "Master your habits.",
  "Progress never sleeps.",
  "Embrace the grind.",
  "This is your story.",
  "Level up!",
  "Power through!",
  "Onward!",
  "Aim higher.",
  "Rise and grind.",
  "Well done!",
  "Celebrate your streak.",
  "No zero days.",
  "Make it legendary.",
  "Momentum matters.",
  "You inspire others.",
  "Be your own hero.",
  "Forge ahead.",
  "Conquer today.",
  "Finish strong.",
  "Stay in the fight.",
  "Champions stay consistent."
];
// Activity levels/descriptions for calculator
const activityLevels = [
  {value: 1.2, label: "Sedentary (little or no exercise)"},
  {value: 1.375, label: "Light (light exercise/sports 1-3 days/wk)"},
  {value: 1.55, label: "Moderate (moderate exercise/sports 3-5 days/wk)"},
  {value: 1.725, label: "Active (hard exercise/sports 6-7 days/wk)"},
  {value: 1.9, label: "Very Active (very hard exercise/physical job & exercise)"}
];
let macroGoals = { calories: 2000, protein: 150, carbs: 200, fat: 70 };
let macroTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
let mealLog = [];
let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
let chart;
let curTheme = 'light';
let curTab = 'calculator';

// ==== STORAGE LOAD ====
try {
  if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
  if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
  if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
} catch (e) {}
// ==== ACTIVITY SELECT RENDER ====
function renderActivityOptions() {
  let sel = document.getElementById('calcActivity');
  sel.innerHTML = "";
  activityLevels.forEach(opt => {
    let o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    o.className = "activity-option";
    sel.appendChild(o);
  });
}
// ==== THEME ====
function setTheme(theme) {
  curTheme = theme;
  const body = document.body;
  const cont = document.getElementById('macroLegendContainer');
  if (theme === 'ring') {
    body.classList.add('ringmode');
    cont.classList.add('ringmode');
    document.getElementById('appleLightBtn').classList.remove('active');
    document.getElementById('ringModeBtn').classList.add('active');
  } else {
    body.classList.remove('ringmode');
    cont.classList.remove('ringmode');
    document.getElementById('appleLightBtn').classList.add('active');
    document.getElementById('ringModeBtn').classList.remove('active');
  }
  renderStreak();
  renderQuote();
}
setTheme(curTheme);
// ==== TAB HANDLER ====
function showTab(tab) {
  curTab = tab;
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', btn.textContent.replace(/\s/g, '').toLowerCase().includes(tab));
  });
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  if (tab === 'calculator') document.getElementById('calculatorTab').classList.add('active');
  if (tab === 'progression') document.getElementById('progressionTab').classList.add('active');
  if (tab === 'foodlog') document.getElementById('foodlogTab').classList.add('active');
}
// ==== MACRO CALCULATOR =====
function autoCalcCalories() {
  // Mifflin-St Jeor BMR, then TDEE
  const w = Number(document.getElementById('calcWeight').value);
  const h = Number(document.getElementById('calcHeight').value);
  const g = document.getElementById('calcGender').value;
  const act = Number(document.getElementById('calcActivity').value || 1.375);
  const goal = document.getElementById('calcGoal').value;
  if (!w || !h) return;
  let bmr = 0;
  if (g === "male") bmr = 10 * w * 0.4536 + 6.25 * h * 2.54 - 5 * 30 + 5;
  else if (g === "female") bmr = 10 * w * 0.4536 + 6.25 * h * 2.54 - 5 * 30 - 161;
  else bmr = 10 * w * 0.4536 + 6.25 * h * 2.54 - 5 * 30;
  let tdee = bmr * act;
  if (goal === "lose") tdee *= 0.85;
  if (goal === "gain") tdee *= 1.10;
  document.getElementById('calcCalories').value = Math.round(tdee);
  autoMacros();
}
function autoMacros() {
  const cal = Number(document.getElementById('calcCalories').value);
  let pp = Number(document.getElementById('calcProteinPct').value) / 100;
  let fp = Number(document.getElementById('calcFatPct').value) / 100;
  let cp = Number(document.getElementById('calcCarbPct').value) / 100;
  let sum = pp + fp + cp;
  if (Math.abs(sum-1) > 0.01) { pp /= sum; fp /= sum; cp /= sum; }
  document.getElementById('calcProtein').value = Math.round((cal * pp) / 4);
  document.getElementById('calcFat').value = Math.round((cal * fp) / 9);
  document.getElementById('calcCarbs').value = Math.round((cal * cp) / 4);
}
// ==== PUSH TO PROGRESSION =====
function pushToProgression() {
  macroGoals.calories = Number(document.getElementById('calcCalories').value);
  macroGoals.protein = Number(document.getElementById('calcProtein').value);
  macroGoals.carbs = Number(document.getElementById('calcCarbs').value);
  macroGoals.fat = Number(document.getElementById('calcFat').value);
  saveData();
  renderAll();
  showTab('progression');
  showToast("Goals updated!");
}
// ==== MACRO BARS/GOALS ====
function renderGoalLine() {
  const {calories, protein, carbs, fat} = macroGoals;
  document.getElementById('goalLine').innerHTML =
    `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
     <span class="goal-macro-p">P: <b>${protein}g</b></span>
     <span class="goal-macro-c">C: <b>${carbs}g</b></span>
     <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
}
function renderMacroBars() {
  const {calories, protein, carbs, fat} = macroGoals;
  const t = macroTotals;
  function pct(val, goal) { return Math.min(100, Math.round(100 * val/goal)); }
  document.getElementById('macroBars').innerHTML = `
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories,calories)}%">
        <span class="macro-bar-label">${t.calories}/${calories} kcal</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-p" style="width:${pct(t.protein,protein)}%">
        <span class="macro-bar-label">${t.protein}/${protein}g Protein</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs,carbs)}%">
        <span class="macro-bar-label">${t.carbs}/${carbs}g Carbs</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-f" style="width:${pct(t.fat,fat)}%">
        <span class="macro-bar-label">${t.fat}/${fat}g Fat</span>
      </div>
    </div>
  `;
}
// ==== MEAL LOG ====
function addMeal(e) {
  e.preventDefault();
  const name = document.getElementById('mealName').value.trim();
  const calories = Number(document.getElementById('mealCalories').value);
  const protein = Number(document.getElementById('mealProtein').value) || 0;
  const carbs = Number(document.getElementById('mealCarbs').value) || 0;
  const fat = Number(document.getElementById('mealFat').value) || 0;
  if (!name || !calories) return;
  mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
  saveData();
  document.getElementById('mealName').value = '';
  document.getElementById('mealCalories').value = '';
  document.getElementById('mealProtein').value = '';
  document.getElementById('mealCarbs').value = '';
  document.getElementById('mealFat').value = '';
  renderAll();
  checkStreak();
}
function renderMealLog() {
  let rows = mealLog.map((m,i) =>
    `<tr>
      <td>${m.name}</td>
      <td>${m.calories}</td>
      <td>${m.protein}</td>
      <td>${m.carbs}</td>
      <td>${m.fat}</td>
      <td><button onclick="removeMeal(${i})" style="color:#e34747;font-weight:700;font-size:0.93em;border:none;background:none;cursor:pointer;">âœ•</button></td>
    </tr>`
  ).join('');
  document.getElementById('mealLogTable').innerHTML = `
    <thead>
      <tr>
        <th>Meal</th>
        <th>Cal</th>
        <th>P</th>
        <th>C</th>
        <th>F</th>
        <th></th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  `;
}
function removeMeal(idx) {
  mealLog.splice(idx,1);
  saveData();
  renderAll();
}
// ==== MACRO TOTALS ====
function updateTotals() {
  macroTotals = {calories:0,protein:0,carbs:0,fat:0};
  mealLog.forEach(m=>{
    macroTotals.calories += Number(m.calories)||0;
    macroTotals.protein += Number(m.protein)||0;
    macroTotals.carbs += Number(m.carbs)||0;
    macroTotals.fat += Number(m.fat)||0;
  });
}
// ==== EXPORT ====
function exportCSV() {
  let csv = "Meal,Calories,Protein,Carbs,Fat\n";
  mealLog.forEach(m=>{
    csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
  });
  download(csv, "macrolegend.csv");
}
function exportTXT() {
  let txt = "MacroLegend Log\n==================\n";
  mealLog.forEach(m=>{
    txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
  });
  download(txt, "macrolegend.txt");
}
function download(content, filename) {
  const a = document.createElement('a');
  const file = new Blob([content], {type: 'text/plain'});
  a.href = URL.createObjectURL(file);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}
// ==== CHART ====
function renderChart() {
  const ctx = document.getElementById('macroChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Calories','Protein','Carbs','Fat'],
      datasets: [
        {
          label: 'Current',
          data: [macroTotals.calories, macroTotals.protein, macroTotals.carbs, macroTotals.fat],
          backgroundColor: [
            'rgba(251,230,44,0.82)',  // Calories: gold
            'rgba(81,193,110,0.85)',  // Protein: green
            'rgba(97,170,255,0.85)',  // Carbs: blue
            'rgba(245,169,77,0.85)'   // Fat: orange
          ],
          borderRadius: 10,
          maxBarThickness: 40,
          yAxisID: 'A'
        },
        {
          label: 'Goal',
          data: [macroGoals.calories, macroGoals.protein, macroGoals.carbs, macroGoals.fat],
          backgroundColor: [
            'rgba(251,230,44,0.19)',
            'rgba(81,193,110,0.18)',
            'rgba(97,170,255,0.18)',
            'rgba(245,169,77,0.17)'
          ],
          borderRadius: 10,
          borderWidth: 0,
          yAxisID: 'A'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {display: false},
        tooltip: {enabled: true},
      },
      scales: {
        x: {
          grid: {display: false},
          ticks: {color: '#888', font: {weight:700}}
        },
        A: {
          beginAtZero: true,
          grid: {color:'#e5ecfa', display: true, drawBorder: false, borderWidth:0, lineWidth: 0.5},
          ticks: {color: '#888', font: {weight:700}},
          position: 'left'
        },
        B: {
          beginAtZero: true,
          grid: {display: false, drawBorder: false},
          ticks: {color: '#fa9', font: {weight:600}},
          position: 'right',
          min: 0,
          max: Math.max(macroGoals.protein, macroGoals.carbs, macroGoals.fat, macroTotals.protein, macroTotals.carbs, macroTotals.fat) * 1.3,
          display: false
        }
      }
    }
  });
}
// ==== STREAK SYSTEM ====
function checkStreak() {
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  if (streak.lastDate !== todayStr) {
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1);
    const ystr = yesterday.toISOString().slice(0,10);
    if (streak.lastDate === ystr) {
      streak.days += 1;
      if (streak.days > streak.best) {
        streak.best = streak.days;
        playStreakSound();
      }
    } else {
      streak.days = 1;
    }
    streak.lastDate = todayStr;
    streak.weekPhrase = ((streak.days-1) % lotrPhrases.length);
    saveData();
    renderStreak();
  }
}
function renderStreak() {
  const streakArea = document.getElementById('streakArea');
  const isRing = document.body.classList.contains('ringmode');
  if (isRing) {
    // SVG for 3D-like golden ring w/ inscription
    streakArea.innerHTML = `
    <div class="streak-ring-wrap">
      <svg class="streak-ring-svg" width="140" height="140" viewBox="0 0 140 140">
        <defs>
          <radialGradient id="gold" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#fff9c9"/>
            <stop offset="50%" stop-color="#fbe62c"/>
            <stop offset="85%" stop-color="#edb941"/>
            <stop offset="100%" stop-color="#bca206"/>
          </radialGradient>
          <filter id="ringshadow" x="-10%" y="-10%" width="120%" height="120%">
            <feDropShadow dx="0" dy="6" stdDeviation="4" flood-color="#000" flood-opacity="0.19"/>
          </filter>
        </defs>
        <ellipse cx="70" cy="72" rx="56" ry="32" fill="url(#gold)" filter="url(#ringshadow)" stroke="#c3a32c" stroke-width="7"/>
        <text x="70" y="86" text-anchor="middle" fill="#331b07" font-family="Ringbearer, serif"
          font-size="13" font-weight="bold" dy="0" letter-spacing="2">
          ${toElvishInscription(streak.days)}
        </text>
      </svg>
      <div class="streak-center-label">
        <span style="font-size:2.1em;letter-spacing:2px;">${streak.days}</span>
      </div>
    </div>
    `;
  } else {
    streakArea.innerHTML = `
      <div class="streak-bar-wrap">
        Streak
        <span class="streak-bar-value">${streak.days}</span>
        | Best: <span class="streak-bar-value">${streak.best}</span>
      </div>
    `;
  }
}
function toElvishInscription(num) {
  // Gimmick: Roman numeral + Black Speech
  const roman = ["","I","II","III","IV","V","VI","VII","VIII","IX","X",
    "XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX",
    "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX",
    "XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL",
    "XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L"];
  let romanNum = num < roman.length ? roman[num] : num;
  return "Ash nazg " + romanNum + " burzum-ishi";
}
function playStreakSound() {
  if (document.body.classList.contains('ringmode')) {
    try {
      document.getElementById('streakSound').currentTime = 0;
      document.getElementById('streakSound').play();
    } catch (e) {}
  }
}
// ==== QUOTES ====
function renderQuote() {
  let q = (curTheme==='ring') ? lotrPhrases[streak.weekPhrase % lotrPhrases.length]
    : genericPhrases[streak.weekPhrase % genericPhrases.length];
  document.getElementById('quoteBox').textContent = `"${q}"`;
}
// ==== DATA STORAGE ====
function saveData() {
  localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
  localStorage.setItem('mealLog', JSON.stringify(mealLog));
  localStorage.setItem('streak', JSON.stringify(streak));
}
// ==== ALL RENDERS ====
function renderAll() {
  updateTotals();
  renderGoalLine();
  renderMacroBars();
  renderMealLog();
  renderChart();
  renderStreak();
  renderQuote();
  setupGoalInputs();
  renderFoodList();
}
// ==== GOAL INPUTS ====
function setupGoalInputs() {
  document.getElementById('calcCalories').onchange = autoMacros;
  document.getElementById('calcProteinPct').oninput = () => {
    document.getElementById('calcProteinPctVal').textContent = document.getElementById('calcProteinPct').value;
    autoMacros();
  };
  document.getElementById('calcFatPct').oninput = () => {
    document.getElementById('calcFatPctVal').textContent = document.getElementById('calcFatPct').value;
    autoMacros();
  };
  document.getElementById('calcCarbPct').oninput = () => {
    document.getElementById('calcCarbPctVal').textContent = document.getElementById('calcCarbPct').value;
    autoMacros();
  };
  document.getElementById('calcWeight').oninput = autoCalcCalories;
  document.getElementById('calcHeight').oninput = autoCalcCalories;
  document.getElementById('calcGender').onchange = autoCalcCalories;
  document.getElementById('calcActivity').onchange = autoCalcCalories;
  document.getElementById('calcGoal').onchange = autoCalcCalories;
}
function showToast(msg) {
  const t = document.createElement('div');
  t.className = "toast";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2600);
}
// ==== BARCODE / FOOD SEARCH ====
let quaggaActive = false;
function openBarcodeScanner() {
  document.getElementById('barcodeModal').style.display = 'flex';
  startQuagga();
}
function closeBarcodeScanner() {
  document.getElementById('barcodeModal').style.display = 'none';
  Quagga.stop();
  quaggaActive = false;
}
function startQuagga() {
  if (quaggaActive) return;
  Quagga.init({
    inputStream : {
      name : "Live",
      type : "LiveStream",
      target: document.querySelector('#barcodeVideo'),
      constraints: { facingMode: "environment" }
    },
    decoder : { readers : ["ean_reader","ean_8_reader","upc_reader","upc_e_reader"] }
  }, function(err) {
    if (err) return showToast("Camera error!");
    Quagga.start();
    quaggaActive = true;
    Quagga.onDetected((data)=>{
      let code = data.codeResult.code;
      Quagga.offDetected();
      Quagga.stop();
      document.getElementById('barcodeModal').style.display = 'none';
      fetchOpenFoodFacts(code);
    });
  });
}
function fetchOpenFoodFacts(barcode) {
  showToast("Searching...");
  fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
  .then(r=>r.json())
  .then(data=>{
    if (data.status === 1) {
      const p = data.product;
      document.getElementById('mealName').value = p.product_name || "";
      document.getElementById('mealCalories').value = p.nutriments["energy-kcal_100g"] || "";
      document.getElementById('mealProtein').value = p.nutriments.proteins_100g || "";
      document.getElementById('mealCarbs').value = p.nutriments.carbohydrates_100g || "";
      document.getElementById('mealFat').value = p.nutriments.fat_100g || "";
      showToast("Barcode found!");
    } else {
      showToast("Barcode not found.");
    }
  }).catch(()=>showToast("Barcode error!"));
}
// ==== AUTOCOMPLETE FOODS ====
let foodDB = [];
function renderFoodList() {
  if (!foodDB.length) {
    // Lazy load Open Food Facts (cached in RAM for this session)
    fetch("https://world.openfoodfacts.org/cgi/search.pl?search_terms=&search_simple=1&action=process&json=1&page_size=1000")
    .then(r=>r.json())
    .then(data=>{
      foodDB = data.products || [];
      fillFoodDatalist();
    });
  } else {
    fillFoodDatalist();
  }
}
function fillFoodDatalist() {
  const dl = document.getElementById('foodList');
dl.innerHTML = "";
foodDB.forEach(p=>{
if (p.product_name) {
let opt = document.createElement('option');
opt.value = p.product_name;
opt.setAttribute('data-cal', p.nutriments["energy-kcal_100g"] || "");
opt.setAttribute('data-protein', p.nutriments.proteins_100g || "");
opt.setAttribute('data-carbs', p.nutriments.carbohydrates_100g || "");
opt.setAttribute('data-fat', p.nutriments.fat_100g || "");
dl.appendChild(opt);
}
});
}
document.getElementById('mealName').addEventListener('input', e=>{
const val = e.target.value.toLowerCase();
const opt = Array.from(document.getElementById('foodList').options).find(o => o.value.toLowerCase() === val);
if (opt) {
document.getElementById('mealCalories').value = opt.getAttribute('data-cal');
document.getElementById('mealProtein').value = opt.getAttribute('data-protein');
document.getElementById('mealCarbs').value = opt.getAttribute('data-carbs');
document.getElementById('mealFat').value = opt.getAttribute('data-fat');
}
});
// ==== RENDER EVERYTHING ON LOAD ====
renderActivityOptions();
renderAll();
</script>

</body> </html> ```
