<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroLegend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root {
      --light-bg: #f6f6fa;
      --light-card: #fff;
      --light-text: #1a1a1a;
      --light-accent: #2b78e4;
      --light-bar: #d6eaff;
      --light-shadow: 0 4px 32px #0002;
      --gold: #fbe62c;
      --ring-shadow: 0 0 18px 6px #edb94144;
      --ring-bar: #f8c944;
      --ring-green: #7dc271;
      --ring-blue: #5ba4fa;
      --ring-orange: #f5a94d;
      --ring-bg: #2a2009;
      --ring-card: #382a00;
      --ring-txt: #e2e6d8;
      --ring-inscription: #bd8c19;
      --progress-radius: 13px;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--light-bg);
      color: var(--light-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      background: var(--light-card);
      box-shadow: var(--light-shadow);
      border-radius: 22px;
      max-width: 510px;
      width: calc(100vw - 26px);
      margin: 4vw 0 12vw 0;
      padding: 2.1em 2.2em 3em 2.2em;
      transition: background 0.3s;
      position: relative;
      min-width: 0;
      box-sizing: border-box;
      z-index: 10;
    }
    h1 {
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 2.35rem;
      letter-spacing: 2px;
      margin: 0 0 0.7em 0;
      text-align: center;
      color: var(--light-accent);
      transition: color 0.3s, text-shadow 0.3s;
      user-select: none;
      padding-top: 0.6em;
    }
    .ringmode h1 {
      color: var(--gold);
      text-shadow: 0 2px 14px #edb94199;
      letter-spacing: 2px;
    }
    .theme-toggle {
      display: flex; gap: 8px;
      position: absolute;
      top: 18px; right: 24px;
    }
    .theme-btn {
      background: var(--light-bar);
      border: none;
      border-radius: 16px;
      padding: 4px 14px;
      font-size: 1.03rem;
      color: var(--light-accent);
      font-weight: 700;
      cursor: pointer;
      margin-left: 4px;
      box-shadow: 0 2px 7px #0001;
      transition: background 0.2s, color 0.2s;
    }
    .theme-btn.active, .theme-btn:focus {
      background: var(--gold);
      color: #3b2e08;
      outline: none;
    }
    .tab-row {
      display: flex; justify-content: center;
      gap: 16px; margin: 0 0 2em 0;
      margin-top: 1.7em;
    }
    .tab-btn {
      background: #eceefe; color: #4275ba;
      border: none; border-radius: 9px 9px 0 0;
      padding: 12px 35px; font-weight: 700; font-size: 1.12em;
      cursor: pointer; box-shadow: 0 2px 7px #0001;
      transition: background 0.17s, color 0.17s;
    }
    .tab-btn.active, .tab-btn:focus {
      background: var(--light-accent);
      color: #fff;
    }
    .ringmode .tab-btn {
      background: #332808;
      color: #e2e6d8;
    }
    .ringmode .tab-btn.active { background: #fbe62c; color: #382a00; }
    .goal-line {
      font-size: 1.13em; color: #4c4c4c; background: #f6f6fa;
      border-radius: 9px; margin: 0 auto 1.6em auto; text-align: center;
      padding: 0.45em 1.2em; font-weight: 500; letter-spacing: 0.5px;
      display: flex; justify-content: center; gap: 2.2em; flex-wrap: wrap;
      max-width: 99vw; white-space: nowrap;
    }
    .goal-line span { font-weight: 700; letter-spacing: 0.2px; padding: 0 2px; }
    .goal-macro-p { color: #49a858; }
    .goal-macro-c { color: #3677c6; }
    .goal-macro-f { color: #e8a200; }
    .goal-macro-cal { color: #d4b117; }
    .macro-bars {
      margin-bottom: 1.8em; margin-top: 1.4em;
      display: flex; flex-direction: column; gap: 1.2em;
    }
    .macro-bar-outer {
      background: var(--light-bar); border-radius: var(--progress-radius);
      overflow: hidden; position: relative; height: 38px; margin: 0 0.1em;
    }
    .macro-bar-inner { height: 100%; display: flex; align-items: center; font-weight: 600; font-size: 1.09em; justify-content: flex-start; padding-left: 17px; border-radius: var(--progress-radius); transition: width 0.45s cubic-bezier(.35,1.65,.6,1.1); color: #fff; letter-spacing: 0.5px; text-shadow: 0 1px 8px #0004; white-space: nowrap; position: relative;}
    .bar-cal { background: linear-gradient(90deg,#fbe62c,#f5c80f); color: #735900; }
    .bar-p { background: linear-gradient(90deg,#51c16e,#379956); }
    .bar-c { background: linear-gradient(90deg,#61aaff,#396ebb); }
    .bar-f { background: linear-gradient(90deg,#f5a94d,#d1850b); }
    .macro-bar-label { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 1.09em; font-weight: 700; text-shadow: 0 1px 4px #0006; width: 100%; text-align: center; pointer-events: none; letter-spacing: 0.5px; z-index: 2;}
    #macroChart { width: 100% !important; max-width: 98vw; height: 200px; background: #e8f2ff; border-radius: 11px; margin: 2.2em 0 2.5em 0; box-shadow: 0 2px 8px #0002;}
    .meal-log-table { width: 100%; margin-bottom: 1.4em; border-collapse: collapse; font-size: 1.14em; background: #fff; border-radius: 14px; box-shadow: 0 1px 8px #0001; overflow-x: auto;}
    .meal-log-table th, .meal-log-table td { padding: 12px 10px; border: none; text-align: center; white-space: nowrap; font-size: 1.01em;}
    .meal-log-table th { background: #f2f6fc; color: #5179c2; font-weight: 700;}
    .meal-log-table tbody tr:nth-child(even) { background: #f7faff;}
    .export-row { display: flex; gap: 1.5em; justify-content: flex-end; margin-bottom: 1em;}
    .export-btn { background: #e9eef6; color: #2b78e4; font-size: 1.09em; padding: 7px 26px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; margin: 0; box-shadow: 0 1px 3px #0001; transition: background 0.13s, color 0.13s;}
    .export-btn:hover, .export-btn:focus { background: #d6eaff; color: #0c51a4;}
    .streak-ring-wrap { margin: 0 auto; margin-top: 2.2em; width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; position: relative; transition: filter 0.3s;}
    .streak-ring-svg { width: 100%; height: 100%; display: block; filter: drop-shadow(var(--ring-shadow)); }
    .streak-center-label { position: absolute; left: 50%; top: 51%; transform: translate(-50%,-50%); width: 110px; text-align: center; color: var(--ring-txt); font-family: 'Ringbearer', 'Inter', serif; font-size: 1.18em; line-height: 1.14; font-weight: 700; text-shadow: 0 0 11px #edb941c5, 0 1px 2px #000c; pointer-events: none;}
    .streak-week-phrase { position: absolute; left: 50%; top: 104%; transform: translate(-50%,0); font-family: 'Ringbearer','Inter',serif; color: #fbe62c; font-size: 1.13em; text-align: center; width: 180px; filter: brightness(1.05) blur(0.1px); text-shadow: 0 0 10px #edb94188, 0 2px 8px #000a; pointer-events: none;}
    .streak-bar-wrap { width: 100%; max-width: 390px; margin: 2.5em auto 0.7em auto; background: #d6eaff; border-radius: 16px; box-shadow: 0 1px 4px #0001; padding: 0.9em 1.5em; font-size: 1.13em; color: #2b78e4; font-weight: 700; letter-spacing: 1px; display: flex; align-items: center; gap: 16px; justify-content: center;}
    .streak-bar-value { background: #2b78e4; color: #fff; border-radius: 12px; padding: 2.5px 16px; margin: 0 8px; font-size: 1em; font-weight: 700; box-shadow: 0 2px 6px #2b78e411;}
    .macro-input-row, .add-meal-row { display: flex; gap: 1.4em; flex-wrap: wrap; justify-content: center; margin-bottom: 1.4em;}
    .macro-input { flex: 1 1 41%; min-width: 110px; max-width: 170px; font-size: 1.17em; padding: 13px 10px; margin: 0 0 12px 0; border-radius: 8px; border: 1.2px solid #b6c6e1; background: #f6faff; color: #1a2a2a; box-shadow: 0 2px 5px #b6d4fa11; outline: none; transition: border 0.15s;}
    .macro-input:focus { border: 1.2px solid #2b78e4; }
    .meal-name-input, .meal-amt-input { font-size: 1.14em; border-radius: 7px; padding: 12px 11px; border: 1.2px solid #c0c9db; outline: none; background: #f7fafc; color: #252525; box-shadow: 0 1px 2px #c7e3fa11; transition: border 0.16s;}
    .meal-name-input:focus, .meal-amt-input:focus { border: 1.2px solid #49a858; }
    .add-meal-btn, .scan-btn {
      background: #2b78e4; color: #fff; border: none; border-radius: 8px; font-weight: 700;
      padding: 12px 25px; font-size: 1.09em; cursor: pointer; margin-left: 4px; box-shadow: 0 2px 6px #0002;
      transition: background 0.16s, color 0.16s;
      display: flex; align-items: center; gap: 0.5em;
    }
    .add-meal-btn:hover, .add-meal-btn:focus,
    .scan-btn:hover, .scan-btn:focus { background: #49a858; color: #fff;}
    .scan-btn { background: #fbe62c; color: #382a00; font-weight: 800; padding: 12px 17px;}
    .scan-btn svg {width:1.4em;height:1.4em;vertical-align:middle;}
    .autocomplete-list {
      position: absolute; top: 110%; left: 0; right: 0; z-index: 40;
      background: #f7fafc; border-radius: 0 0 11px 11px; box-shadow: 0 6px 22px #0002;
      max-height: 220px; overflow-y: auto; font-size: 1.11em;
      color: #262626;
      border: 1.5px solid #e9e3ce;
    }
    .autocomplete-list div {
      padding: 12px 18px; cursor: pointer; transition: background 0.15s;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-list div.selected, .autocomplete-list div:hover {
      background: #eee9ca;
      color: #23200a;
    }
    .autocomplete-no { color: #bbb; font-size: 1.05em; text-align: center; padding: 15px 0;}
    .quote-row {
      font-family: 'Ringbearer', 'Inter', serif;
      color: #7d8682;
      font-size: 1.19em;
      text-align: center;
      margin-top: 2.8em;
      margin-bottom: 0.4em;
      padding: 16px 8px 12px 8px;
      width: 100%;
      line-height: 1.4;
      border-top: 2px solid #e9e3ce;
      border-bottom: 2px solid #e9e3ce;
      box-sizing: border-box;
      background: linear-gradient(90deg,#ece6ca 0%, #fcf6de 100%);
    }
    /* Barcode video overlay */
    #barcodeVideo {
      position: fixed; left:0; top:0; width: 100vw; height: 100vh; object-fit:cover; z-index: 9998; background:#000f;
      display: none;
    }
    #barcodeOverlay {
      position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;pointer-events:none;display:none;
    }
    #barcodeOverlay::after {
      content:''; display:block; position:absolute;left:0;top:0;width:100vw;height:100vh;
      background:radial-gradient(ellipse at center,#fff0 60%,#000c 100%);
      pointer-events:none;
    }
    #barcodeCancelBtn {
      position:fixed;top:15px;right:24px;z-index:10000;background:#fbe62c;color:#382a00;border:none;border-radius:12px;padding:12px 22px;font-size:1.15em;font-weight:800;box-shadow:0 2px 12px #0009;cursor:pointer;
      display:none;
    }
    /* ========== RING MODE TEXTURE ========== */
    .ringmode, .ringmode body {
      background: #221b09 !important;
      color: var(--ring-txt) !important;
      transition: background 0.4s, color 0.3s;
    }
    .ringmode:before, .ringmode body:before {
      content:"";
      position:fixed; z-index:0; top:0; left:0; width:100vw; height:100vh;
      background-image: url('https://i.imgur.com/jU1VQPI.jpg'); /* Seamless parchment */
      background-size: cover;
      background-repeat: repeat;
      background-attachment: fixed;
      opacity: 0.44;
      pointer-events:none;
      filter: blur(0.7px) contrast(1.03) brightness(1.11);
    }
    .ringmode .container {
      background: rgba(43, 36, 10, 0.97) !important;
      color: var(--ring-txt) !important;
      box-shadow: 0 4px 32px #5c4b0a99;
      border: 1.5px solid #a3945e;
      /* Parchment feel overlay */
      background-image: url('https://i.imgur.com/jU1VQPI.jpg');
      background-size: cover;
      background-blend-mode: multiply;
      background-repeat: no-repeat;
      background-position: center top;
    }
    .ringmode .goal-line, .ringmode .meal-log-table th, .ringmode .macro-bar-label {
      background: #2e2208 !important;
      color: #fbe62c !important;
    }
    .ringmode .macro-bar-outer { background: #b49c24 !important; }
    .ringmode .bar-cal { background: linear-gradient(90deg,#fbe62c,#cfa211) !important; color: #5d4b04;}
    .ringmode .bar-p { background: linear-gradient(90deg,#7dc271,#3b7f2d);}
    .ringmode .bar-c { background: linear-gradient(90deg,#5ba4fa,#30426e);}
    .ringmode .bar-f { background: linear-gradient(90deg,#f5a94d,#ad7a1d);}
    .ringmode .macro-bar-label { color: #fff9db !important;}
    .ringmode .streak-bar-wrap { background: #3a3008 !important; color: #fbe62c !important;}
    .ringmode .export-btn { background: #3e3108; color: #fbe62c;}
    .ringmode .theme-btn { background: #fbe62c; color: #3b2e08;}
    .ringmode .theme-btn.active { background: #fff; color: #a28907;}
    .ringmode .meal-log-table th { color: #edb941;}
    .ringmode .meal-log-table { background: #382a00; }
    .ringmode .meal-log-table td { color: #fbe62c;}
    .ringmode .quote-row {
      background: linear-gradient(90deg,#bda06299 0%, #f8f1ca 100%);
      color: #aaaeb8 !important;
      border-top: 2.2px solid #a3945e;
      border-bottom: 2.2px solid #a3945e;
      font-size: 1.23em;
      font-family: 'Ringbearer', 'Inter', serif;
      text-shadow: 0 1px 6px #222a, 0 0px 1.5px #faf3e9;
    }
    /* Responsive! */
    @media (max-width: 680px) {
      .container {
        padding: 1.1em 3.7vw 1.8em 3.7vw;
        margin: 3vw 0 10vw 0;
        max-width: 99vw;
        border-radius: 0 0 22px 22px;
      }
      .theme-toggle {
        position: static;
        justify-content: center;
        margin-top: 0.7em;
        margin-bottom: 0.9em;
        width: 100%;
        gap: 16px;
      }
      h1 {
        padding-top: 0.3em;
        margin-bottom: 0.3em;
        font-size: 1.35rem;
      }
      .tab-row { margin-top: 0.3em; gap: 9px;}
      .quote-row { font-size: 1.02em; padding: 12px 4px 9px 4px;}
      .streak-ring-wrap { width: 39vw; height: 39vw; min-width:110px; min-height:110px; }
      .macro-input-row, .add-meal-row { gap: 0.7em;}
      .meal-log-table th, .meal-log-table td { padding: 6px 5px; }
      #macroChart { height: 120px; }
    }
    @media (max-width: 480px) {
      .container {
        padding: 0.4em 4vw 0.7em 4vw;
        margin: 2vw 0 7vw 0;
      }
      .macro-input-row, .add-meal-row { gap: 0.5em;}
    }
    .toast {
      position: fixed; left: 50%; bottom: 36px; transform: translateX(-50%);
      background: #fffbe0; color: #2b78e4;
      padding: 16px 31px; border-radius: 22px;
      box-shadow: 0 5px 22px #0006; font-size: 1.19em; font-weight: 700;
      opacity: 0.97; z-index: 999; pointer-events: none; animation: fadeToast 2.2s linear;
    }
    @keyframes fadeToast {
      0%{opacity:0;}
      10%{opacity:1;}
      85%{opacity:0.98;}
      100%{opacity:0;}
    }
  </style>
</head>
<body>
  <div class="container" id="macroLegendContainer">
    <h1>MacroLegend</h1>
    <div class="theme-toggle">
      <button class="theme-btn active" id="appleLightBtn" onclick="setTheme('light')">Apple Light</button>
      <button class="theme-btn" id="ringModeBtn" onclick="setTheme('ring')">Ring Mode</button>
    </div>
    <div class="tab-row">
      <button class="tab-btn active" id="tabCalc" onclick="showTab('calc')">Macro Calculator</button>
      <button class="tab-btn" id="tabProg" onclick="showTab('prog')">Macro Progression</button>
    </div>
    <div id="tabArea"></div>
    <div id="quoteRow" class="quote-row"></div>
    <audio id="streakSound" preload="auto">
      <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
    </audio>
    <video id="barcodeVideo" autoplay playsinline></video>
    <div id="barcodeOverlay"></div>
    <button id="barcodeCancelBtn" onclick="stopBarcodeScan()">Cancel Scan</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script>
    // Quotes: 52 LOTR, 52 generic
    const lotrQuotes = [
      "Even the smallest person can change the course of the future.",
      "Not all those who wander are lost.",
      "The road goes ever on and on.",
      "Deeds will not be less valiant because they are unpraised.",
      "Faithless is he that says farewell when the road darkens.",
      "All we have to decide is what to do with the time that is given us.",
      "There’s some good in this world, and it’s worth fighting for.",
      "I am glad you are here with me. Here at the end of all things.",
      "The world is indeed full of peril, and in it there are many dark places.",
      "A wizard is never late, nor is he early, he arrives precisely when he means to.",
      "You shall not pass!",
      "Courage is found in unlikely places.",
      "The shadow is only a passing thing.",
      "Hope remains while the Company is true.",
      "The board is set, the pieces are moving.",
      "One does not simply walk into Mordor.",
      "I would rather share one lifetime with you than face all the ages of this world alone.",
      "May it be a light to you in dark places, when all other lights go out.",
      "It's a dangerous business, going out your door.",
      "The wise speak only of what they know.",
      "Many that live deserve death. And some that die deserve life.",
      "Even darkness must pass. A new day will come.",
      "The strength of the ring-bearer is in his heart.",
      "There’s always hope.",
      "For Frodo.",
      "The journey doesn’t end here.",
      "I am no man!",
      "The Ring has awoken.",
      "Speak, friend, and enter.",
      "There and back again.",
      "Let him not vow to walk in the dark, who has not seen the nightfall.",
      "Renewed shall be blade that was broken.",
      "I will take the Ring, though I do not know the way.",
      "A day may come when the courage of men fails… but it is not this day.",
      "My friends, you bow to no one.",
      "White shores, and beyond, a far green country under a swift sunrise.",
      "You have my sword.",
      "The Shire must truly be a great place.",
      "If by my life or death I can protect you, I will.",
      "End? No, the journey doesn't end here.",
      "Where there's life, there's hope.",
      "It’s the job that’s never started as takes longest to finish.",
      "But in the end, it’s only a passing thing, this shadow.",
      "I can't carry it for you, but I can carry you!",
      "The hands of a king are the hands of a healer.",
      "Shadowfax, show us the meaning of haste.",
      "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
      "Mithrandir, why did you leave us?",
      "You shall be the Fellowship of the Ring.",
      "I will not say: do not weep; for not all tears are an evil.",
      "The fire of your heart outshines the darkness.",
      "May your path be green and the breeze on your back."
    ];
    const genericQuotes = [
      "Every journey begins with a single step.",
      "Consistency is the key to growth.",
      "Small actions every day create big change.",
      "Your only competition is yourself.",
      "Progress over perfection.",
      "Champions are made in the off-season.",
      "Discipline is choosing between what you want now and what you want most.",
      "The best project you’ll ever work on is you.",
      "Little by little, one travels far.",
      "You don't have to be great to start, but you have to start to be great.",
      "Motivation gets you going, but habit keeps you growing.",
      "You miss 100% of the shots you don’t take.",
      "Don't watch the clock; do what it does. Keep going.",
      "Strength grows in the moments you think you can't go on but you keep going anyway.",
      "Great things never come from comfort zones.",
      "You are what you repeatedly do.",
      "Energy and persistence conquer all things.",
      "Believe you can and you're halfway there.",
      "Doubt kills more dreams than failure ever will.",
      "Success is the sum of small efforts repeated day in and day out.",
      "Push yourself, because no one else is going to do it for you.",
      "Don’t limit your challenges, challenge your limits.",
      "Do something today that your future self will thank you for.",
      "Sweat is fat crying.",
      "Your body can stand almost anything. It’s your mind you have to convince.",
      "Nothing will work unless you do.",
      "If it doesn’t challenge you, it doesn’t change you.",
      "Dream big, work hard, stay focused.",
      "It always seems impossible until it's done.",
      "You’re stronger than you think.",
      "The pain you feel today will be the strength you feel tomorrow.",
      "If you’re tired of starting over, stop giving up.",
      "Winners never quit and quitters never win.",
      "Act as if what you do makes a difference. It does.",
      "Action is the foundational key to all success.",
      "Don’t count the days, make the days count.",
      "If you believe it will work out, you’ll see opportunities.",
      "Opportunities don’t happen, you create them.",
      "Work hard in silence. Let success make the noise.",
      "Doubt whom you will, but never yourself.",
      "It’s not about having time. It’s about making time.",
      "The secret to getting ahead is getting started.",
      "Success isn’t always about greatness. It’s about consistency.",
      "A little progress each day adds up to big results.",
      "Well done is better than well said.",
      "If you want it, work for it.",
      "Your future is created by what you do today.",
      "Don’t wish for it, work for it.",
      "Don’t stop until you’re proud.",
      "If not now, when?",
      "Wake up. Kick ass. Repeat.",
      "Be legendary."
    ];

    let macroGoals = {calories: 2000, protein: 150, carbs: 200, fat: 70};
    let macroTotals = {calories: 0, protein: 0, carbs: 0, fat: 0};
    let mealLog = [];
    let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
    try {
      if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
      if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
      if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
    } catch (e) {}

    let chart;
    let scanning = false;
    let foodNames = [];
    let foodCache = {};

    function setTheme(theme) {
      const body = document.body;
      const cont = document.getElementById('macroLegendContainer');
      if (theme === 'ring') {
        body.classList.add('ringmode');
        cont.classList.add('ringmode');
        document.getElementById('appleLightBtn').classList.remove('active');
        document.getElementById('ringModeBtn').classList.add('active');
        document.body.style.background = "radial-gradient(ellipse at center, #fbe62c33 0%, #271e0570 100%)";
      } else {
        body.classList.remove('ringmode');
        cont.classList.remove('ringmode');
        document.getElementById('appleLightBtn').classList.add('active');
        document.getElementById('ringModeBtn').classList.remove('active');
        document.body.style.background = "var(--light-bg)";
      }
      renderAll();
    }
    setTheme('light');

    function showTab(tab) {
      document.getElementById('tabCalc').classList.remove('active');
      document.getElementById('tabProg').classList.remove('active');
      if (tab === 'calc') document.getElementById('tabCalc').classList.add('active');
      else document.getElementById('tabProg').classList.add('active');
      renderTab(tab);
    }

    function renderTab(tab) {
      if (tab === 'calc') renderCalculatorTab();
      else renderProgressionTab();
    }

    function renderCalculatorTab() {
      document.getElementById('tabArea').innerHTML = `
      <form onsubmit="setGoalsFromInputs(event)" class="macro-input-row">
        <input class="macro-input" id="inputWeight" type="number" min="70" placeholder="Weight (lbs)">
        <input class="macro-input" id="inputHeight" type="number" min="48" placeholder="Height (in)">
        <input class="macro-input" id="inputAge" type="number" min="8" max="99" placeholder="Age">
        <select class="macro-input" id="inputGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <select class="macro-input" id="inputActivity">
          <option value="1.2">Sedentary</option>
          <option value="1.375">Light (1-3 days/wk)</option>
          <option value="1.55">Moderate (3-5 days/wk)</option>
          <option value="1.725">Active (6-7 days/wk)</option>
          <option value="1.9">Very Active</option>
        </select>
        <select class="macro-input" id="inputGoal">
          <option value="maintain">Maintain</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
        <button class="add-meal-btn" style="min-width:99px" type="submit">Set Macros</button>
      </form>
      <div style="color:#687; font-size:0.96em;text-align:center; margin-bottom:1.7em">
        Use the calculator to estimate daily calorie/macros.<br>
        <span style="color:#4275ba;font-weight:600;">Your settings transfer to Progression tab instantly.</span>
      </div>
      <div class="macro-input-row" style="gap:1.1em;">
        <input class="macro-input" id="goalCalories" type="number" min="0" placeholder="Goal Calories">
        <input class="macro-input" id="goalProtein" type="number" min="0" placeholder="Goal Protein (g)">
        <input class="macro-input" id="goalCarbs" type="number" min="0" placeholder="Goal Carbs (g)">
        <input class="macro-input" id="goalFat" type="number" min="0" placeholder="Goal Fat (g)">
        <button class="add-meal-btn" style="min-width:97px" onclick="saveGoalInputs()" type="button">Update Goal</button>
      </div>
      `;
      document.getElementById('goalCalories').value = macroGoals.calories;
      document.getElementById('goalProtein').value = macroGoals.protein;
      document.getElementById('goalCarbs').value = macroGoals.carbs;
      document.getElementById('goalFat').value = macroGoals.fat;
    }
    function setGoalsFromInputs(e) {
      e.preventDefault();
      let w = Number(document.getElementById('inputWeight').value);
      let h = Number(document.getElementById('inputHeight').value);
      let a = Number(document.getElementById('inputAge').value);
      let g = document.getElementById('inputGender').value;
      let act = Number(document.getElementById('inputActivity').value);
      let goal = document.getElementById('inputGoal').value;
      if (!w || !h || !a) return showToast("Fill in all fields!");
      let bmr = (g==="male")
        ? 66 + (6.23 * w) + (12.7 * h) - (6.8 * a)
        : 655 + (4.35 * w) + (4.7 * h) - (4.7 * a);
      let tdee = bmr * act;
      let cal = tdee;
      if (goal === "lose") cal -= 500;
      if (goal === "gain") cal += 300;
      macroGoals.calories = Math.round(cal);
      macroGoals.protein = Math.round(w*0.8);
      macroGoals.carbs = Math.round((cal*0.45)/4);
      macroGoals.fat = Math.round((cal*0.25)/9);
      saveData(); renderAll();
      showToast("Goals updated!");
    }
    function saveGoalInputs() {
      macroGoals.calories = Number(document.getElementById('goalCalories').value)||0;
      macroGoals.protein = Number(document.getElementById('goalProtein').value)||0;
      macroGoals.carbs = Number(document.getElementById('goalCarbs').value)||0;
      macroGoals.fat = Number(document.getElementById('goalFat').value)||0;
      saveData(); renderAll();
      showToast("Macros saved!");
    }

    function renderProgressionTab() {
      document.getElementById('tabArea').innerHTML = `
      <div class="goal-line" id="goalLine"></div>
      <div class="macro-bars" id="macroBars"></div>
      <canvas id="macroChart"></canvas>
      <form onsubmit="addMeal(event)" class="add-meal-row" style="position:relative;">
        <div style="flex:2;min-width:180px;position:relative;">
          <input class="meal-name-input" id="mealName" placeholder="Meal name/food" autocomplete="off" required style="width:100%;">
          <div id="foodAutocomplete" class="autocomplete-list" style="display:none"></div>
        </div>
        <input class="meal-amt-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
        <input class="meal-amt-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
        <input class="meal-amt-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
        <input class="meal-amt-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
        <button class="add-meal-btn" type="submit">+ Add</button>
        <button type="button" class="scan-btn" onclick="scanBarcode()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><rect x="16" y="16" width="5" height="5"/><path d="M9 5h6M19 9v6M5 9v6M9 19h6"/></svg>
        </button>
      </form>
      <table class="meal-log-table" id="mealLogTable"></table>
      <div class="export-row">
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="exportTXT()">Export TXT</button>
        <button class="export-btn" onclick="window.print()">Print / PDF</button>
      </div>
      <div id="streakArea"></div>
      `;
      renderGoalLine();
      renderMacroBars();
      renderMealLog();
      renderChart();
      renderStreak();
      setupFoodAutocomplete();
    }
    function renderGoalLine() {
      const {calories, protein, carbs, fat} = macroGoals;
      document.getElementById('goalLine').innerHTML =
        `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
         <span class="goal-macro-p">P: <b>${protein}g</b></span>
         <span class="goal-macro-c">C: <b>${carbs}g</b></span>
         <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
    }
    function renderMacroBars() {
      const {calories, protein, carbs, fat} = macroGoals;
      const t = macroTotals;
      function pct(val, goal) { return Math.min(100, Math.round(100 * val/goal)); }
      document.getElementById('macroBars').innerHTML = `
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories,calories)}%">
            <span class="macro-bar-label">${t.calories}/${calories} kcal</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-p" style="width:${pct(t.protein,protein)}%">
            <span class="macro-bar-label">${t.protein}/${protein}g Protein</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs,carbs)}%">
            <span class="macro-bar-label">${t.carbs}/${carbs}g Carbs</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-f" style="width:${pct(t.fat,fat)}%">
            <span class="macro-bar-label">${t.fat}/${fat}g Fat</span>
          </div>
        </div>
      `;
    }
    function addMeal(e) {
      e.preventDefault();
      const name = document.getElementById('mealName').value.trim();
      const calories = Number(document.getElementById('mealCalories').value);
      const protein = Number(document.getElementById('mealProtein').value) || 0;
      const carbs = Number(document.getElementById('mealCarbs').value) || 0;
      const fat = Number(document.getElementById('mealFat').value) || 0;
      if (!name || !calories) return showToast("Enter meal name and calories!");
      mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
      saveData();
      document.getElementById('mealName').value = '';
      document.getElementById('mealCalories').value = '';
      document.getElementById('mealProtein').value = '';
      document.getElementById('mealCarbs').value = '';
      document.getElementById('mealFat').value = '';
      renderAll();
      checkStreak();
      showToast("Meal added!");
    }
    function renderMealLog() {
      let rows = mealLog.map((m,i) =>
        `<tr>
          <td>${m.name}</td>
          <td>${m.calories}</td>
          <td>${m.protein}</td>
          <td>${m.carbs}</td>
          <td>${m.fat}</td>
          <td><button onclick="removeMeal(${i})" style="color:#e34747;font-weight:700;font-size:1.11em;border:none;background:none;cursor:pointer;">✕</button></td>
        </tr>`
      ).join('');
      document.getElementById('mealLogTable').innerHTML = `
        <thead>
          <tr>
            <th>Meal</th>
            <th>Cal</th>
            <th>P</th>
            <th>C</th>
            <th>F</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }
    function removeMeal(idx) {
      mealLog.splice(idx,1);
      saveData();
      renderAll();
      showToast("Meal removed.");
    }
    function updateTotals() {
      macroTotals = {calories:0,protein:0,carbs:0,fat:0};
      mealLog.forEach(m=>{
        macroTotals.calories += Number(m.calories)||0;
        macroTotals.protein += Number(m.protein)||0;
        macroTotals.carbs += Number(m.carbs)||0;
        macroTotals.fat += Number(m.fat)||0;
      });
    }
    function renderChart() {
      const ctx = document.getElementById('macroChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Calories','Protein','Carbs','Fat'],
          datasets: [
            {
              label: 'Current',
              data: [macroTotals.calories, macroTotals.protein, macroTotals.carbs, macroTotals.fat],
              backgroundColor: [
                'rgba(251,230,44,0.82)',  // Calories: gold
                'rgba(81,193,110,0.85)',  // Protein: green
                'rgba(97,170,255,0.85)',  // Carbs: blue
                'rgba(245,169,77,0.85)'   // Fat: orange
              ],
              borderRadius: 10,
              maxBarThickness: 40,
            },
            {
              label: 'Goal',
              data: [macroGoals.calories, macroGoals.protein, macroGoals.carbs, macroGoals.fat],
              backgroundColor: [
                'rgba(251,230,44,0.19)',
                'rgba(81,193,110,0.18)',
                'rgba(97,170,255,0.18)',
                'rgba(245,169,77,0.17)'
              ],
              borderRadius: 10,
              borderWidth: 0,
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            tooltip: {enabled: true},
          },
          scales: {
            x: { grid: {display: false}, ticks: {color: '#888', font: {weight:700}}},
            y: {
              beginAtZero: true,
              ticks: {color: '#888', font: {weight:700}},
              grid: {color:'#e5ecfa'},
            }
          }
        }
      });
    }

    // ===== Streak logic
    function checkStreak() {
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10);
      if (streak.lastDate !== todayStr) {
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate()-1);
        const ystr = yesterday.toISOString().slice(0,10);
        if (streak.lastDate === ystr) {
          streak.days += 1;
          if (streak.days > streak.best) {
            streak.best = streak.days;
            playStreakSound();
          }
        } else {
          streak.days = 1;
        }
        streak.lastDate = todayStr;
        streak.weekPhrase = ((streak.days-1) % lotrQuotes.length);
        saveData();
        renderStreak();
      }
    }
    function renderStreak() {
      const streakArea = document.getElementById('streakArea');
      const isRing = document.body.classList.contains('ringmode');
      const phrase = isRing
        ? lotrQuotes[streak.weekPhrase % lotrQuotes.length]
        : genericQuotes[streak.weekPhrase % genericQuotes.length];
      if (isRing) {
        streakArea.innerHTML = `
        <div class="streak-ring-wrap">
          <svg class="streak-ring-svg" width="140" height="140" viewBox="0 0 140 140">
            <defs>
              <radialGradient id="gold" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#fff9c9"/>
                <stop offset="65%" stop-color="#edb941"/>
                <stop offset="100%" stop-color="#a28209"/>
              </radialGradient>
            </defs>
            <circle cx="70" cy="70" r="58" fill="url(#gold)" stroke="#d4b117" stroke-width="7"/>
            <text x="70" y="70" text-anchor="middle" fill="#bd8c19" font-family="Ringbearer, serif"
              font-size="13" font-weight="bold" dy="10" letter-spacing="2">
              ${toElvishInscription(streak.days)}
            </text>
          </svg>
          <div class="streak-center-label">
            Streak<br>
            <span style="font-size:1.65em;letter-spacing:2px;">${streak.days}</span>
            <br>Best: <b>${streak.best}</b>
          </div>
          <div class="streak-week-phrase">${phrase}</div>
        </div>
        `;
        document.getElementById('quoteRow').innerHTML = "";
      } else {
        streakArea.innerHTML = `
          <div class="streak-bar-wrap">
            Streak
            <span class="streak-bar-value">${streak.days}</span>
            | Best: <span class="streak-bar-value">${streak.best}</span>
          </div>
        `;
        document.getElementById('quoteRow').innerHTML = `"${phrase}"`;
      }
    }
    function toElvishInscription(num) {
      const roman = ["","I","II","III","IV","V","VI","VII","VIII","IX","X",
        "XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX",
        "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX",
        "XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL",
        "XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L"];
      let romanNum = num < roman.length ? roman[num] : num;
      return "Ash nazg " + romanNum + " burzum-ishi";
    }
    function playStreakSound() {
      if (document.body.classList.contains('ringmode')) {
        try {
          document.getElementById('streakSound').currentTime = 0;
          document.getElementById('streakSound').play();
        } catch (e) {}
      }
    }

    // ========== Food autocomplete (smart, OpenFoodFacts API) ==========
    function setupFoodAutocomplete() {
      const input = document.getElementById('mealName');
      const list = document.getElementById('foodAutocomplete');
      let timer = null, selected = -1, suggestions = [];

      input.oninput = function() {
        clearTimeout(timer);
        list.style.display = "none";
        list.innerHTML = "";
        const val = input.value.trim();
        if (!val || val.length < 3) return;
        timer = setTimeout(() => {
          // Try cache
          if (foodCache[val.toLowerCase()]) {
            showSuggestions(foodCache[val.toLowerCase()]);
            return;
          }
          fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(val)}&search_simple=1&action=process&json=1&page_size=10`)
            .then(r=>r.json())
            .then(res=>{
              const arr = (res.products||[]).map(f=>{
                return {
                  name: f.product_name || f.brands || f.generic_name || "Unknown food",
                  calories: Math.round(f.nutriments['energy-kcal_100g']||0),
                  protein: Math.round(f.nutriments['proteins_100g']||0),
                  carbs: Math.round(f.nutriments['carbohydrates_100g']||0),
                  fat: Math.round(f.nutriments['fat_100g']||0)
                }
              }).filter(f=>f.name && (f.calories||f.protein||f.carbs||f.fat));
              foodCache[val.toLowerCase()] = arr;
              showSuggestions(arr);
            }).catch(()=>{});
        }, 320);
      };
      function showSuggestions(arr) {
        if (!arr.length) {
          list.innerHTML = `<div class="autocomplete-no">No foods found</div>`;
          list.style.display = "block"; return;
        }
        suggestions = arr;
        selected = -1;
        list.innerHTML = arr.map((f,i)=>`
          <div data-idx="${i}">${f.name}
            <span style="float:right; font-size:0.93em; opacity:0.75;">${f.calories||"-"} kcal</span>
          </div>
        `).join('');
        list.style.display = "block";
      }
      list.onmousedown = function(e) {
        const idx = e.target.closest('div[data-idx]')?.dataset.idx;
        if (idx!=null) selectFood(+idx);
      };
      input.onkeydown = function(e) {
        if (!list.style.display || list.style.display === "none") return;
        if (e.key === "ArrowDown") {
          selected = (selected+1) % suggestions.length;
          renderHighlight();
          e.preventDefault();
        } else if (e.key === "ArrowUp") {
          selected = (selected-1+suggestions.length) % suggestions.length;
          renderHighlight();
          e.preventDefault();
        } else if (e.key === "Enter") {
          if (selected>=0) { selectFood(selected); e.preventDefault(); }
        } else if (e.key === "Escape") {
          list.style.display = "none";
        }
      };
      function renderHighlight() {
        [...list.children].forEach((div,i)=>{
          div.classList.toggle('selected', i===selected);
        });
      }
      function selectFood(idx) {
        const food = suggestions[idx];
        input.value = food.name;
        document.getElementById('mealCalories').value = food.calories||"";
        document.getElementById('mealProtein').value = food.protein||"";
        document.getElementById('mealCarbs').value = food.carbs||"";
        document.getElementById('mealFat').value = food.fat||"";
        list.style.display = "none";
      }
      document.addEventListener('mousedown', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          list.style.display = "none";
        }
      });
    }

    // ========== Barcode Scanner ==========
    function scanBarcode() {
      if (scanning) return;
      scanning = true;
      document.getElementById('barcodeVideo').style.display = 'block';
      document.getElementById('barcodeOverlay').style.display = 'block';
      document.getElementById('barcodeCancelBtn').style.display = 'block';
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcodeVideo'),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader", "ean_13_reader","upc_reader","upc_e_reader"] }
      }, function (err) {
        if (err) { showToast('Camera error'); stopBarcodeScan(); return; }
        Quagga.start();
      });
      Quagga.onDetected(barcodeDetected);
    }
    function barcodeDetected(data) {
      stopBarcodeScan();
      let code = data.codeResult.code;
      showToast("Scanned: "+code);
      fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`).then(r=>r.json()).then(info=>{
        if (info.status === 1 && info.product && info.product.nutriments) {
          let n = info.product.nutriments;
          let name = info.product.product_name || info.product.brands || "Barcode Food";
          let cals = Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0);
          let p = Math.round(n['proteins_serving']||n['proteins_100g']||0);
          let car = Math.round(n['carbohydrates_serving']||n['carbohydrates_100g']||0);
          let fat = Math.round(n['fat_serving']||n['fat_100g']||0);
          if (!cals) cals = Math.round((n['energy_100g']||0)/4.184);
          mealLog.push({name,calories:cals,protein:p,carbs:car,fat:fat,date:Date.now()});
          saveData(); renderAll();
          showToast("Added "+name);
        } else {
          showToast("No food info found");
        }
      }).catch(()=>showToast("Scan failed!"));
    }
    function stopBarcodeScan() {
      Quagga.stop();
      document.getElementById('barcodeVideo').style.display = 'none';
      document.getElementById('barcodeOverlay').style.display = 'none';
      document.getElementById('barcodeCancelBtn').style.display = 'none';
      scanning = false;
      Quagga.offDetected(barcodeDetected);
    }

    // ========== Data Storage ========== 
    function saveData() {
      localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
      localStorage.setItem('mealLog', JSON.stringify(mealLog));
      localStorage.setItem('streak', JSON.stringify(streak));
    }

    // ========== Export ========== 
    function exportCSV() {
      let csv = "Meal,Calories,Protein,Carbs,Fat\n";
      mealLog.forEach(m=>{
        csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
      });
      download(csv, "macrolegend.csv");
    }
    function exportTXT() {
      let txt = "MacroLegend Log\n==================\n";
      mealLog.forEach(m=>{
        txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
      });
      download(txt, "macrolegend.txt");
    }
    function download(content, filename) {
      const a = document.createElement('a');
      const file = new Blob([content], {type: 'text/plain'});
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }

    // ========== Toast ========== 
    function showToast(msg) {
      const el = document.createElement('div');
      el.className = 'toast'; el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2100);
    }

    // ========== ALL RENDERS / INIT ==========
    function renderAll() {
      updateTotals();
      if (document.getElementById('tabCalc').classList.contains('active')) renderCalculatorTab();
      else renderProgressionTab();
      // renderStreak(); // handled in tab
      // Update the quote (below streak in light, in ring it's shown in streakArea)
      renderQuoteRow();
    }
    function renderQuoteRow() {
      const isRing = document.body.classList.contains('ringmode');
      const phrase = isRing
        ? ""
        : `"${genericQuotes[streak.weekPhrase % genericQuotes.length]}"`;
      document.getElementById('quoteRow').innerHTML = phrase;
    }

    renderTab('calc');
    document.getElementById('tabCalc').onclick = ()=>showTab('calc');
    document.getElementById('tabProg').onclick = ()=>showTab('prog');
    document.getElementById('appleLightBtn').onclick = ()=>setTheme('light');
    document.getElementById('ringModeBtn').onclick = ()=>setTheme('ring');
    setTimeout(()=>{ renderStreak(); renderQuoteRow(); }, 120);
  </script>
</body>
</html>
