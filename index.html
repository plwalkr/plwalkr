<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MacroLegend</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root {
      --light-bg: #f8f9fa;
      --light-card: #fff;
      --light-text: #1a1a1a;
      --light-accent: #2b78e4;
      --light-bar: #e2ecf8;
      --gold: #fbe62c;
      --ring-bg: #1d1b13;
      --ring-txt: #fbe62c;
      --map-overlay: url('https://img.freepik.com/free-photo/old-parchment-paper-texture-background_118047-11067.jpg?size=2048'); /* Free old map texture */
      --progress-radius: 14px;
      --max-width: 440px;
      --apple-quote: #3b62a7;
    }
    html, body { min-height: 100vh; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0;
      background: var(--light-bg);
      color: var(--light-text);
      display: flex; flex-direction: column; align-items: center;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      background: var(--light-card);
      border-radius: 22px;
      margin: 2vw 0 18vw 0;
      box-shadow: 0 4px 32px #0001;
      max-width: var(--max-width);
      width: 98vw;
      min-width: 0;
      padding: 1.5em 1em 2.5em 1em;
      transition: background 0.3s;
      position: relative;
      z-index: 2;
      overflow: hidden;
    }
    /* Tabs */
    .tabs {
      display: flex;
      gap: 1.2em;
      justify-content: center;
      margin-bottom: 1.3em;
      border-bottom: 2px solid #e2ecf8;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .tab-btn {
      background: none;
      border: none;
      font-weight: 700;
      color: var(--light-accent);
      font-size: 1.08em;
      padding: 0.5em 0.5em 0.85em 0.5em;
      cursor: pointer;
      border-bottom: 2.5px solid transparent;
      transition: color 0.15s, border 0.15s;
      letter-spacing: 1px;
    }
    .tab-btn.active {
      color: #e6b300;
      border-bottom: 2.5px solid #e6b300;
    }
    /* Theme toggle */
    .theme-toggle {
      position: absolute; right: 20px; top: 18px;
      display: flex; gap: 8px;
    }
    .theme-btn {
      background: var(--light-bar);
      border: none;
      border-radius: 16px;
      padding: 4px 12px;
      font-size: 1.03rem;
      color: var(--light-accent);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 7px #0001;
      margin-left: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .theme-btn.active, .theme-btn:focus {
      background: var(--gold);
      color: #3b2e08;
      outline: none;
    }
    h1 {
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 2.13rem;
      letter-spacing: 2px;
      margin-bottom: 0.5em;
      text-align: center;
      color: var(--light-accent);
      transition: color 0.3s;
      text-shadow: 0 2px 12px #edb94122;
    }
    .ringmode h1 {
      color: var(--gold);
      text-shadow: 0 3px 20px #edb941b9;
    }
    /* Inputs/fields */
    .macro-input-row {
      display: flex; gap: 0.6em; flex-wrap: wrap; justify-content: center; margin-bottom: 0.4em;
    }
    .macro-input {
      flex: 1 1 41%; min-width: 95px; max-width: 130px;
      font-size: 1.07em; padding: 7px 6px; margin: 0 0 6px 0;
      border-radius: 8px; border: 1.2px solid #b6c6e1;
      background: #f6faff; color: #1a2a2a;
      box-shadow: 0 2px 5px #b6d4fa11; outline: none;
      transition: border 0.15s;
    }
    .macro-input:focus { border: 1.2px solid #2b78e4; }
    .set-goal-btn {
      background: #2b78e4;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      padding: 8px 20px;
      font-size: 1.09em;
      cursor: pointer;
      margin-top: 1em;
      box-shadow: 0 2px 6px #0002;
      transition: background 0.16s, color 0.16s;
      display: block;
      margin-left: auto; margin-right: auto;
    }
    .set-goal-btn:hover, .set-goal-btn:focus { background: #49a858; color: #fff;}
    /* Goal line */
    .goal-line {
      font-size: 1.08em;
      color: #4c4c4c;
      background: #f8f6e8;
      border-radius: 9px;
      margin: 0 auto 0.8em auto;
      text-align: center;
      padding: 0.25em 0.9em;
      font-weight: 500;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: center;
      gap: 1.2em;
      flex-wrap: wrap;
      max-width: 99vw;
      white-space: nowrap;
    }
    .goal-line span { font-weight: 700; letter-spacing: 0.2px; padding: 0 2px; }
    .goal-macro-p { color: #49a858; }
    .goal-macro-c { color: #3677c6; }
    .goal-macro-f { color: #e8a200; }
    .goal-macro-cal { color: #d4b117; }
    /* Progress bars */
    .macro-bars {
      margin-bottom: 0.7em; margin-top: 0.5em;
      display: flex; flex-direction: column; gap: 0.45em;
    }
    .macro-bar-outer {
      background: var(--light-bar);
      border-radius: var(--progress-radius);
      overflow: hidden; position: relative;
      height: 29px; margin: 0 0.1em;
    }
    .macro-bar-inner {
      height: 100%; display: flex; align-items: center; font-weight: 600;
      font-size: 1em; justify-content: flex-start; padding-left: 11px;
      border-radius: var(--progress-radius);
      transition: width 0.45s cubic-bezier(.35,1.65,.6,1.1);
      color: #fff;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 8px #0004;
      white-space: nowrap; position: relative;
    }
    .bar-cal { background: linear-gradient(90deg,#fbe62c,#f5c80f); color: #735900; }
    .bar-p { background: linear-gradient(90deg,#51c16e,#379956); }
    .bar-c { background: linear-gradient(90deg,#61aaff,#396ebb); }
    .bar-f { background: linear-gradient(90deg,#f5a94d,#d1850b); }
    .macro-bar-label {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
      color: #fff; font-size: 1em; font-weight: 700; text-shadow: 0 1px 4px #0006;
      width: 100%; text-align: center; pointer-events: none; letter-spacing: 0.5px;
    }
    /* Chart area */
    #macroChart {
      width: 100% !important; max-width: 98vw; height: 165px;
      background: #e8f2ff; border-radius: 11px; margin: 0.8em 0 1.4em 0; box-shadow: 0 2px 8px #0002;
    }
    /* Meal log table */
    .meal-log-table {
      width: 100%; margin-bottom: 0.6em; border-collapse: collapse; font-size: 1.04em;
      background: #fff; border-radius: 10px; box-shadow: 0 1px 8px #0001; overflow-x: auto;
    }
    .meal-log-table th, .meal-log-table td {
      padding: 5px 6px; border: none; text-align: center; white-space: nowrap; font-size: 0.99em;
    }
    .meal-log-table th { background: #f2f6fc; color: #5179c2; font-weight: 700;}
    .meal-log-table tbody tr:nth-child(even) { background: #f7faff;}
    /* Export buttons */
    .export-row { display: flex; gap: 0.8em; justify-content: flex-end; margin-bottom: 0.5em;}
    .export-btn {
      background: #e9eef6; color: #2b78e4; font-size: 0.99em; padding: 4px 17px;
      border-radius: 7px; border: none; font-weight: 700; cursor: pointer; margin: 0;
      box-shadow: 0 1px 3px #0001; transition: background 0.13s, color 0.13s;
    }
    .export-btn:hover, .export-btn:focus { background: #d6eaff; color: #0c51a4;}
    /* Toast popup */
    .copy-toast {
      position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
      background: #191e32e7; color: #fff; padding: 11px 26px; border-radius: 19px;
      font-size: 1.09rem; box-shadow: 0 3px 14px #000b; opacity: 0.97; z-index: 99;
      pointer-events: none; animation: fadeToast 2s linear;
    }
    @keyframes fadeToast {
      0%{opacity:0;} 10%{opacity:1;} 90%{opacity:0.98;} 100%{opacity:0;}
    }
    /* 3D RING */
    .streak-ring-wrap {
      margin: 0 auto; margin-top: 2.1em; width: 142px; height: 142px;
      display: flex; align-items: center; justify-content: center; position: relative; transition: filter 0.3s;
    }
    .ring-img {
      width: 138px; height: 138px; display: block;
      border-radius: 50%; box-shadow: 0 0 22px 8px #eac44e55, 0 0 0 7px #fbe62c44;
      background: radial-gradient(ellipse at center, #fffbc4 40%, #eac44e 80%, #6a4f06 100%);
      position: relative;
      z-index: 1;
    }
    .ring-inscription {
      position: absolute;
      left: 50%; top: 49%;
      transform: translate(-50%,-50%);
      font-family: 'Ringbearer', 'Inter', serif;
      color: #bd8c19;
      font-size: 1.27em;
      text-align: center;
      text-shadow: 0 2px 14px #edb941b9, 0 1px 1px #000c;
      width: 100px;
      letter-spacing: 2.2px;
      pointer-events: none;
      z-index: 2;
      user-select: none;
      font-variant: small-caps;
    }
    .streak-center-label {
      position: absolute; left: 50%; top: 49.5%; transform: translate(-50%,-50%);
      width: 85px; text-align: center; color: var(--ring-txt);
      font-family: 'Ringbearer', 'Inter', serif;
      font-size: 1.17em; line-height: 1.16; font-weight: 700;
      text-shadow: 0 0 12px #edb941b9, 0 1px 2px #000c;
      pointer-events: none; z-index: 3;
    }
    .streak-week-phrase {
      font-family: 'Ringbearer','Inter',serif; color: var(--gold); font-size: 1.09em;
      text-align: center; width: 96vw; max-width: 280px; filter: brightness(1.08) blur(0.1px);
      text-shadow: 0 0 10px #edb94199, 0 2px 8px #000a;
      pointer-events: none; margin: 0.95em auto 0.4em auto; display: block;
    }
    /* Minimal streak bar for light mode */
    .streak-bar-wrap {
      width: 100%; max-width: 390px; margin: 1.5em auto 0.3em auto; background: #e9e8d3;
      border-radius: 16px; box-shadow: 0 1px 4px #0001; padding: 0.5em 0.7em;
      font-size: 1.08em; color: #2b78e4; font-weight: 700; letter-spacing: 1px;
      display: flex; align-items: center; gap: 9px; justify-content: center;
    }
    .streak-bar-value {
      background: #2b78e4; color: #fff; border-radius: 12px; padding: 1.5px 10px;
      margin: 0 7px; font-size: 1em; font-weight: 700; box-shadow: 0 2px 6px #2b78e411;
    }
    /* Quotes */
    .quote-bar {
      text-align: center;
      font-family: 'Inter', serif;
      color: var(--apple-quote);
      background: #f5f9fd;
      margin: 1em auto 1em auto;
      padding: 1em 0.7em;
      border-radius: 12px;
      font-size: 1.06em;
      box-shadow: 0 2px 9px #eef1f488;
      width: 98%;
      max-width: 410px;
      line-height: 1.32;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    .ringmode .quote-bar {
      background: #2e2208;
      color: #fbe62c;
      font-family: 'Ringbearer', 'Inter', serif;
      box-shadow: 0 2px 9px #a2890764;
      font-size: 1.07em;
    }
    /* Ringmode overrides */
    .ringmode body, .ringmode {
      background: var(--ring-bg) !important;
      color: var(--ring-txt) !important;
    }
    .ringmode .container {
      background: rgba(34,23,9,0.93);
      color: var(--ring-txt) !important;
      box-shadow: 0 4px 32px #5c4b0a99;
      border: 2.7px solid #eac44e99;
      background-image: var(--map-overlay);
      background-size: cover;
      background-repeat: no-repeat;
      background-blend-mode: multiply;
    }
    /* Responsiveness */
    @media (max-width: 500px) {
      .container { padding: 0.4em 2vw 2em 2vw; border-radius: 0; }
      h1 { font-size: 1.15rem; }
      .tabs { gap: 0.4em; }
      .macro-bar-inner, .macro-bar-label { font-size: 0.97em;}
      #macroChart { height: 110px;}
      .streak-ring-wrap { width: 92vw; height: 92vw; max-width: 154px; max-height: 154px;}
      .streak-center-label { width: 56vw; max-width: 98px; font-size: 0.96em;}
      .streak-week-phrase { font-size: 0.92em; width: 88vw; max-width: 153px;}
      .macro-input-row, .add-meal-row { flex-direction: column; gap: 0.3em;}
      .meal-log-table th, .meal-log-table td { font-size: 0.98em; padding: 4px 2px;}
      .export-row { flex-wrap: wrap; gap: 0.6em; }
      .goal-line { gap: 0.4em; font-size: 0.99em;}
    }
  </style>
</head>
<body>
  <div class="container" id="macroLegendContainer">
    <div class="theme-toggle">
      <button class="theme-btn" id="appleLightBtn" onclick="setTheme('light')">Apple Light</button>
      <button class="theme-btn" id="ringModeBtn" onclick="setTheme('ring')">Ring Mode</button>
    </div>
    <h1>MacroLegend</h1>
    <div class="tabs">
      <button class="tab-btn active" id="tabCalc" onclick="switchTab('calc')">Macro Calculator</button>
      <button class="tab-btn" id="tabProg" onclick="switchTab('progress')">Progression</button>
    </div>
    <div id="calcTab">
      <div class="macro-input-row">
        <input class="macro-input" id="goalCalories" type="number" min="0" placeholder="Goal Calories">
        <input class="macro-input" id="goalProtein" type="number" min="0" placeholder="Goal Protein (g)">
        <input class="macro-input" id="goalCarbs" type="number" min="0" placeholder="Goal Carbs (g)">
        <input class="macro-input" id="goalFat" type="number" min="0" placeholder="Goal Fat (g)">
      </div>
      <button class="set-goal-btn" onclick="setGoalsFromInputs()">Set Goal</button>
    </div>
    <div id="progressTab" style="display:none;">
      <div class="goal-line" id="goalLine"></div>
      <div class="macro-bars" id="macroBars"></div>
      <canvas id="macroChart"></canvas>
      <form onsubmit="addMeal(event)" class="add-meal-row">
        <input class="meal-name-input" id="mealName" placeholder="Meal name/food" autocomplete="off" required>
        <input class="meal-amt-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
        <input class="meal-amt-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
        <input class="meal-amt-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
        <input class="meal-amt-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
        <button class="add-meal-btn" type="submit">+ Add</button>
      </form>
      <table class="meal-log-table" id="mealLogTable"></table>
      <div class="export-row">
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="exportTXT()">Export TXT</button>
        <button class="export-btn" onclick="window.print()">Print / PDF</button>
      </div>
      <div id="streakArea"></div>
      <div class="quote-bar" id="quoteBar"></div>
    </div>
  </div>
  <!-- Sound for streak in Ring Mode -->
  <audio id="streakSound" preload="auto">
    <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
  </audio>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // === Quotes (Light and LOTR) ===
    const appleQuotes = [
      "The journey of a thousand miles begins with one step.",
      "Your only limit is your mind.",
      "Don’t stop when you’re tired. Stop when you’re done.",
      "Every accomplishment starts with the decision to try.",
      "Success is the sum of small efforts, repeated day in and day out.",
      "You don’t have to be great to start, but you have to start to be great.",
      "If you get tired, learn to rest, not to quit.",
      "Don’t wish for it. Work for it.",
      "Be stronger than your excuses.",
      "The secret of getting ahead is getting started.",
      "It never gets easier, you just get stronger.",
      "Great things never came from comfort zones.",
      "The best time to plant a tree was 20 years ago. The second best time is now.",
      "Consistency is more important than perfection.",
      "Make each day your masterpiece.",
      "Every meal is a fresh chance to hit your goals.",
      "Small steps every day add up to big results.",
      "One day or day one. You decide.",
      "What you do today can improve all your tomorrows.",
      "Today is another chance to get better.",
      "Discipline is the bridge between goals and accomplishment.",
      "Push yourself, because no one else is going to do it for you.",
      "Believe you can and you’re halfway there.",
      "You are your only limit.",
      "It always seems impossible until it’s done.",
      "Do something today that your future self will thank you for.",
      "The harder you work for something, the greater you’ll feel when you achieve it.",
      "Your body can stand almost anything. It’s your mind that you have to convince.",
      "Dream it. Believe it. Build it.",
      "A little progress each day adds up to big results.",
      "One bite at a time, one meal at a time.",
      "Don’t watch the clock. Do what it does. Keep going.",
      "Stay positive. Work hard. Make it happen.",
      "Energy and persistence conquer all things.",
      "You didn’t come this far to only come this far.",
      "Progress, not perfection.",
      "Make yourself proud.",
      "Wake up with determination. Go to bed with satisfaction.",
      "Motivation is what gets you started. Habit is what keeps you going.",
      "You’re capable of amazing things.",
      "If you want something you’ve never had, you must be willing to do something you’ve never done.",
      "Action is the foundational key to all success.",
      "The best view comes after the hardest climb.",
      "Just keep moving forward.",
      "Your habits define your results.",
      "Everything you need is already inside you.",
      "Rise up and attack the day with enthusiasm.",
      "Start where you are. Use what you have. Do what you can.",
      "Good things come to those who sweat.",
      "Stay focused and never give up.",
      "Well begun is half done.",
    ];
    const lotrQuotes = [
      "Even the smallest person can change the course of the future.",
      "Not all those who wander are lost.",
      "The road goes ever on and on.",
      "Deeds will not be less valiant because they are unpraised.",
      "Faithless is he that says farewell when the road darkens.",
      "All we have to decide is what to do with the time that is given us.",
      "There’s some good in this world, and it’s worth fighting for.",
      "I am glad you are here with me. Here at the end of all things.",
      "The world is indeed full of peril, and in it there are many dark places.",
      "A wizard is never late, nor is he early, he arrives precisely when he means to.",
      "You shall not pass!",
      "Courage is found in unlikely places.",
      "The shadow is only a passing thing.",
      "Hope remains while the Company is true.",
      "The board is set, the pieces are moving.",
      "One does not simply walk into Mordor.",
      "I would rather share one lifetime with you than face all the ages of this world alone.",
      "May it be a light to you in dark places, when all other lights go out.",
      "It's a dangerous business, going out your door.",
      "The wise speak only of what they know.",
      "Many that live deserve death. And some that die deserve life.",
      "Even darkness must pass. A new day will come.",
      "The strength of the ring-bearer is in his heart.",
      "There’s always hope.",
      "For Frodo.",
      "The journey doesn’t end here.",
      "I am no man!",
      "The Ring has awoken.",
      "Speak, friend, and enter.",
      "There and back again.",
      "Let him not vow to walk in the dark, who has not seen the nightfall.",
      "Renewed shall be blade that was broken.",
      "I will take the Ring, though I do not know the way.",
      "A day may come when the courage of men fails… but it is not this day.",
      "My friends, you bow to no one.",
      "White shores, and beyond, a far green country under a swift sunrise.",
      "You have my sword.",
      "The Shire must truly be a great place.",
      "If by my life or death I can protect you, I will.",
      "End? No, the journey doesn't end here.",
      "Where there's life, there's hope.",
      "It’s the job that’s never started as takes longest to finish.",
      "But in the end, it’s only a passing thing, this shadow.",
      "I can't carry it for you, but I can carry you!",
      "The hands of a king are the hands of a healer.",
      "Shadowfax, show us the meaning of haste.",
      "There is no curse in Elvish, Entish, or the tongues of Men for this treachery.",
      "Mithrandir, why did you leave us?",
      "You shall be the Fellowship of the Ring.",
      "I will not say: do not weep; for not all tears are an evil.",
      "The fire of your heart outshines the darkness.",
      "May your path be green and the breeze on your back.",
      "Streaks are for heroes. Today you are legend.",
      "Let the courage of the Eldar guide you.",
    ];
    // Macro state
    let macroGoals = { calories: 2000, protein: 150, carbs: 200, fat: 70 };
    let macroTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
    let mealLog = [];
    let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
    // Load from localStorage
    try {
      if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
      if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
      if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
    } catch (e) {}

    let chart;
    let currentTab = 'calc';

    // Theme switching
    function setTheme(theme) {
      const body = document.body;
      const cont = document.getElementById('macroLegendContainer');
      if (theme === 'ring') {
        body.classList.add('ringmode'); cont.classList.add('ringmode');
        document.getElementById('appleLightBtn').classList.remove('active');
        document.getElementById('ringModeBtn').classList.add('active');
        document.body.style.background = "radial-gradient(ellipse at center, #fbe62c33 0%, #271e0570 100%)";
      } else {
        body.classList.remove('ringmode'); cont.classList.remove('ringmode');
        document.getElementById('appleLightBtn').classList.add('active');
        document.getElementById('ringModeBtn').classList.remove('active');
        document.body.style.background = "var(--light-bg)";
      }
      renderQuoteBar();
      renderStreak();
    }
    setTheme('light');

    function switchTab(tab) {
      document.getElementById('calcTab').style.display = (tab === 'calc') ? '' : 'none';
      document.getElementById('progressTab').style.display = (tab === 'progress') ? '' : 'none';
      document.getElementById('tabCalc').classList.toggle('active', tab === 'calc');
      document.getElementById('tabProg').classList.toggle('active', tab === 'progress');
      currentTab = tab;
      if(tab==='progress') renderAll();
    }

    // Macro Goal Inputs
    function setGoalsFromInputs() {
      macroGoals.calories = Number(document.getElementById('goalCalories').value)||0;
      macroGoals.protein = Number(document.getElementById('goalProtein').value)||0;
      macroGoals.carbs = Number(document.getElementById('goalCarbs').value)||0;
      macroGoals.fat = Number(document.getElementById('goalFat').value)||0;
      saveData();
      renderAll();
      switchTab('progress');
      showCopyToast("Goals updated!");
    }
    function setupGoalInputs() {
      document.getElementById('goalCalories').value = macroGoals.calories;
      document.getElementById('goalProtein').value = macroGoals.protein;
      document.getElementById('goalCarbs').value = macroGoals.carbs;
      document.getElementById('goalFat').value = macroGoals.fat;
    }

    // Progress Bars
    function renderGoalLine() {
      const {calories, protein, carbs, fat} = macroGoals;
      document.getElementById('goalLine').innerHTML =
        `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
         <span class="goal-macro-p">P: <b>${protein}g</b></span>
         <span class="goal-macro-c">C: <b>${carbs}g</b></span>
         <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
    }
    function renderMacroBars() {
      const {calories, protein, carbs, fat} = macroGoals;
      const t = macroTotals;
      function pct(val, goal) { return Math.min(100, Math.round(100 * val/goal)); }
      document.getElementById('macroBars').innerHTML = `
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories,calories)}%">
            <span class="macro-bar-label">${t.calories}/${calories} kcal</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-p" style="width:${pct(t.protein,protein)}%">
            <span class="macro-bar-label">${t.protein}/${protein}g Protein</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs,carbs)}%">
            <span class="macro-bar-label">${t.carbs}/${carbs}g Carbs</span>
          </div>
        </div>
        <div class="macro-bar-outer">
          <div class="macro-bar-inner bar-f" style="width:${pct(t.fat,fat)}%">
            <span class="macro-bar-label">${t.fat}/${fat}g Fat</span>
          </div>
        </div>
      `;
    }

    // Meal Log
    function addMeal(e) {
      e.preventDefault();
      const name = document.getElementById('mealName').value.trim();
      const calories = Number(document.getElementById('mealCalories').value);
      const protein = Number(document.getElementById('mealProtein').value) || 0;
      const carbs = Number(document.getElementById('mealCarbs').value) || 0;
      const fat = Number(document.getElementById('mealFat').value) || 0;
      if (!name || !calories) return;
      mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
      saveData();
      document.getElementById('mealName').value = '';
      document.getElementById('mealCalories').value = '';
      document.getElementById('mealProtein').value = '';
      document.getElementById('mealCarbs').value = '';
      document.getElementById('mealFat').value = '';
      renderAll();
      checkStreak();
    }
    function renderMealLog() {
      let rows = mealLog.map((m,i) =>
        `<tr>
          <td>${m.name}</td>
          <td>${m.calories}</td>
          <td>${m.protein}</td>
          <td>${m.carbs}</td>
          <td>${m.fat}</td>
          <td><button onclick="removeMeal(${i})" style="color:#e34747;font-weight:700;font-size:0.93em;border:none;background:none;cursor:pointer;">✕</button></td>
        </tr>`
      ).join('');
      document.getElementById('mealLogTable').innerHTML = `
        <thead>
          <tr>
            <th>Meal</th>
            <th>Cal</th>
            <th>P</th>
            <th>C</th>
            <th>F</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }
    function removeMeal(idx) {
      mealLog.splice(idx,1);
      saveData();
      renderAll();
    }

    function updateTotals() {
      macroTotals = {calories:0,protein:0,carbs:0,fat:0};
      mealLog.forEach(m=>{
        macroTotals.calories += Number(m.calories)||0;
        macroTotals.protein += Number(m.protein)||0;
        macroTotals.carbs += Number(m.carbs)||0;
        macroTotals.fat += Number(m.fat)||0;
      });
    }

    // Export
    function exportCSV() {
      let csv = "Meal,Calories,Protein,Carbs,Fat\n";
      mealLog.forEach(m=>{
        csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
      });
      download(csv, "macrolegend.csv");
    }
    function exportTXT() {
      let txt = "MacroLegend Log\n==================\n";
      mealLog.forEach(m=>{
        txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
      });
      download(txt, "macrolegend.txt");
    }
    function download(content, filename) {
      const a = document.createElement('a');
      const file = new Blob([content], {type: 'text/plain'});
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
      showCopyToast("File downloaded!");
    }

    // Chart
    function renderChart() {
      const ctx = document.getElementById('macroChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Calories','Protein','Carbs','Fat'],
          datasets: [
            {
              label: 'Current',
              data: [macroTotals.calories, macroTotals.protein, macroTotals.carbs, macroTotals.fat],
              backgroundColor: [
                'rgba(251,230,44,0.82)',  // Calories: gold
                'rgba(81,193,110,0.85)',  // Protein: green
                'rgba(97,170,255,0.85)',  // Carbs: blue
                'rgba(245,169,77,0.85)'   // Fat: orange
              ],
              borderRadius: 10,
              maxBarThickness: 40,
              yAxisID: 'A'
            },
            {
              label: 'Goal',
              data: [macroGoals.calories, macroGoals.protein, macroGoals.carbs, macroGoals.fat],
              backgroundColor: [
                'rgba(251,230,44,0.19)',
                'rgba(81,193,110,0.18)',
                'rgba(97,170,255,0.18)',
                'rgba(245,169,77,0.17)'
              ],
              borderRadius: 10,
              borderWidth: 0,
              yAxisID: 'A'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            tooltip: {enabled: true},
          },
          scales: {
            x: {
              grid: {display: false},
              ticks: {color: '#888', font: {weight:700}}
            },
            A: {
              beginAtZero: true,
              ticks: {color: '#888', font: {weight:700}},
              grid: {color:'#e5ecfa'},
            },
          }
        }
      });
    }

    // Quotes
    function renderQuoteBar() {
      const quoteBar = document.getElementById('quoteBar');
      const isRing = document.body.classList.contains('ringmode');
      const q = isRing ? lotrQuotes[streak.weekPhrase % lotrQuotes.length]
                       : appleQuotes[streak.weekPhrase % appleQuotes.length];
      quoteBar.innerText = `"${q}"`;
    }

    // Streak (Ring or Bar)
    function renderStreak() {
      const streakArea = document.getElementById('streakArea');
      const isRing = document.body.classList.contains('ringmode');
      if (isRing) {
        streakArea.innerHTML = `
          <div class="streak-ring-wrap">
            <div class="ring-img"></div>
            <div class="ring-inscription">${toBlackSpeechRing(streak.days)}</div>
            <div class="streak-center-label">
              Streak<br>
              <span style="font-size:1.57em;letter-spacing:2px;">${streak.days}</span>
              <br>Best: <b>${streak.best}</b>
            </div>
          </div>
          <div class="streak-week-phrase">${lotrQuotes[streak.weekPhrase % lotrQuotes.length]}</div>
        `;
      } else {
        streakArea.innerHTML = `
          <div class="streak-bar-wrap">
            Streak
            <span class="streak-bar-value">${streak.days}</span>
            | Best: <span class="streak-bar-value">${streak.best}</span>
          </div>
        `;
      }
    }
    // Black Speech: “One Ring to rule them all...” + Roman numeral streak
    function toBlackSpeechRing(num) {
      // Just a little fun. Real inscription is too long for the ring size.
      const roman = ["","I","II","III","IV","V","VI","VII","VIII","IX","X",
        "XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX",
        "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX",
        "XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL",
        "XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L"];
      let romanNum = num < roman.length ? roman[num] : num;
      return `Ash nazg ${romanNum} krimpatul`;
    }
    function playStreakSound() {
      if (document.body.classList.contains('ringmode')) {
        try {
          document.getElementById('streakSound').currentTime = 0;
          document.getElementById('streakSound').play();
        } catch (e) {}
      }
    }
    // Streak system
    function checkStreak() {
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10);
      if (streak.lastDate !== todayStr) {
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate()-1);
        const ystr = yesterday.toISOString().slice(0,10);
        if (streak.lastDate === ystr) {
          streak.days += 1;
          if (streak.days > streak.best) {
            streak.best = streak.days;
            playStreakSound();
          }
        } else {
          streak.days = 1;
        }
        streak.lastDate = todayStr;
        streak.weekPhrase = ((streak.days-1) % lotrQuotes.length);
        saveData();
        renderStreak();
      }
    }
    function saveData() {
      localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
      localStorage.setItem('mealLog', JSON.stringify(mealLog));
      localStorage.setItem('streak', JSON.stringify(streak));
    }
    // All renders
    function renderAll() {
      updateTotals();
      renderGoalLine();
      renderMacroBars();
      renderMealLog();
      renderChart();
      renderStreak();
      renderQuoteBar();
      setupGoalInputs();
    }
    // Toast popup
    function showCopyToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(),2000);
    }
    // Barcode scanner stub (pop toast for now, demo only)
    function scanBarcode() {
      showCopyToast("Barcode scan coming soon! For now, imagine you're at the Prancing Pony.");
    }
    // INIT
    renderAll();
    // Handle theme
    document.getElementById('appleLightBtn').onclick = ()=>setTheme('light');
    document.getElementById('ringModeBtn').onclick = ()=>setTheme('ring');
    // Init tab
    switchTab('calc');
  </script>
</body>
</html>
