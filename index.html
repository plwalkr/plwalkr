<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MacroLegend</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
<link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
<style>
/* === (PASTE ALL YOUR CODE #1's STYLES HERE, OR USE THE ONES YOU LIKE BEST) === */
:root {
  --light-bg: #f6f6fa;
  --light-card: #fff;
  --light-text: #1a1a1a;
  --light-accent: #2b78e4;
  --light-bar: #d6eaff;
  --light-shadow: 0 4px 32px #0002;
  --gold: #fbe62c;
  --ring-shadow: 0 0 18px 6px #edb94144;
  --ring-bar: #f8c944;
  --ring-green: #7dc271;
  --ring-blue: #5ba4fa;
  --ring-orange: #f5a94d;
  --ring-bg: #2a2009;
  --ring-card: #382a00;
  --ring-txt: #fbe62c;
  --ring-inscription: #bd8c19;
  --chart-bar: #2b78e4;
  --chart-bg: #e5ecfa;
  --progress-radius: 13px;
  --shadow-color: rgba(0,0,0,0.13);
}
/* (KEEP ALL THE REST OF YOUR #1's CSS EXACTLY AS IS) */
/* ... (TRUNCATED TO SAVE SPACE HERE. USE YOUR PREFERRED #1's CSS) ... */
</style>
</head>
<body>
<div id="macroLegendContainer" class="container">
  <div class="theme-toggle">
    <button class="theme-btn active" id="appleLightBtn">Apple Light</button>
    <button class="theme-btn" id="ringModeBtn">Ring Mode</button>
  </div>
  <h1>MacroLegend</h1>
  <div class="tabs tab-row">
    <button class="tab-btn active" id="tabCalc">Macro Calculator</button>
    <button class="tab-btn" id="tabProg">Progression</button>
  </div>
  <div id="tabArea"></div>
  <audio id="streakSound" preload="auto">
    <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b01f3be.mp3" type="audio/mp3">
  </audio>
  <video id="barcodeVideo" autoplay playsinline style="display:none"></video>
  <div id="barcodeOverlay" style="display:none"></div>
  <button id="barcodeCancelBtn" onclick="stopBarcodeScan()" style="display:none">Cancel Scan</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
<script>
/* ======= LOTR Quotes ======= */
const streakPhrases = [
  "Even the smallest person can change the course of the future.",
  "Not all those who wander are lost.",
  "The road goes ever on and on.",
  // ... (add the rest of your favorite phrases from above)
  "Let the courage of the Eldar guide you."
];

// ===== STATE =====
let macroGoals = {calories: 2000, protein: 150, carbs: 200, fat: 70};
let macroTotals = {calories: 0, protein: 0, carbs: 0, fat: 0};
let mealLog = [];
let streak = { days: 1, best: 1, lastDate: null, weekPhrase: 0 };
try {
  if (localStorage.getItem('macroGoals')) macroGoals = JSON.parse(localStorage.getItem('macroGoals'));
  if (localStorage.getItem('mealLog')) mealLog = JSON.parse(localStorage.getItem('mealLog'));
  if (localStorage.getItem('streak')) streak = JSON.parse(localStorage.getItem('streak'));
} catch (e) {}
let chart;

// ===== THEME HANDLER =====
function setTheme(theme) {
  const body = document.body;
  const cont = document.getElementById('macroLegendContainer');
  if (theme === 'ring') {
    body.classList.add('ringmode');
    cont.classList.add('ringmode');
    document.getElementById('appleLightBtn').classList.remove('active');
    document.getElementById('ringModeBtn').classList.add('active');
    renderStreak();
  } else {
    body.classList.remove('ringmode');
    cont.classList.remove('ringmode');
    document.getElementById('appleLightBtn').classList.add('active');
    document.getElementById('ringModeBtn').classList.remove('active');
    renderStreak();
  }
}
document.getElementById('appleLightBtn').onclick = ()=>setTheme('light');
document.getElementById('ringModeBtn').onclick = ()=>setTheme('ring');
setTheme('light');

// ===== TABS =====
function showTab(tab) {
  document.getElementById('tabCalc').classList.toggle('active', tab === 'calc');
  document.getElementById('tabProg').classList.toggle('active', tab === 'prog');
  renderTab(tab);
}
document.getElementById('tabCalc').onclick = ()=>showTab('calc');
document.getElementById('tabProg').onclick = ()=>showTab('prog');

// ==== MAIN TABBED AREAS ====
function renderTab(tab) {
  if (tab === 'calc') renderCalculatorTab();
  else renderProgressionTab();
}

// ==== MACRO CALCULATOR TAB ====
function renderCalculatorTab() {
  document.getElementById('tabArea').innerHTML = `
    <form onsubmit="setGoalsFromInputs(event)" class="macro-input-row-calc">
      <input class="macro-input-calc" id="inputWeight" type="number" min="70" placeholder="Weight (lbs)">
      <input class="macro-input-calc" id="inputHeight" type="number" min="48" placeholder="Height (in)">
      <input class="macro-input-calc" id="inputAge" type="number" min="8" max="99" placeholder="Age">
      <select class="macro-input-calc" id="inputGender">
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
      <select class="macro-input-calc" id="inputActivity">
        <option value="1.2">Sedentary</option>
        <option value="1.375">Light (1-3 days/wk)</option>
        <option value="1.55">Moderate (3-5 days/wk)</option>
        <option value="1.725">Active (6-7 days/wk)</option>
        <option value="1.9">Very Active</option>
      </select>
      <select class="macro-input-calc" id="inputGoal">
        <option value="maintain">Maintain</option>
        <option value="lose">Lose Weight</option>
        <option value="gain">Gain Weight</option>
      </select>
      <button class="export-btn" style="min-width:99px" type="submit">Set Macros</button>
    </form>
    <div style="color:#687; font-size:0.96em;text-align:center; margin-bottom:1.2em">
      Use the calculator to estimate daily calorie/macros.  
      <br><span style="color:#4275ba;font-weight:600;">Your settings transfer to Progression tab instantly.</span>
    </div>
    <div class="macro-input-row-calc" style="gap:0.3em;">
      <input class="macro-input-calc" id="goalCalories" type="number" min="0" placeholder="Goal Calories">
      <input class="macro-input-calc" id="goalProtein" type="number" min="0" placeholder="Goal Protein (g)">
      <input class="macro-input-calc" id="goalCarbs" type="number" min="0" placeholder="Goal Carbs (g)">
      <input class="macro-input-calc" id="goalFat" type="number" min="0" placeholder="Goal Fat (g)">
      <button class="export-btn" style="min-width:97px" onclick="saveGoalInputs()" type="button">Update Goal</button>
    </div>
  `;
  document.getElementById('goalCalories').value = macroGoals.calories;
  document.getElementById('goalProtein').value = macroGoals.protein;
  document.getElementById('goalCarbs').value = macroGoals.carbs;
  document.getElementById('goalFat').value = macroGoals.fat;
}
window.setGoalsFromInputs = function(e) {
  e.preventDefault();
  let w = Number(document.getElementById('inputWeight').value);
  let h = Number(document.getElementById('inputHeight').value);
  let a = Number(document.getElementById('inputAge').value);
  let g = document.getElementById('inputGender').value;
  let act = Number(document.getElementById('inputActivity').value);
  let goal = document.getElementById('inputGoal').value;
  if (!w || !h || !a) return showToast("Fill in all fields!");
  let bmr = (g==="male")
    ? 66 + (6.23 * w) + (12.7 * h) - (6.8 * a)
    : 655 + (4.35 * w) + (4.7 * h) - (4.7 * a);
  let tdee = bmr * act;
  let cal = tdee;
  if (goal === "lose") cal -= 500;
  if (goal === "gain") cal += 300;
  macroGoals.calories = Math.round(cal);
  macroGoals.protein = Math.round(w*0.8);
  macroGoals.carbs = Math.round((cal*0.45)/4);
  macroGoals.fat = Math.round((cal*0.25)/9);
  saveData(); renderAll();
  showToast("Goals updated!");
}
window.saveGoalInputs = function() {
  macroGoals.calories = Number(document.getElementById('goalCalories').value)||0;
  macroGoals.protein = Number(document.getElementById('goalProtein').value)||0;
  macroGoals.carbs = Number(document.getElementById('goalCarbs').value)||0;
  macroGoals.fat = Number(document.getElementById('goalFat').value)||0;
  saveData(); renderAll();
  showToast("Macros saved!");
}

// ==== PROGRESSION TAB ====
function renderProgressionTab() {
  document.getElementById('tabArea').innerHTML = `
    <div class="goal-line" id="goalLine"></div>
    <div class="macro-bars" id="macroBars"></div>
    <canvas id="macroChart"></canvas>
    <form onsubmit="addMeal(event)" class="add-meal-row">
      <input class="meal-name-input macro-input" id="mealName" placeholder="Meal name/food" autocomplete="off" required>
      <input class="meal-amt-input macro-input" id="mealCalories" type="number" min="0" placeholder="Calories" required>
      <input class="meal-amt-input macro-input" id="mealProtein" type="number" min="0" placeholder="Protein (g)">
      <input class="meal-amt-input macro-input" id="mealCarbs" type="number" min="0" placeholder="Carbs (g)">
      <input class="meal-amt-input macro-input" id="mealFat" type="number" min="0" placeholder="Fat (g)">
      <button class="export-btn add-meal-btn" type="submit">+ Add</button>
      <button type="button" class="export-btn scan-btn" onclick="scanBarcode()" style="background:#fbe62c;color:#382a00;">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="width:1.5em;height:1.5em;vertical-align:middle;"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><rect x="16" y="16" width="5" height="5"/><path d="M9 5h6M19 9v6M5 9v6M9 19h6"/></svg>
      </button>
    </form>
    <table class="meal-log-table" id="mealLogTable"></table>
    <div class="export-row">
      <button class="export-btn" onclick="exportCSV()">Export CSV</button>
      <button class="export-btn" onclick="exportTXT()">Export TXT</button>
      <button class="export-btn" onclick="window.print()">Print / PDF</button>
    </div>
    <div id="streakArea"></div>
  `;
  renderGoalLine();
  renderMacroBars();
  renderMealLog();
  renderChart();
  renderStreak();
}
window.addMeal = function(e) {
  e.preventDefault();
  const name = document.getElementById('mealName').value.trim();
  const calories = Number(document.getElementById('mealCalories').value);
  const protein = Number(document.getElementById('mealProtein').value) || 0;
  const carbs = Number(document.getElementById('mealCarbs').value) || 0;
  const fat = Number(document.getElementById('mealFat').value) || 0;
  if (!name || !calories) return showToast("Enter meal name and calories!");
  mealLog.push({name,calories,protein,carbs,fat,date:Date.now()});
  saveData();
  document.getElementById('mealName').value = '';
  document.getElementById('mealCalories').value = '';
  document.getElementById('mealProtein').value = '';
  document.getElementById('mealCarbs').value = '';
  document.getElementById('mealFat').value = '';
  renderAll();
  checkStreak();
  showToast("Meal added!");
}
window.removeMeal = function(idx) {
  mealLog.splice(idx,1);
  saveData();
  renderAll();
  showToast("Meal removed.");
}

// ==== MACRO GOALS ====
function renderGoalLine() {
  const {calories, protein, carbs, fat} = macroGoals;
  document.getElementById('goalLine').innerHTML =
    `<span class="goal-macro-cal">Calories: <b>${calories}</b></span>
     <span class="goal-macro-p">P: <b>${protein}g</b></span>
     <span class="goal-macro-c">C: <b>${carbs}g</b></span>
     <span class="goal-macro-f">F: <b>${fat}g</b></span>`;
}
function renderMacroBars() {
  const {calories, protein, carbs, fat} = macroGoals;
  const t = macroTotals;
  function pct(val, goal) { return Math.min(100, Math.round(100 * val/goal)); }
  document.getElementById('macroBars').innerHTML = `
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-cal" style="width:${pct(t.calories,calories)}%">
        <span class="macro-bar-label">${t.calories}/${calories} kcal</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-p" style="width:${pct(t.protein,protein)}%">
        <span class="macro-bar-label">${t.protein}/${protein}g Protein</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-c" style="width:${pct(t.carbs,carbs)}%">
        <span class="macro-bar-label">${t.carbs}/${carbs}g Carbs</span>
      </div>
    </div>
    <div class="macro-bar-outer">
      <div class="macro-bar-inner bar-f" style="width:${pct(t.fat,fat)}%">
        <span class="macro-bar-label">${t.fat}/${fat}g Fat</span>
      </div>
    </div>
  `;
}
function renderMealLog() {
  let rows = mealLog.map((m,i) =>
    `<tr>
      <td>${m.name}</td>
      <td>${m.calories}</td>
      <td>${m.protein}</td>
      <td>${m.carbs}</td>
      <td>${m.fat}</td>
      <td><button onclick="removeMeal(${i})" style="color:#e34747;font-weight:700;font-size:0.93em;border:none;background:none;cursor:pointer;">✕</button></td>
    </tr>`
  ).join('');
  document.getElementById('mealLogTable').innerHTML = `
    <thead>
      <tr>
        <th>Meal</th>
        <th>Cal</th>
        <th>P</th>
        <th>C</th>
        <th>F</th>
        <th></th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  `;
}

// ==== MACRO TOTALS ====
function updateTotals() {
  macroTotals = {calories:0,protein:0,carbs:0,fat:0};
  mealLog.forEach(m=>{
    macroTotals.calories += Number(m.calories)||0;
    macroTotals.protein += Number(m.protein)||0;
    macroTotals.carbs += Number(m.carbs)||0;
    macroTotals.fat += Number(m.fat)||0;
  });
}

// ==== CHART ====
function renderChart() {
  const ctx = document.getElementById('macroChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Calories','Protein','Carbs','Fat'],
      datasets: [
        {
          label: 'Current',
          data: [macroTotals.calories, macroTotals.protein, macroTotals.carbs, macroTotals.fat],
          backgroundColor: [
            'rgba(251,230,44,0.82)',
            'rgba(81,193,110,0.85)',
            'rgba(97,170,255,0.85)',
            'rgba(245,169,77,0.85)'
          ],
          borderRadius: 10,
          maxBarThickness: 40,
        },
        {
          label: 'Goal',
          data: [macroGoals.calories, macroGoals.protein, macroGoals.carbs, macroGoals.fat],
          backgroundColor: [
            'rgba(251,230,44,0.19)',
            'rgba(81,193,110,0.18)',
            'rgba(97,170,255,0.18)',
            'rgba(245,169,77,0.17)'
          ],
          borderRadius: 10,
          borderWidth: 0,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {display: false},
        tooltip: {enabled: true},
      },
      scales: {
        x: { grid: {display: false}, ticks: {color: '#888', font: {weight:700}}},
        y: {
          beginAtZero: true,
          ticks: {color: '#888', font: {weight:700}},
          grid: {color:'#e5ecfa'},
        }
      }
    }
  });
}

// ==== STREAK / LOTR =====
function checkStreak() {
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  if (streak.lastDate !== todayStr) {
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate()-1);
    const ystr = yesterday.toISOString().slice(0,10);
    if (streak.lastDate === ystr) {
      streak.days += 1;
      if (streak.days > streak.best) {
        streak.best = streak.days;
        playStreakSound();
      }
    } else {
      streak.days = 1;
    }
    streak.lastDate = todayStr;
    streak.weekPhrase = ((streak.days-1) % streakPhrases.length);
    saveData();
    renderStreak();
  }
}
function renderStreak() {
  const streakArea = document.getElementById('streakArea');
  const isRing = document.body.classList.contains('ringmode');
  const phrase = streakPhrases[streak.weekPhrase % streakPhrases.length];
  if (isRing) {
    streakArea.innerHTML = `
    <div class="streak-ring-wrap">
      <svg class="streak-ring-svg" width="140" height="140" viewBox="0 0 140 140">
        <defs>
          <radialGradient id="gold" cx="70" cy="70" r="70" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#fff9c9"/>
            <stop offset="65%" stop-color="#edb941"/>
            <stop offset="100%" stop-color="#a28209"/>
          </radialGradient>
        </defs>
        <circle cx="70" cy="70" r="58" fill="url(#gold)" stroke="#d4b117" stroke-width="7"/>
        <text x="70" y="70" text-anchor="middle" fill="#bd8c19" font-family="Ringbearer, serif"
          font-size="13" font-weight="bold" dy="10" letter-spacing="2">
          ${toElvishInscription(streak.days)}
        </text>
      </svg>
      <div class="streak-center-label">
        Streak<br>
        <span style="font-size:1.65em;letter-spacing:2px;">${streak.days}</span>
        <br>Best: <b>${streak.best}</b>
      </div>
      <div class="streak-week-phrase">${phrase}</div>
    </div>
    `;
  } else {
    streakArea.innerHTML = `
      <div class="streak-bar-wrap">
        Streak
        <span class="streak-bar-value">${streak.days}</span>
        | Best: <span class="streak-bar-value">${streak.best}</span>
      </div>
      <div style="text-align:center;color:#567;font-size:1.01em;font-weight:400;margin:0.7em 0 1em 0;">"${phrase}"</div>
    `;
  }
}
function toElvishInscription(num) {
  const roman = ["","I","II","III","IV","V","VI","VII","VIII","IX","X",
    "XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX",
    "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX",
    "XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL",
    "XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L"];
  let romanNum = num < roman.length ? roman[num] : num;
  return "Ash nazg " + romanNum + " burzum-ishi";
}
function playStreakSound() {
  if (document.body.classList.contains('ringmode')) {
    try {
      document.getElementById('streakSound').currentTime = 0;
      document.getElementById('streakSound').play();
    } catch (e) {}
  }
}

// ==== DATA STORAGE / EXPORT ====
function saveData() {
  localStorage.setItem('macroGoals', JSON.stringify(macroGoals));
  localStorage.setItem('mealLog', JSON.stringify(mealLog));
  localStorage.setItem('streak', JSON.stringify(streak));
}
function exportCSV() {
  let csv = "Meal,Calories,Protein,Carbs,Fat\n";
  mealLog.forEach(m=>{
    csv+=`${m.name},${m.calories},${m.protein},${m.carbs},${m.fat}\n`;
  });
  download(csv, "macrolegend.csv");
}
function exportTXT() {
  let txt = "MacroLegend Log\n==================\n";
  mealLog.forEach(m=>{
    txt+=`${m.name.padEnd(16)} | Cal: ${m.calories} P: ${m.protein} C: ${m.carbs} F: ${m.fat}\n`;
  });
  download(txt, "macrolegend.txt");
}
function download(content, filename) {
  const a = document.createElement('a');
  const file = new Blob([content], {type: 'text/plain'});
  a.href = URL.createObjectURL(file);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}
function showToast(msg) {
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 2100);
}

// ==== BARCODE ====
let scanning = false;
function scanBarcode() {
  if (scanning) return;
  scanning = true;
  document.getElementById('barcodeVideo').style.display = 'block';
  document.getElementById('barcodeOverlay').style.display = 'block';
  document.getElementById('barcodeCancelBtn').style.display = 'block';
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#barcodeVideo'),
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["ean_reader", "ean_13_reader","upc_reader","upc_e_reader"] }
  }, function (err) {
    if (err) { showToast('Camera error'); stopBarcodeScan(); return; }
    Quagga.start();
  });
  Quagga.onDetected(barcodeDetected);
}
function barcodeDetected(data) {
  stopBarcodeScan();
  let code = data.codeResult.code;
  showToast("Scanned: "+code);
  fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`).then(r=>r.json()).then(info=>{
    if (info.status === 1 && info.product && info.product.nutriments) {
      let n = info.product.nutriments;
      let name = info.product.product_name || info.product.brands || "Barcode Food";
      let cals = Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0);
      let p = Math.round(n['proteins_serving']||n['proteins_100g']||0);
      let car = Math.round(n['carbohydrates_serving']||n['carbohydrates_100g']||0);
      let fat = Math.round(n['fat_serving']||n['fat_100g']||0);
      if (!cals) cals = Math.round((n['energy_100g']||0)/4.184);
      mealLog.push({name,calories:cals,protein:p,carbs:car,fat:fat,date:Date.now()});
      saveData(); renderAll();
      showToast("Added "+name);
    } else {
      showToast("No food info found");
    }
  }).catch(()=>showToast("Scan failed!"));
}
function stopBarcodeScan() {
  Quagga.stop();
  document.getElementById('barcodeVideo').style.display = 'none';
  document.getElementById('barcodeOverlay').style.display = 'none';
  document.getElementById('barcodeCancelBtn').style.display = 'none';
  scanning = false;
  Quagga.offDetected(barcodeDetected);
}

// ==== MAIN RENDER ====
function renderAll() {
  updateTotals();
  if (document.getElementById('tabCalc').classList.contains('active')) renderCalculatorTab();
  else renderProgressionTab();
}

// ==== INIT ====
renderTab('calc');
setTimeout(()=>{ renderStreak(); }, 80);

</script>
</body>
</html>
